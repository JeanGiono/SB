<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>影響空軍修護人員離職因素之研究 問卷</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* --- 一般畫面樣式 --- */
        .rating-table th, .rating-table td {
            width: 5rem;
            height: 5rem;
            padding: 0.25rem;
            text-align: center;
            vertical-align: middle;
            box-sizing: border-box;
            border: 1px solid #D1D5DB;
        }
        .rating-table th.top-left-header-cell {
            width: 5rem;
            height: 5rem;
            box-sizing: border-box;
            background-color: #E0F2FE; /* sky-100 */
            position: sticky;
            left: 0;
            top: 0;
            z-index: 30;
            font-size: 0.75rem; /* text-xs */
            line-height: 1.2;
            padding: 0.2rem;
            word-break: break-all;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .rating-table th.aspect-label {
            font-size: 0.8rem; /* 略大於 text-xs */
            line-height: 1.2;
            word-break: break-all;
            hyphens: auto;
        }
        .rating-table th.aspect-label.sticky-row {
            width: 5rem;
            height: 5rem;
            box-sizing: border-box;
            padding: 0.25rem;
            background-color: #E0F2FE; /* sky-100 */
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .rating-table th.aspect-label.sticky-col {
            background-color: #F9FAFB; /* gray-50 */
            position: sticky;
            left: 0;
            z-index: 10;
        }
        .rating-table td input[type="number"] {
            width: 3.5rem;
            height: 3.5rem;
            text-align: center;
            border-radius: 0.25rem; /* rounded */
            border: 1px solid #9CA3AF; /* gray-400 */
            padding: 0.2rem;
            appearance: textfield;
            -moz-appearance: textfield;
            font-size: 1rem; /* text-base */
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .rating-table td.diagonal-cell {
            background-color: #4B5563; /* gray-700 */
        }
        .highlight-error {
            outline: 2px solid red !important;
            border-radius: 4px;
            box-shadow: 0 0 8px rgba(255,0,0,0.7);
            transition: outline 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
        }

        /* --- 列印專用樣式 --- */
        @media print {
            body {
                font-family: 'Noto Sans TC', sans-serif !important; /* 確保繁中字體 */
                margin: 10mm !important; /* 適度調整列印邊界 */
                color: #000 !important;
                background-color: #fff !important;
                -webkit-print-color-adjust: exact !important; /* 嘗試保留必要的背景色 */
                print-color-adjust: exact !important;
            }

            header, footer {
                text-align: left !important;
                margin-bottom: 0.8em !important;
            }
            header h1 { font-size: 16pt !important; color: #000 !important; }
            header p { font-size: 9pt !important; color: #000 !important; margin-top: 0.5em !important;}
            header .text-xs { font-size: 8pt !important; color: #333 !important; margin-top: 0.3em !important; }
            footer p { font-size: 8pt !important; color: #333 !important; margin-top: 1em !important;}

            /* 隱藏不需要列印的元素 */
            form button[type="submit"],
            form button[type="reset"],
            #definitionsSection, /* 隱藏構面定義說明 */
            .bg-sky-50.p-3.rounded-md.mb-4 /* 隱藏填寫指標說明區塊 */ {
                display: none !important;
            }
             p.text-xs.text-red-600 { /* 調整提示文字大小 */
                font-size: 7pt !important;
                color: #555 !important; /* 列印時不要太刺眼的紅色 */
                margin-bottom: 0.5em !important;
            }


            /* 問卷主容器 */
            .max-w-6xl {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                border: none !important;
                background-color: #fff !important;
            }
            #questionnaireContainerToPrint {
                 padding: 0 !important;
                 box-shadow: none !important;
                 border: none !important;
            }

            /* 評分表格的容器 */
            .overflow-auto[style*="max-height"] {
                max-height: none !important;
                overflow: visible !important;
                border: none !important;
            }

            .rating-table {
                width: 100% !important;
                border-collapse: collapse !important;
                table-layout: fixed;
                margin-bottom: 1em;
            }

            .rating-table th, .rating-table td {
                font-size: 6pt !important; /* 大幅縮小字體以容納15x15表格 */
                padding: 1.5px 1.5px !important; /* 最小化內邊距 */
                border: 1px solid #777 !important; /* 清晰的細邊框 */
                text-align: center !important;
                vertical-align: middle !important;
                word-break: break-all !important;
                height: auto !important; /* 自動高度 */
                line-height: 1.1 !important;
            }

            .rating-table th.top-left-header-cell {
                background-color: #ddd !important;
                font-weight: bold;
                position: static !important;
                font-size: 5pt !important;
                display: table-cell !important;
                vertical-align: middle !important;
            }

            .rating-table th.aspect-label {
                font-weight: normal;
            }
            .rating-table th.aspect-label br { display: block; margin-bottom: -3px; line-height: 1; }


            .rating-table th.aspect-label.sticky-row,
            .rating-table th.aspect-label.sticky-col {
                background-color: #eee !important;
                position: static !important; /* 列印時移除 sticky */
            }

            .rating-table td input[type="number"] {
                width: 95% !important; /* 輸入框寬度盡量填滿 */
                height: 1.7em !important;
                font-size: inherit !important;
                border: 1px solid #999 !important;
                padding: 1px !important;
                -moz-appearance: textfield !important;
                appearance: textfield !important;
                text-align: center !important;
                border-radius: 0 !important;
                background-color: #fff !important;
                color: #000 !important;
                box-sizing: border-box;
                display: block; /* 確保在 td 中正確渲染 */
                margin: auto; /* 水平居中 */
            }
            input[type=number]::-webkit-inner-spin-button,
            input[type=number]::-webkit-outer-spin-button {
                -webkit-appearance: none !important;
                margin: 0 !important;
            }

            .rating-table td.diagonal-cell {
                background-color: #bbb !important;
            }

            /* 個人基本資料區塊 */
            #personalInfoContainer h2, #ratingSection h2 {
                font-size: 12pt !important;
                color: #000 !important;
                margin-top: 1em !important;
                margin-bottom: 0.5em !important;
                border-bottom: 1px solid #ccc !important;
                padding-bottom: 0.2em !important;
            }
            #ratingSection h2 { margin-top: 0.5em !important; } /* 評分表格的標題可以更靠上 */


            #personalInfoContainer .grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
                gap: 0.3rem !important;
            }
            #personalInfoContainer > div > div { /* 包裹選項的容器 */
                margin-bottom: 0.3em;
            }

            #personalInfoContainer div,
            #personalInfoContainer label,
            #personalInfoContainer input[type="radio"] + label {
                font-size: 8.5pt !important;
                color: #000 !important;
                margin-bottom: 0.15em !important;
                line-height: 1.2 !important;
            }
            #personalInfoContainer label.block { margin-bottom: 0.2em !important; font-weight: bold; }

            #personalInfoContainer input[type="radio"] {
                 width: 0.9em;
                 height: 0.9em;
                 vertical-align: middle;
            }
            input[type="radio"]:checked::before {
                content: "◉";
                font-size: 1.1em;
                color: black;
                display: inline-block;
                width: 1em;
                text-align: center;
                position: relative;
                left: -1.3em;
                top: -0.12em;
            }
             input[type="radio"] {
                opacity: 1 !important;
            }
            #retired_options_container label,
            #retired_options_container input[type="radio"] + label {
                font-size: 7.5pt !important;
            }

            .highlight-error { /* 移除列印時的錯誤提示 */
                outline: none !important;
                box-shadow: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-6xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-xl" id="questionnaireContainerToPrint">
        <header class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-sky-700">影響空軍修護人員離職因素之研究 問卷</h1>
            <p class="mt-3 text-sm text-gray-600 max-w-2xl mx-auto">
                這是一份純學術之問卷研究，本問卷所有資料僅作為研究之目的，絕對保密，請您依實際感受最直接的反應填寫此份問卷，誠摯感謝您熱心的協助！
            </p>
            <div class="mt-3 text-xs text-gray-500">
                <p>國立臺北大學 企業管理研究所</p>
                <p>指導教授：劉仲矩 老師</p>
                <p>研究生：張靖興 學生</p>
            </div>
        </header>

        <form id="questionnaireForm">
            <section class="mb-10" id="ratingSection">
                <h2 class="text-xl font-semibold text-sky-600 border-b-2 border-sky-200 pb-2 mb-4">壹、十五項構面影響關係之評比</h2>
                <div class="bg-sky-50 p-3 rounded-md mb-4 text-sm">
                    <p class="text-gray-700 mb-1"><strong>填寫指標說明：</strong> 請填入 0 至 4 的數字。</p>
                    <ul class="list-disc list-inside ml-4 text-gray-600">
                        <li>0：無影響</li>
                        <li>1：低影響</li>
                        <li>2：中影響</li>
                        <li>3：高影響</li>
                        <li>4：極高影響</li>
                    </ul>
                </div>
                <p class="text-xs text-red-600 mb-1">※ 請特別注意，構面間互相影響並不一定相等。</p>
                <p class="text-xs text-red-600 mb-4">※ 填答時請注意：此表格右上方與左下方之答案不一定對稱。</p>

                <div class="overflow-auto rounded-lg border border-gray-300" style="max-height: 600px;">
                    <table class="min-w-full border-collapse rating-table">
                        <thead>
                            <tr>
                                <th class="top-left-header-cell">
                                    影響<br>來源<br>因素<br>(欄)<br>↓<br>受影響<br>因素<br>(列)<br>→
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="mb-10" id="definitionsSection">
                <h2 class="text-xl font-semibold text-sky-600 border-b-2 border-sky-200 pb-2 mb-4">貳、各構面意義說明</h2>
                <ol id="definitionsContainer" class="list-decimal list-inside space-y-3 text-sm text-gray-700">
                </ol>
            </section>

            <section class="mb-10" id="personalInfoContainer">
                <h2 class="text-xl font-semibold text-sky-600 border-b-2 border-sky-200 pb-2 mb-4">肆、個人基本資料</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 text-sm">
                    <div id="genderSection">
                        <label class="block font-medium text-gray-700 mb-1">1. 性別：</label>
                        <div class="flex items-center space-x-4">
                            <div>
                                <input type="radio" id="gender_male" name="gender" value="生理男" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500 rounded-full">
                                <label for="gender_male" class="ml-2 text-gray-700">生理男</label>
                            </div>
                            <div>
                                <input type="radio" id="gender_female" name="gender" value="生理女" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500 rounded-full">
                                <label for="gender_female" class="ml-2 text-gray-700">生理女</label>
                            </div>
                        </div>
                    </div>
                    <div id="yearServiceSection">
                        <label class="block font-medium text-gray-700 mb-1">2. 年資：</label>
                        <div id="yearsServiceContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                    </div>
                    <div id="educationLevelSection">
                        <label class="block font-medium text-gray-700 mb-1">3. 教育程度：</label>
                        <div id="educationLevelContainer" class="space-y-1"></div>
                    </div>
                    <div id="rankSection">
                        <label class="block font-medium text-gray-700 mb-1">4. 階級：</label>
                        <div id="rankContainer" class="space-y-1"></div>
                    </div>
                    <div id="jobTypeSection">
                        <label class="block font-medium text-gray-700 mb-1">5. 職務類型：</label>
                        <div class="flex items-center space-x-4">
                           <div>
                                <input type="radio" id="job_leader" name="job_type" value="領導職" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500 rounded-full">
                                <label for="job_leader" class="ml-2 text-gray-700">領導職</label>
                            </div>
                            <div>
                                <input type="radio" id="job_non_leader" name="job_type" value="非領導職" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500 rounded-full">
                                <label for="job_non_leader" class="ml-2 text-gray-700">非領導職</label>
                            </div>
                        </div>
                    </div>
                    <div id="militaryServiceSection">
                        <label class="block font-medium text-gray-700 mb-1">6. 兵役情況：</label>
                        <div class="space-y-1">
                            <div>
                                <input type="radio" id="service_current" name="military_service_status" value="現役" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500 rounded-full">
                                <label for="service_current" class="ml-2 text-gray-700">現役</label>
                            </div>
                            <div>
                                <input type="radio" id="service_retired" name="military_service_status" value="已退役" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500 rounded-full">
                                <label for="service_retired" class="ml-2 text-gray-700">已退役</label>
                                <div id="retired_options_container" class="ml-6 mt-2 space-y-1 hidden">
                                    <div>
                                        <input type="radio" id="retired_full_term" name="retired_status" value="服滿役期" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500 rounded-full">
                                        <label for="retired_full_term" class="ml-2 text-xs text-gray-600">服滿役期</label>
                                    </div>
                                    <div>
                                        <input type="radio" id="retired_not_full_term" name="retired_status" value="未服滿役期" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500 rounded-full">
                                        <label for="retired_not_full_term" class="ml-2 text-xs text-gray-600">未服滿役期</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div class="mt-10 text-center space-x-4">
                <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
                    提交問卷 (寄送郵件)
                </button>
                <button type="reset" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                    清除重填
                </button>
            </div>
        </form>

        <footer class="mt-12 text-center text-sm text-gray-500">
            <p>此份問卷到此結束，感謝您在百忙之中撥冗填答，衷心感謝您對本研究之支持！</p>
        </footer>
    </div>

    <script>
        const aspects = [
            "勞役不均", "任務壓力", "職業傷害", "薪資待遇", "成就實現",
            "職涯發展", "社會認同", "期望落差", "權威壓迫", "同袍互動",
            "人力匱乏", "輕視專業", "家庭照顧", "就業市場", "政策疑慮"
        ];
        const aspectDefinitions = [
            "工作任務分配不合理，常以低階優先，導致部分人員承擔過多工作。", "工作時間過長、工作量過多或工作內容過於繁重導致身心疲憊。", "飛機修護環境噪音過大，或需長時間承受大量廢氣或化學溶劑。", "薪資待遇沒辦法確實反應在高工時或高壓工作環境。", "從工作中獲得的自我價值感與滿足感不足，缺乏對個人能力與貢獻的肯定。", "軍職專長與民間產業難以銜接，需提早退伍提升職涯競爭力。", "自覺社會大眾對軍人職業認同感低，進而影響自豪感並降低留營意願。", "部隊工作內容與個人預期想像落差過大。", "單位存在不健康的權力關係，高階濫用職權使部屬感到壓迫及不尊重。", "同袍間價值觀、個性、工作行為相左在溝通協作上產生困難或衝突。", "人員離退後單位職缺人力長時間未能補充，增加工時負荷。", "修護人員與飛行人員意見相左時，修護人員的意見往往難以被採納。", "工作佔據私人時間過多對家庭照護不足無法充分陪伴家人。", "民間企業提供更具吸引力的職涯發展機會工作選擇更加多元。", "國家退撫、薪資政策變動頻繁，使得軍人對於未來權益保障產生不確定感與擔憂。"
        ];
        const personalInfoOptions = {
            year_service: ["0-5年", "5-10年", "10-15年", "15-20年", "20-25年(含以上)"],
            education_level: ["高中", "專科", "大學", "研究所(含以上)"],
            rank_options: ["士兵", "士官", "軍官"]
        };

        document.addEventListener('DOMContentLoaded', function() {
            const questionnaireForm = document.getElementById('questionnaireForm');
            const tableHeadRow = questionnaireForm.querySelector('.rating-table thead tr');
            const tableBody = questionnaireForm.querySelector('.rating-table tbody');
            const definitionsList = questionnaireForm.querySelector('#definitionsContainer');
            const topLeftHeaderCell = questionnaireForm.querySelector('.top-left-header-cell');

            if (topLeftHeaderCell) {
                 // 更新左上角標題的文字，確保換行符號 <br> 被正確解析
                topLeftHeaderCell.innerHTML = '影響<br>來源<br>因素<br>(欄)<br>↓<br>受影響<br>因素<br>(列)<br>→';
            }


            if (tableHeadRow) {
                aspects.forEach(aspect => {
                    const th = document.createElement('th');
                    th.className = "aspect-label sticky-row";
                    if (aspect.length === 4 && !aspect.includes('<br>')) { // 避免重複處理已包含<br>的標籤
                        th.innerHTML = aspect.substring(0,2) + '<br>' + aspect.substring(2,4);
                    } else {
                        th.textContent = aspect;
                    }
                    tableHeadRow.appendChild(th);
                });
            }

            if (tableBody) {
                aspects.forEach((rowAspect, rowIndex) => {
                    const tr = document.createElement('tr');
                    const thRowHeader = document.createElement('th');
                    thRowHeader.className = "aspect-label sticky-col";
                    if (rowAspect.length === 4 && !rowAspect.includes('<br>')) {
                        thRowHeader.innerHTML = rowAspect.substring(0,2) + '<br>' + rowAspect.substring(2,4);
                    } else {
                        thRowHeader.textContent = rowAspect;
                    }
                    tr.appendChild(thRowHeader);

                    aspects.forEach((colAspect, colIndex) => {
                        const td = document.createElement('td');
                        if (rowIndex === colIndex) {
                            td.classList.add('diagonal-cell');
                        } else {
                            const input = document.createElement('input');
                            input.type = "number";
                            input.name = `rating_${rowIndex}_${colIndex}`;
                            input.min = "0"; // HTML5 原生驗證
                            input.max = "4"; // HTML5 原生驗證
                            input.pattern = "[0-4]"; // HTML5 原生驗證 (單一數字)
                            input.addEventListener('input', function() {
                                // 確保輸入為0-4的單一數字
                                const value = this.value;
                                if (value === "") return;

                                const num = parseInt(value, 10);
                                if (isNaN(num) || num < 0 || num > 4 || value.length > 1 || !/^[0-9]$/.test(value)) {
                                    // 雖然有原生驗證，但 alert 仍然可以作為額外提醒
                                    // alert("提醒：評比數字需介於 0 到 4 之間，且為單一數字！");
                                    this.value = ""; // 清除非法輸入
                                }
                            });
                            td.appendChild(input);
                        }
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });
            }

            if (definitionsList) {
                aspectDefinitions.forEach((definition, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${aspects[index]}：</strong>${definition}`; // 將構面名稱也加入
                    definitionsList.appendChild(li);
                });
            }

            function setupRadioGroup(containerId, optionsArray, groupName, gridColsClass = 'sm:grid-cols-3') {
                const container = questionnaireForm.querySelector(`#${containerId}`);
                if (!container) { console.error(`容器 ID '${containerId}' 未找到`); return; }
                container.innerHTML = ''; // 清空舊內容
                container.className = `grid grid-cols-2 ${gridColsClass} gap-2`; // 更新 class 以應用 grid

                optionsArray.forEach((opt, index) => {
                    const div = document.createElement('div'); // 每個選項一個 div
                    const inputId = `${groupName}_${index}`;
                    div.innerHTML = `
                        <input type="radio" id="${inputId}" name="${groupName}" value="${opt}" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500 rounded-full" required>
                        <label for="${inputId}" class="ml-2 text-gray-700">${opt}</label>
                    `;
                    container.appendChild(div);
                });
            }
            // 年資選項使用預設的 sm:grid-cols-3
            setupRadioGroup('yearsServiceContainer', personalInfoOptions.year_service, 'year_service');
            // 教育程度和階級使用單欄顯示，因此調整 gridColsClass
            setupRadioGroup('educationLevelContainer', personalInfoOptions.education_level, 'education_level', 'grid-cols-1');
            setupRadioGroup('rankContainer', personalInfoOptions.rank_options, 'rank', 'grid-cols-1');


            const serviceCurrentRadio = questionnaireForm.querySelector('#service_current');
            const serviceRetiredRadio = questionnaireForm.querySelector('#service_retired');
            const retiredOptionsDiv = questionnaireForm.querySelector('#retired_options_container');
            const retiredStatusRadios = questionnaireForm.querySelectorAll('input[name="retired_status"]');
            // 將個人基本資料的 radio button 也設為 required
            questionnaireForm.querySelectorAll('#genderSection input[type="radio"], #jobTypeSection input[type="radio"], #militaryServiceSection > div > div > input[type="radio"]').forEach(radio => {
                radio.required = true;
            });


            if(serviceCurrentRadio && serviceRetiredRadio && retiredOptionsDiv) {
                serviceCurrentRadio.addEventListener('change', function() {
                    if (this.checked) {
                        retiredOptionsDiv.classList.add('hidden');
                        retiredStatusRadios.forEach(radio => {
                            radio.checked = false;
                            radio.required = false; // 非必填
                        });
                    }
                });
                serviceRetiredRadio.addEventListener('change', function() {
                    if (this.checked) {
                        retiredOptionsDiv.classList.remove('hidden');
                        retiredStatusRadios.forEach(radio => {
                            radio.required = true; // 設為必填
                        });
                    }
                });
            }

            function validateAndFocusFirstError() {
                const personalInfoSections = [
                    { name: 'gender', sectionId: 'genderSection', label: '性別'},
                    { name: 'year_service', sectionId: 'yearServiceSection', label: '年資' },
                    { name: 'education_level', sectionId: 'educationLevelSection', label: '教育程度' },
                    { name: 'rank', sectionId: 'rankSection', label: '階級' },
                    { name: 'job_type', sectionId: 'jobTypeSection', label: '職務類型' },
                    { name: 'military_service_status', sectionId: 'militaryServiceSection', label: '兵役情況' }
                ];

                // 檢查評分表格是否有至少一個填寫 (可選)
                let ratingFilled = false;
                const ratingInputs = questionnaireForm.querySelectorAll('.rating-table input[type="number"]');
                for (const input of ratingInputs) {
                    if (input.value.trim() !== "") {
                        ratingFilled = true;
                        break;
                    }
                }
                // if (!ratingFilled) {
                //     alert("提醒：「十五項構面影響關係之評比」尚未填寫任何內容。若無需填寫此部分，可直接提交。");
                //     // 可以選擇是否要強制填寫，目前設定為可選
                // }


                for (const section of personalInfoSections) {
                    // 使用 querySelectorAll 檢查 radio 是否有被選中
                    const selectedRadio = questionnaireForm.querySelector(`input[name="${section.name}"]:checked`);
                    const sectionElement = questionnaireForm.querySelector(`#${section.sectionId}`);

                    if (!selectedRadio) {
                        if (sectionElement) {
                            sectionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            sectionElement.classList.add('highlight-error');
                            setTimeout(() => sectionElement.classList.remove('highlight-error'), 3000);
                        }
                        alert(`提醒：「${section.label}」尚未填寫，請檢查後再提交。`);
                        return false;
                    }

                    if (section.name === 'military_service_status' && selectedRadio.value === '已退役') {
                        const retiredStatusSelected = questionnaireForm.querySelector('input[name="retired_status"]:checked');
                        if (!retiredStatusSelected) {
                            const retiredContainer = questionnaireForm.querySelector('#retired_options_container');
                             if (retiredContainer) {
                                retiredContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                retiredContainer.classList.add('highlight-error');
                                setTimeout(() => retiredContainer.classList.remove('highlight-error'), 3000);
                            }
                            alert('提醒：「兵役情況」選擇「已退役」後，請填寫役期狀況。');
                            return false;
                        }
                    }
                }
                return true;
            }

            if (questionnaireForm) {
                questionnaireForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    console.log("「提交問卷 (寄送郵件)」按鈕被點擊，開始驗證...");

                    if (!validateAndFocusFirstError()) {
                        console.log("驗證未通過，不執行後續操作。");
                        return;
                    }

                    console.log("驗證通過。");

                    alert('問卷驗證通過。\n\n即將準備列印問卷填答內容。\n在接下來的列印預覽視窗中，您可以：\n  - 選擇印表機 (或另存為PDF)\n  - 調整紙張大小 (建議A4)\n  - 設定版面為「橫向 Landscape」以容納較寬的表格\n  - 調整「縮放 Scale」比例 (例如：設為「符合頁面大小」或自訂百分比，如70%-90%)\n\n列印完成或取消列印後，才會繼續進行郵件寄送步驟。');

                    // 觸發列印
                    window.print();

                    // 列印完成後 (無論成功或取消)，繼續組裝郵件內容
                    // 為了確保郵件寄送邏輯在列印對話框關閉後執行，可以使用 setTimeout 稍微延遲
                    // 但實際上 window.print() 是同步阻塞的，所以理論上不需要 setTimeout。
                    // 不過，為了以防萬一某些瀏覽器行為不一致，可以保留一個極短的延遲。
                    setTimeout(() => {
                        console.log("列印流程已觸發/結束，準備組裝郵件內容。");
                        let mailBody = "「影響空軍修護人員離職因素之研究」問卷填答結果：\n\n";
                        mailBody += "==========================================\n";
                        mailBody += "壹、十五項構面影響關係之評比：\n";
                        mailBody += "(格式：影響來源構面 -> 受影響構面：評分值)\n";
                        mailBody += "==========================================\n";

                        const formDataForMail = new FormData(questionnaireForm);
                        let ratingDataExists = false;
                        let ratingSectionOutput = ""; // 用於暫存評分部分的內容

                        aspects.forEach((rowAspect, rowIndex) => {
                            let rowSpecificOutput = "";
                            aspects.forEach((colAspect, colIndex) => {
                                if (rowIndex !== colIndex) {
                                    const inputName = `rating_${rowIndex}_${colIndex}`;
                                    const inputValue = formDataForMail.get(inputName);
                                    if (inputValue !== null && inputValue.trim() !== "") {
                                        // 為了讓郵件內容更易讀，將 "影響來源 -> 受影響" 的格式調整為每行一個
                                        rowSpecificOutput += `${rowAspect} -> ${colAspect}: ${inputValue}\n`;
                                        ratingDataExists = true;
                                    }
                                }
                            });
                            if (rowSpecificOutput) {
                                ratingSectionOutput += rowSpecificOutput; // 不再分組，直接附加
                            }
                        });

                        if (ratingDataExists) {
                            mailBody += ratingSectionOutput;
                        } else {
                            mailBody += "(此部分無填答資料)\n";
                        }
                        mailBody += "\n";


                        mailBody += "==========================================\n";
                        mailBody += "肆、個人基本資料：\n";
                        mailBody += "==========================================\n";

                        const gender = formDataForMail.get('gender');
                        if (gender) mailBody += `1. 性別： ${gender}\n`;

                        const yearService = formDataForMail.get('year_service');
                        if (yearService) mailBody += `2. 年資： ${yearService}\n`;

                        const educationLevel = formDataForMail.get('education_level');
                        if (educationLevel) mailBody += `3. 教育程度： ${educationLevel}\n`;

                        const rank = formDataForMail.get('rank');
                        if (rank) mailBody += `4. 階級： ${rank}\n`;

                        const jobType = formDataForMail.get('job_type');
                        if (jobType) mailBody += `5. 職務類型： ${jobType}\n`;

                        const militaryServiceStatus = formDataForMail.get('military_service_status');
                        if (militaryServiceStatus) {
                            mailBody += `6. 兵役情況： ${militaryServiceStatus}`;
                            if (militaryServiceStatus === '已退役') {
                                const retiredStatus = formDataForMail.get('retired_status');
                                if (retiredStatus) {
                                    mailBody += ` (${retiredStatus})\n`;
                                } else {
                                    mailBody += " (退役狀況未選擇)\n";
                                }
                            } else {
                                mailBody += "\n";
                            }
                        }
                        mailBody += "\n感謝您的填答！\n";

                        const recipientEmail = "ts9074@gmail.com";
                        const mailSubject = "問卷填答結果 - 影響空軍修護人員離職因素之研究";

                        const encodedSubject = encodeURIComponent(mailSubject);
                        const encodedBody = encodeURIComponent(mailBody);

                        const mailtoLink = `mailto:${recipientEmail}?subject=${encodedSubject}&body=${encodedBody}`;

                        console.log("Mailto link:", mailtoLink);
                        // console.log("Mail body content:\n", mailBody); // 印出郵件內容以供調試

                        try {
                             window.location.href = mailtoLink;
                             // 郵件寄送提示可以等實際跳轉後再提示，或者如果跳轉失敗則提示
                             // alert('即將開啟您的電子郵件應用程式以寄送問卷。\n請檢查內容並手動按下「傳送/寄出」按鈕。\n\n若郵件程式未自動開啟，請檢查瀏覽器設定或是否有預設郵件應用程式。');
                        } catch (e) {
                            console.error("無法開啟郵件客戶端:", e);
                            alert('開啟郵件客戶端失敗。\n\n這可能是因為瀏覽器限制或未設定預設郵件應用程式。\n\n您可以手動複製以下內容並寄送至 ' + recipientEmail + '：\n\n' + mailBody);
                        }
                    }, 100); // 100毫秒延遲，給列印對話框一點時間
                });

                questionnaireForm.addEventListener('reset', function() {
                    questionnaireForm.querySelectorAll('.highlight-error').forEach(el => {
                        el.classList.remove('highlight-error');
                    });
                    // 確保 DOM 更新後再執行 classList 操作
                    setTimeout(() => {
                        const currentRetiredOptionsDiv = questionnaireForm.querySelector('#retired_options_container');
                        if(currentRetiredOptionsDiv) currentRetiredOptionsDiv.classList.add('hidden');

                        const currentRetiredStatusRadios = questionnaireForm.querySelectorAll('input[name="retired_status"]');
                        if(currentRetiredStatusRadios) {
                            currentRetiredStatusRadios.forEach(radio => {
                                radio.checked = false;
                                radio.required = false; // 重設時也取消必填
                            });
                        }
                    }, 0);
                });
            } else {
                console.error("問卷表單 (questionnaireForm) 未找到！");
            }
        });
    </script>
</body>
</html>
