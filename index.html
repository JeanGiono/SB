<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>影響空軍修護人員離職因素之研究問卷</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', '微軟正黑體', 'Microsoft JhengHei', sans-serif;
        }
        .aspect-cell {
            min-width: 60px;
            text-align: center;
        }
        .input-cell {
            width: 4em;
            padding: 0.3rem;
            text-align: center;
            border: 1px solid #cbd5e1;
            border-radius: 0.25rem;
        }
        .input-cell:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
            outline: none;
        }
        th, td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .dematel-table thead th {
            position: sticky;
            top: 0;
            background-color: #f1f5f9;
            z-index: 20;
        }
        .dematel-table tbody td:first-child {
            position: sticky;
            left: 0;
            background-color: #f8fafc;
            z-index: 10;
            font-weight: 600;
        }
        .dematel-table thead th:first-child {
            left: 0;
            z-index: 30;
        }
        .diagonal-cell {
            background-color: #4b5563;
            color: #4b5563;
            user-select: none;
            vertical-align: middle;
        }
        .custom-alert {
            display: none;
            position: fixed;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background-color: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1000;
            font-size: 0.875rem;
        }
        .custom-alert button {
            margin-left: 1rem;
            background-color: transparent;
            border: none;
            color: #b91c1c;
            font-weight: bold;
            cursor: pointer;
        }
        .radio-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
        }
        /* 列印樣式 */
        @media print {
            body {
                font-size: 10pt; /* 列印時調整字型大小 */
                margin: 0;
                padding: 0;
                background-color: #fff;
            }
            .max-w-4xl {
                max-width: 100%;
                box-shadow: none;
                border: none;
                padding: 1cm; /* 列印邊距 */
            }
            header, section:not(#printSection), form > div:last-of-type, footer, #customAlert, .dematel-table-container {
                 /* 在列印時隱藏不需要的元素, DEMATEL 表格由 #printSection 控制 */
            }
             #printSectionDematalTable {
                display: block !important; /* 確保列印DEMATEL表格 */
                margin-bottom: 20px;
                overflow: visible; /* 確保表格內容完整顯示 */
            }
            #printSectionDematalTable table {
                width: 100%;
                font-size: 8pt; /* 調整表格字體大小以適應列印 */
                border-collapse: collapse;
            }
            #printSectionDematalTable th, #printSectionDematalTable td {
                border: 1px solid #000 !important; /* 列印時使用黑色邊框 */
                padding: 2px;
                min-width: auto !important; /* 移除最小寬度限制 */
                background-color: #fff !important; /* 移除背景色 */
            }
             .diagonal-cell {
                 background-color: #ccc !important; /* 列印時對角線設為灰色 */
                 color: #ccc !important;
             }

            #printSectionPersonalData {
                display: block !important; /* 確保列印個人資料 */
                margin-top: 20px;
            }
            #printSectionPersonalData h2 {
                font-size: 12pt;
                margin-bottom: 10px;
            }
            #printSectionPersonalData p {
                font-size: 10pt;
                margin-bottom: 5px;
            }

            /* 隱藏表單提交按鈕和一些互動提示 */
            button[type="submit"], .bg-sky-50, .bg-emerald-50, .bg-indigo-50, .bg-gray-50, .text-sky-700, .text-emerald-700, .text-indigo-700, .border-sky-200, .border-emerald-200, .border-indigo-200, .border-gray-200 {
                display: none !important;
            }
            .dematel-table-container { /* 取消原來的 overflow */
                 overflow: visible !important;
            }
            .dematel-table th, .dematel-table td:first-child { /* 取消sticky效果 */
                position: static !important;
            }
        }
        /* 用於放置列印內容的隱藏區域 */
        #printSectionDematalTable, #printSectionPersonalData {
            display: none;
        }


        @media (max-width: 768px) {
            .dematel-table-container {
                overflow-x: auto;
                max-height: 500px;
            }
            .dematel-table th, .dematel-table td {
                min-width: 80px;
                font-size: 0.875rem;
            }
            .dematel-table .aspect-name-col {
                min-width: 100px;
                white-space: normal;
            }
            .input-cell {
                width: 3.5em;
                font-size: 0.875rem;
            }
            .radio-options-grid {
                 grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div id="customAlert" class="custom-alert">
        <span id="customAlertMessage"></span>
        <button onclick="document.getElementById('customAlert').style.display='none'">&times;</button>
    </div>

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-lg shadow-xl">
        <header class="text-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-sky-700 mb-2">「影響空軍修護人員離職因素之研究」問卷</h1>
            <p class="text-sm text-gray-600">
                這是一份純學術之問卷研究，本問卷所有資料僅作為研究之目的，絕對保密，請您依實際感受最直接的反應填寫此份問卷，誠摯感謝您熱心的協助！
            </p>
            <div class="mt-2 text-xs text-gray-500">
                <p>國立台北大學企業管理研究所</p>
                <p>指導教授：劉仲矩 老師</p>
                <p>研究生：張靖興 學生</p>
            </div>
        </header>

        <section class="mb-8 p-4 bg-sky-50 rounded-md border border-sky-200">
            <h2 class="text-lg font-semibold text-sky-700 mb-3">壹、十五項構面影響關係之評比</h2>
            <p class="text-sm text-gray-700 mb-2"><strong>填寫指標說明：</strong></p>
            <ul class="list-disc list-inside text-sm text-gray-700 mb-2 space-y-1">
                <li><strong>0：</strong>完全沒有影響</li>
                <li><strong>1：</strong>低度影響</li>
                <li><strong>2：</strong>中度影響</li>
                <li><strong>3：</strong>高度影響</li>
                <li><strong>4：</strong>極高度影響</li>
            </ul>
        </section>

        <form id="dematelForm">
            <section class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">參、DEMATEL 影響程度評估表</h2>
                <div class="dematel-table-container">
                    <table class="min-w-full border-collapse border border-gray-300 dematel-table">
                        <thead>
                            <tr>
                                <th class="p-2 border aspect-name-col"> 被影響構面→ \ 影響構面↓</th>
                                <!-- Headers generated by JavaScript -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="mb-8 p-4 bg-indigo-50 rounded-md border border-indigo-200">
                <h2 class="text-lg font-semibold text-indigo-700 mb-3">構面定義說明</h2>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li><strong>1. 勞役不均：</strong> 工作任務分配不合理，常以低階優先，導致部分人員承擔過多工作。</li>
                    <li><strong>2. 任務壓力：</strong> 工作時間過長，工作量過多或工作內容過於繁重導致身心疲憊。</li>
                    <li><strong>3. 職業傷害：</strong> 飛機修護環境噪音過大，或需長時間承受大量廢氣或化學溶劑。</li>
                    <li><strong>4. 薪資待遇：</strong> 薪資待遇沒辦法確實反應在高工時或高壓工作環境。</li>
                    <li><strong>5. 成就實現：</strong> 從工作中獲得的自我價值感與滿足感不足，缺乏對個人能力與貢獻的肯定。</li>
                    <li><strong>6. 職涯發展：</strong> 軍職專長與民間產業難以銜接，需提早退伍提升職涯競爭力。</li>
                    <li><strong>7. 社會認同：</strong> 自覺社會大眾對軍人職業認同感低，進而影響自豪感並降低留營意願。</li>
                    <li><strong>8. 期望落差：</strong> 部隊工作內容與個人預期想像落差過大。</li>
                    <li><strong>9. 權威壓迫：</strong> 單位存在不健康的權力關係，高階濫用職權使部屬感到壓迫及不尊重。</li>
                    <li><strong>10. 同袍互動：</strong> 同袍間價值觀、個性、工作行為相左在溝通協作上產生困難或衝突。</li>
                    <li><strong>11. 人力匱乏：</strong> 人員離退後單位職缺人力長時間未能補充，增加工時負荷。</li>
                    <li><strong>12. 輕視專業：</strong> 修護人員與飛行人員意見相左時，修護人員的意見往往難以被採納。</li>
                    <li><strong>13. 家庭照顧：</strong> 工作佔據私人時間過多對家庭照護不足無法充分陪伴家人。</li>
                    <li><strong>14. 就業市場：</strong> 民間企業提供更具吸引力的職涯發展機會工作選擇更加多元。</li>
                    <li><strong>15. 政策疑慮：</strong> 國家退撫、薪資政策變動頻繁，使得軍人對於未來權益保障產生不確定感與擔憂。</li>
                </ul>
            </section>

            <section id="personalDataSection" class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">肆、個人基本資料</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">1. 性別：</label>
                        <div class="flex items-center space-x-6">
                            <label class="flex items-center"><input type="radio" name="gender" value="生理男" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 生理男</label>
                            <label class="flex items-center"><input type="radio" name="gender" value="生理女" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 生理女</label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">2. 年資：</label>
                        <div class="radio-options-grid mt-1">
                            <label class="flex items-center"><input type="radio" name="experience" value="0-5年" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 0-5年</label>
                            <label class="flex items-center"><input type="radio" name="experience" value="5-10年" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 5-10年</label>
                            <label class="flex items-center"><input type="radio" name="experience" value="10-15年" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 10-15年</label>
                            <label class="flex items-center"><input type="radio" name="experience" value="15-20年" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 15-20年</label>
                            <label class="flex items-center"><input type="radio" name="experience" value="20-25年(含以上)" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 20-25年(含以上)</label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">3. 教育程度：</label>
                        <div class="radio-options-grid mt-1">
                            <label class="flex items-center"><input type="radio" name="education" value="高中" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 高中</label>
                            <label class="flex items-center"><input type="radio" name="education" value="專科" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 專科</label>
                            <label class="flex items-center"><input type="radio" name="education" value="大學" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 大學</label>
                            <label class="flex items-center"><input type="radio" name="education" value="研究所(含以上)" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 研究所(含以上)</label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">4. 階級：</label>
                        <div class="radio-options-grid mt-1">
                            <label class="flex items-center"><input type="radio" name="rank" value="士兵" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 士兵</label>
                            <label class="flex items-center"><input type="radio" name="rank" value="士官" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 士官</label>
                            <label class="flex items-center"><input type="radio" name="rank" value="軍官" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 軍官</label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">5. 職務類型：</label>
                        <div class="flex items-center space-x-6">
                            <label class="flex items-center"><input type="radio" name="job_type" value="領導職" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 領導職</label>
                            <label class="flex items-center"><input type="radio" name="job_type" value="非領導職" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 非領導職</label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">6. 兵役情況：</label>
                        <div class="flex flex-col space-y-2">
                             <label class="flex items-center"><input type="radio" name="military_service_status" value="現役" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 現役</label>
                             <div class="ml-0">
                                <label class="flex items-center mt-1"><input type="radio" name="military_service_status" value="已退役" id="retired_radio" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 已退役</label>
                                <div id="retired_options" class="ml-6 mt-1 space-y-1 hidden">
                                   <label class="flex items-center"><input type="radio" name="military_service_detail" value="服滿役期" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 服滿役期</label>
                                   <label class="flex items-center"><input type="radio" name="military_service_detail" value="未服滿役期" class="focus:ring-sky-500 h-4 w-4 text-sky-600 border-gray-300 rounded mr-1.5"> 未服滿役期</label>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </section>

            <div class="mt-10 text-center">
                <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    提交問卷
                </button>
            </div>
        </form>

        <!-- 隱藏的列印區域 -->
        <div id="printSectionDematalTable" style="display: none;">
             <h2 style="text-align:center; font-size:14pt; margin-bottom:15px;">DEMATEL 影響程度評估結果</h2>
            <!-- DEMATEL 表格的列印版本將由JS動態生成於此 -->
        </div>
        <div id="printSectionPersonalData" style="display: none;">
            <h2 style="font-size:12pt; margin-bottom:10px;">個人基本資料</h2>
            <!-- 個人資料的列印版本將由JS動態生成於此 -->
        </div>


        <footer class="mt-12 text-center text-sm text-gray-600 border-t pt-6">
            <p>此份問卷到此結束，感謝您在百忙之中撥冗填答，衷心感謝您對本研究之支持！</p>
        </footer>
    </div>

    <script>
        const aspects = [
            "勞役不均", "任務壓力", "職業傷害", "薪資待遇", "成就實現",
            "職涯發展", "社會認同", "期望落差", "權威壓迫", "同袍互動",
            "人力匱乏", "輕視專業", "家庭照顧", "就業市場", "政策疑慮"
        ];

        const dematelTable = document.querySelector('.dematel-table');
        const headerRow = dematelTable.querySelector('thead tr');
        const tbody = dematelTable.querySelector('tbody');

        function showAlert(message) {
            const alertBox = document.getElementById('customAlert');
            const alertMessage = document.getElementById('customAlertMessage');
            alertMessage.textContent = message; // 確保使用繁體中文
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }

        const firstHeaderCell = headerRow.querySelector('th');
        firstHeaderCell.className = 'p-2 border aspect-name-col';

        aspects.forEach(aspect => {
            const th = document.createElement('th');
            th.className = 'p-1 md:p-2 border aspect-cell';
            th.textContent = aspect;
            headerRow.appendChild(th);
        });

        aspects.forEach((rowAspect, rowIndex) => {
            const tr = document.createElement('tr');
            const firstTd = document.createElement('td');
            firstTd.className = 'p-1 md:p-2 border aspect-name-col'; 
            firstTd.textContent = rowAspect;
            tr.appendChild(firstTd);

            aspects.forEach((colAspect, colIndex) => {
                const td = document.createElement('td');
                td.className = 'p-1 border aspect-cell';
                if (rowIndex === colIndex) {
                    td.classList.add('diagonal-cell');
                    td.textContent = '██';
                    td.style.verticalAlign = 'middle';
                } else {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.max = '4';
                    input.name = `rating_${rowIndex}_${colIndex}`;
                    input.className = 'input-cell';
                    input.setAttribute('data-row', rowIndex);
                    input.setAttribute('data-col', colIndex);

                    input.addEventListener('input', function(e) {
                        const value = parseInt(e.target.value, 10);
                        if (e.target.value !== "" && (isNaN(value) || value < 0 || value > 4)) {
                            showAlert('輸入錯誤！請輸入 0 到 4 之間的數字。'); // 繁體中文
                            e.target.value = '';
                        }
                    });
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                        }
                    });
                    td.appendChild(input);
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        
        const retiredRadio = document.getElementById('retired_radio');
        const retiredOptions = document.getElementById('retired_options');
        const activeRadio = document.querySelector('input[name="military_service_status"][value="現役"]'); // 更新value以匹配HTML
        const retiredDetailRadios = document.querySelectorAll('input[name="military_service_detail"]');

        function toggleRetiredOptions() {
            if (retiredRadio && retiredRadio.checked) { // 增加檢查 retiredRadio 是否存在
                if(retiredOptions) retiredOptions.classList.remove('hidden');
            } else {
                if(retiredOptions) retiredOptions.classList.add('hidden');
                if(retiredDetailRadios) retiredDetailRadios.forEach(radio => radio.checked = false);
            }
        }
        
        if(activeRadio) activeRadio.addEventListener('change', toggleRetiredOptions);
        if(retiredRadio) retiredRadio.addEventListener('change', toggleRetiredOptions);
        // 初始化 retired_options 的可見性
        toggleRetiredOptions();


        function generatePrintableDematalTable(data) {
            const tableContainer = document.getElementById('printSectionDematalTable');
            tableContainer.innerHTML = '<h2 style="text-align:center; font-size:14pt; margin-bottom:15px;">DEMATEL 影響程度評估結果</h2>'; // 清空並添加標題
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.fontSize = '8pt';

            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            let th = headerRow.insertCell();
            th.textContent = '影響構面↓ \\ 被影響構面→';
            th.style.border = '1px solid black';
            th.style.padding = '2px';
            th.style.backgroundColor = '#f0f0f0';


            aspects.forEach(aspect => {
                th = headerRow.insertCell();
                th.textContent = aspect;
                th.style.border = '1px solid black';
                th.style.padding = '2px';
                th.style.backgroundColor = '#f0f0f0';
            });

            const tbody = table.createTBody();
            aspects.forEach((rowAspect, rowIndex) => {
                const tr = tbody.insertRow();
                let td = tr.insertCell();
                td.textContent = rowAspect;
                td.style.border = '1px solid black';
                td.style.padding = '2px';
                td.style.fontWeight = 'bold';
                td.style.backgroundColor = '#f0f0f0';

                aspects.forEach((colAspect, colIndex) => {
                    td = tr.insertCell();
                    if (rowIndex === colIndex) {
                        td.textContent = '██';
                        td.style.backgroundColor = '#cccccc'; // 對角線設為灰色
                        td.style.color = '#cccccc';
                    } else {
                        const key = `${rowAspect}_影響_${colAspect}`;
                        td.textContent = data[key] !== null && data[key] !== "無效輸入" ? data[key] : '-';
                    }
                    td.style.border = '1px solid black';
                    td.style.padding = '2px';
                    td.style.textAlign = 'center';
                });
            });
            tableContainer.appendChild(table);
        }

        function generatePrintablePersonalData(data) {
            const container = document.getElementById('printSectionPersonalData');
            container.innerHTML = '<h2 style="font-size:12pt; margin-bottom:10px;">個人基本資料</h2>'; // 清空並添加標題
            const personalDataMap = {
                gender: "1. 性別",
                experience: "2. 年資",
                education: "3. 教育程度",
                rank: "4. 階級",
                job_type: "5. 職務類型",
                military_service_status: "6. 兵役情況",
                military_service_detail: "   - 詳細情況"
            };
            for (const key in personalDataMap) {
                if (data[key] !== undefined && data[key] !== null) {
                    // 特別處理兵役詳細情況，只有在已退役時才顯示
                    if (key === 'military_service_detail' && data['military_service_status'] !== '已退役') {
                        continue;
                    }
                    const p = document.createElement('p');
                    p.style.fontSize = '10pt';
                    p.style.marginBottom = '5px';
                    p.textContent = `${personalDataMap[key]}：${data[key] || '未填寫'}`;
                    container.appendChild(p);
                }
            }
        }


        function generateCSV(data) {
            let csvContent = "影響構面\\被影響構面," + aspects.join(',') + "\n";
            aspects.forEach((rowAspect, rowIndex) => {
                let row = rowAspect;
                aspects.forEach((colAspect, colIndex) => {
                    if (rowIndex === colIndex) {
                        row += ",-"; // 對角線用 '-' 表示
                    } else {
                        const key = `${rowAspect}_影響_${colAspect}`;
                        const value = data[key] !== null && data[key] !== "無效輸入" ? data[key] : ''; // 空白表示未填或無效
                        row += "," + value;
                    }
                });
                csvContent += row + "\n";
            });
            return csvContent;
        }

        document.getElementById('dematelForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            const collectedData = {}; // 使用新名稱以避免與全域 data 衝突
            let allValid = true;
            let firstInvalidElement = null;

            // 收集DEMATEL評分
            aspects.forEach((rowAspect, rowIndex) => {
                aspects.forEach((colAspect, colIndex) => {
                    if (rowIndex !== colIndex) {
                        const inputField = document.querySelector(`input[name="rating_${rowIndex}_${colIndex}"]`);
                        const valueStr = inputField.value;
                        if (valueStr === "") {
                            collectedData[`${rowAspect}_影響_${colAspect}`] = null;
                        } else {
                            const value = parseInt(valueStr, 10);
                            if (isNaN(value) || value < 0 || value > 4) {
                                allValid = false;
                                inputField.classList.add('border-red-500');
                                if (!firstInvalidElement) firstInvalidElement = inputField;
                                collectedData[`${rowAspect}_影響_${colAspect}`] = "無效輸入";
                            } else {
                                collectedData[`${rowAspect}_影響_${colAspect}`] = value;
                                inputField.classList.remove('border-red-500');
                            }
                        }
                    }
                });
            });

            if (!allValid) {
                showAlert('部分DEMATEL評分輸入無效或超出範圍 (0-4)，請檢查標紅的欄位。'); // 繁體中文
                if (firstInvalidElement) firstInvalidElement.focus();
                return;
            }

            // 收集個人資料
            collectedData.gender = formData.get('gender') || "未填寫";
            collectedData.experience = formData.get('experience') || "未填寫";
            collectedData.education = formData.get('education') || "未填寫";
            collectedData.rank = formData.get('rank') || "未填寫";
            collectedData.job_type = formData.get('job_type') || "未填寫";
            
            const militaryStatus = formData.get('military_service_status') || "未填寫";
            collectedData.military_service_status = militaryStatus;
            if (militaryStatus === '已退役') {
                collectedData.military_service_detail = formData.get('military_service_detail') || "未選擇詳細情況";
            } else {
                collectedData.military_service_detail = null; // 或 '不適用'
            }

            console.log("表單資料（準備列印與郵寄）:", collectedData); // 繁體中文

            // 1. 準備列印內容
            generatePrintableDematalTable(collectedData);
            generatePrintablePersonalData(collectedData);
            
            // 2. 觸發列印
            // 短暫延遲確保DOM更新後再列印
            setTimeout(() => {
                window.print();

                // 3. 列印後（假設）準備並觸發 mailto
                // 由於無法確知列印何時完成，這裡會在列印對話框關閉後立即執行
                // 可以考慮增加一個確認對話框詢問使用者是否已完成列印並準備寄送郵件

                const csvData = generateCSV(collectedData);
                let mailBody = "DEMATEL 問卷填答結果 (CSV 格式):\n"; // 繁體中文
                mailBody += "```csv\n"; // 使用```來嘗試保持CSV格式，但郵件客戶端支援不一
                mailBody += csvData;
                mailBody += "```\n\n";
                mailBody += "個人基本資料:\n"; // 繁體中文
                mailBody += `性別: ${collectedData.gender}\n`;
                mailBody += `年資: ${collectedData.experience}\n`;
                mailBody += `教育程度: ${collectedData.education}\n`;
                mailBody += `階級: ${collectedData.rank}\n`;
                mailBody += `職務類型: ${collectedData.job_type}\n`;
                mailBody += `兵役情況: ${collectedData.military_service_status}`;
                if (collectedData.military_service_status === '已退役') {
                    mailBody += ` (${collectedData.military_service_detail || '未選擇詳細情況'})\n`;
                } else {
                    mailBody += "\n";
                }
                
                const mailToLink = `mailto:ts9074@gmail.com` +
                                   `?subject=${encodeURIComponent("DEMATEL 問卷填答結果")}` + // 繁體中文
                                   `&body=${encodeURIComponent(mailBody)}`;

                // 檢查 mailto 連結長度
                if (mailToLink.length > 2000) { // 2000 是一個相對保守的限制
                    showAlert("郵件內容過長，可能無法完整透過 mailto 傳送。建議手動複製主控台的資料。"); // 繁體中文
                    console.log("CSV 資料 (請手動複製):\n", csvData);
                    console.log("個人基本資料 (請手動複製):\n", 
                                `性別: ${collectedData.gender}\n` +
                                `年資: ${collectedData.experience}\n` +
                                `教育程度: ${collectedData.education}\n` +
                                `階級: ${collectedData.rank}\n` +
                                `職務類型: ${collectedData.job_type}\n` +
                                `兵役情況: ${collectedData.military_service_status}` +
                                (collectedData.military_service_status === '已退役' ? ` (${collectedData.military_service_detail || '未選擇詳細情況'})\n` : "\n")
                    );
                } else {
                     // 為了避免列印對話框可能阻塞 mailto 的立即觸發，可以再加一個短延遲
                     // 或者提供一個按鈕讓使用者在列印完成後手動點擊以寄送郵件
                    setTimeout(() => {
                         window.location.href = mailToLink;
                    }, 1000); // 延遲1秒，給列印對話框一些時間
                }
                showAlert('問卷資料已準備完成，即將嘗試開啟郵件客戶端。'); // 繁體中文
            }, 500); // 延遲以確保列印內容渲染完成
        });
    </script>
</body>
</html>
