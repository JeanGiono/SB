<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCA+矛盾分析繪圖工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }
        #diagram-render-area { 
            position: relative; 
            overflow: auto; 
            padding: 0; 
            background-color: #fff; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 450px; 
            width: 100%; 
            -webkit-user-select: none; 
            -ms-user-select: none; 
            user-select: none; 
        }
        #scalable-content-wrapper { 
            position: relative;
            transform-origin: top left; 
            display: inline-block; 
            padding: 20px; 
            cursor: grab; 
        }
        #scalable-content-wrapper:active {
            cursor: grabbing; 
        }
        #svg-connector-layer { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            pointer-events: none; 
            z-index: 0; 
        }
        #rca-diagram-container { 
            display: inline-block; 
            text-align: center; 
            position: relative; 
            z-index: 1; 
            /* Ensure background is transparent or set as needed for SVG export */
            background-color: transparent; 
        }

        .rca-node-wrapper { 
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0 1rem; 
            vertical-align: top; 
            transition: margin 0.3s ease-in-out; 
        }
        .rca-node { 
            border: 2px solid #4b5563; 
            padding: 0.6rem 1.1rem; 
            margin-top: 30px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1); 
            display: inline-flex; 
            flex-direction: column; 
            align-items: center; 
            max-width: 350px; 
            border-radius: 0.375rem; 
            position: relative;
            z-index: 1; 
            background-color: #ffffff; 
            overflow-wrap: break-word; 
        }
        .rca-node-content { 
            display: flex; 
            flex-direction: column; 
            gap: 0.4rem; 
            width: 100%; 
            align-items: center; 
        }
        .rca-node-header { 
            display: flex;
            align-items: center; 
            justify-content: center; 
            gap: 0.4rem; 
            width: 100%;
            position: relative; 
            margin-bottom: 0.25rem;
        }
        .rca-node-icon { 
            font-weight: bold; font-size: 0.85em; 
            padding: 0.2em 0.4em; 
            border-radius: 50%; 
            color: white; 
            min-width: 22px; 
            height: 22px; 
            display: flex; 
            align-items: center;
            justify-content: center;
            border: 2px solid white; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); 
            z-index: 10; 
        }
        .nc-badge { 
            font-size: 0.65em; font-weight: bold; color: #374151; 
            background-color: #e5e7eb; padding: 0.15rem 0.35rem; 
            border-radius: 0.25rem; 
        }
        .rca-node-text { 
            font-weight: 500; 
            font-size: 0.9rem; 
            text-align: center; 
            overflow-wrap: break-word; 
            line-height: 1.4; 
            box-sizing: border-box;
        }
        
        .selected-items-list { 
            font-size: 0.75rem; 
            color: #374151; 
            margin-top: 0.5rem; 
            padding-top: 0.375rem; 
            border-top: 1px dashed #d1d5db; 
            width: 100%; 
            text-align: left; 
        }
        .selected-items-list strong { 
            color: #111827; 
            display: block; 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list ul { 
            list-style-type: disc; 
            margin-left: 1.25rem; 
            padding-left: 0.25rem; 
        } 
        .selected-items-list li { 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list .solution-text { color: #059669; margin-left: 0.3rem; font-style: italic;}

        .rca-node-initial-problem { background-color: #fee2e2; border-color: #ef4444; } 
        .rca-node-initial-problem .rca-node-icon { background-color: #ef4444; }
        .rca-node-cause { background-color: #fef9c3; border-color: #f59e0b; } 
        .rca-node-cause .rca-node-icon.contradictory { background-color: #8b5cf6; } 
        .rca-node-positive-effect { background-color: #dbeafe; border-color: #3b82f6; border-radius: 50px; padding: 0.6rem 1.2rem; } 
        .rca-node-positive-effect .rca-node-icon { background-color: #2563eb; }
        .rca-node-negative-effect { background-color: #ffedd5; border-color: #f97316; border-radius: 50px; padding: 0.6rem 1.2rem; } 
        .rca-node-negative-effect .rca-node-icon { background-color: #f97316; }

        .rca-children-container { 
            display: flex; 
            flex-direction: row; 
            justify-content: center; 
            align-items: flex-start; 
            margin-top: 15px; 
            position: relative; 
            padding-top: 25px; 
            width: max-content; 
        }
        
        .rca-node-actions { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.25rem; 
            margin-top: 0.5rem; 
            border-top: 1px solid #e5e7eb; 
            padding-top: 0.5rem; 
            width: 100%; 
            justify-content: flex-start; 
        }
        .action-button { background-color: #6b7280; color: white; padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; border: none; cursor: pointer; transition: background-color 0.2s; }
        .action-button:hover:not(:disabled) { background-color: #4b5563; } .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .action-button.add-cause { background-color: #3b82f6; } .action-button.add-cause:hover:not(:disabled) { background-color: #2563eb; }
        .action-button.add-positive { background-color: #10b981; } .action-button.add-positive:hover:not(:disabled) { background-color: #059669; }
        .action-button.add-negative { background-color: #f97316; } .action-button.add-negative:hover:not(:disabled) { background-color: #ea580c; }
        .action-button.toggle-nc { background-color: #a855f7; } .action-button.toggle-nc:hover:not(:disabled) { background-color: #9333ea; }
        .action-button.set-and-sources { background-color: #6d28d9; } .action-button.set-and-sources:hover:not(:disabled) { background-color: #5b21b6; }
        .action-button.edit-node { background-color: #f59e0b; } .action-button.edit-node:hover:not(:disabled) { background-color: #d97706; }
        .action-button.set-parameters { background-color: #0ea5e9; } .action-button.set-parameters:hover:not(:disabled) { background-color: #0284c7; }
        .action-button.set-principles { background-color: #ec4899; } .action-button.set-principles:hover:not(:disabled) { background-color: #db2777; }
        /* .action-button.ai-suggest class removed */
        .action-button.finalize-diagram { background-color: #059669; } .action-button.finalize-diagram:hover:not(:disabled) { background-color: #047857; }
        .action-button.edit-diagram { background-color: #d97706; } .action-button.edit-diagram:hover:not(:disabled) { background-color: #b45309; }
        .remove-button { background-color: #ef4444; } .remove-button:hover:not(:disabled) { background-color: #dc2626; }
        
        .input-group-container { margin-top: 0.5rem; width: calc(100% - 1rem); } 
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.25rem; background-color: #f9fafb; }
        .input-field { border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; width: 100%; }
        .save-button { background-color: #065f46; color: white; } .save-button:hover:not(:disabled) { background-color: #047857; }
        .save-edit-button { background-color: #065f46; color: white; } .save-edit-button:hover:not(:disabled) { background-color: #047857; }

        .data-table-section { margin-top: 2rem; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; table-layout: fixed; }
        .data-table th, .data-table td { border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem; text-align: center; vertical-align: middle; word-wrap: break-word; }
        .data-table th { background-color: #e5e7eb; font-weight: 600; }
        .data-table td { background-color: white; }
        .data-table td:first-child, .data-table th:first-child { text-align: left; }
        .data-table .action-cell { width: 120px; } 
        .data-table textarea { width: 100%; box-sizing: border-box; font-size: 0.875rem; padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 0.25rem; min-height: 40px;}
        
        .modal { z-index: 50; } 
        .modal-content { position: relative; } 
        .modal-close-button { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; line-height: 1; }
        .modal-close-button:hover { color: #1f2937; }
        .modal-options-container label { cursor: pointer; }
        .modal-options-container h4 { font-weight:600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; }
        .modal-options-container h4:first-child { margin-top: 0; }
        .principle-solution-input { width: calc(100% - 2rem); margin-left: 1.5rem; margin-top: 0.25rem; margin-bottom: 0.5rem; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.8rem; }
        /* AI Suggestion related styles removed */
        .loading-spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; display: none; }
        .loading-spinner { border: 8px solid #f3f3f3; border-top: 8px solid #7c3aed; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .zoom-controls { display: flex; gap: 0.5rem; align-items: center; }
        .zoom-controls span { font-size: 0.875rem; color: #4b5563; min-width: 50px; text-align: center; }
        
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 250px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 0.375rem; padding: 0.5rem 0; }
        .dropdown-content button, .dropdown-content label { color: black; padding: 0.75rem 1rem; text-decoration: none; display: block; text-align: left; background: none; border: none; width: 100%; font-size: 0.875rem; cursor: pointer; }
        .dropdown-content button:hover, .dropdown-content label:hover { background-color: #e5e7eb; }
        .dropdown-content button:disabled { color: #9ca3af; cursor: not-allowed; background-color: #f9f9f9; }
        .dropdown-content button i, .dropdown-content label i { margin-right: 0.5rem; width: 1.25rem; text-align: center; }
        .dropdown-trigger-button { background-color: #1f2937; } 
        .dropdown-trigger-button:hover:not(:disabled) { background-color: #374151; }

        #tracking-item-modal .input-field, #tracking-item-modal textarea, #tracking-item-modal select {
            margin-bottom: 0.75rem;
        }

        #triz-mcda-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .triz-mcda-phase {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .triz-mcda-phase:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .triz-mcda-phase h3 {
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #374151; 
            margin-bottom: 1rem;
        }
        .triz-parameter-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .triz-solution-concept {
            margin-top: 0.5rem;
        }
        .triz-solution-concept textarea {
            min-height: 60px;
        }
        #mcda-criteria-table th, #mcda-criteria-table td {
            padding: 0.5rem;
            font-size: 0.875rem;
            text-align: left; /* Keep left align for criterion name */
            vertical-align: middle; /* Ensure vertical centering */
        }
        #mcda-criteria-table input[type="number"] {
            width: 60px;
            text-align: right;
        }
         #mcda-evaluation-table th { /* Header cells in evaluation table */
            padding: 0.5rem;
            font-size: 0.875rem;
            text-align: center; /* Center align header text */
            vertical-align: middle;
        }
        #mcda-evaluation-table td { /* Data cells in evaluation table */
            padding: 0.5rem;
            font-size: 0.875rem;
            text-align: center; /* Center align cell content (input boxes, scores) */
            vertical-align: middle; /* Ensure vertical centering */
        }
        #mcda-evaluation-table td:first-child { /* First column (solution name) can be left aligned */
             text-align: left;
        }
         #mcda-evaluation-table input[type="number"] {
            width: 50px;
            text-align: center; /* Input text itself is centered */
            margin: 0 auto; /* Center the input box within the cell */
        }
        .mcda-result {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
        }
       
        @media print { 
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            header, #controls-section, .modal, .dropdown-content, #loading-spinner-overlay, .rca-node-actions, #toggle-triz-mcda-button, #export-menu-button, #view-tables-menu-button, #add-tracking-item-button, #save-triz-mcda-button, .remove-button, .edit-node 
            { 
                display: none !important; 
            }
            #rca-diagram-section, #cause-effect-table-section, #solution-table-section, #tracking-table-section, #triz-mcda-section {
                box-shadow: none !important;
                border: none !important;
                margin-top: 0.5rem !important;
                padding: 0.5rem !important;
                display: block !important; 
                page-break-inside: avoid;
            }
            #scalable-content-wrapper { 
                transform: scale(0.8) !important; 
                transform-origin: top left !important; 
                padding: 5px !important; 
                width: 100% !important; 
                overflow: visible !important;
            }
             #rca-diagram-container, #svg-connector-layer {
                display: block !important; 
            }
            .data-table th, .data-table td { font-size: 9pt !important; padding: 0.2rem !important;}
            .rca-node { margin-top: 10px !important; margin-bottom: 5px !important; padding: 0.3rem 0.6rem !important; border-width: 1px !important; }
            .rca-node-text { font-size: 0.75rem !important; }
            header h1 { font-size: 1.5rem !important; } 
            .container > header h1 { font-size: 1.5rem !important; display: block !important; } 
            .container > header p { font-size: 0.9rem !important; display: block !important; }
            .data-table-section h2, .triz-mcda-phase h3, #diagram-title { font-size: 1.1rem !important; margin-bottom: 0.5rem !important; }
            #svg-connector-layer { 
                top: 5px !important; 
                left: 5px !important;
            }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; } 
            tfoot { display: table-footer-group; }
            button { display: none !important; } 
            .action-button { display: none !important; }
            .dropdown { display: none !important; }
            .zoom-controls { display: none !important; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="loading-spinner-overlay" class="loading-spinner-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="container mx-auto max-w-7xl"> 
        <header class="mb-6 text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">RCA+矛盾分析繪圖工具</h1>
            <p class="text-gray-500 mt-1">視覺化根本原因、矛盾，整合 TRIZ-MCDA 分析流程，並包含改善方案追蹤。</p> 
        </header>

        <section id="controls-section" class="mb-6 p-4 bg-white rounded-lg shadow">
             <div id="problem-input-area">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">1. 設定主要負面效果 (RCA+)</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="problem-statement-input" placeholder="輸入觀察到的主要負面效果" class="input-field flex-grow p-2 rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <button id="set-problem-button" class="action-button add-cause text-white font-semibold py-2 px-4 rounded-md">設定問題根源</button>
                </div>
            </div>
            <div id="tool-buttons" class="mt-4 flex flex-col gap-3">
                <div class="flex flex-wrap gap-2 justify-center items-center">
                    <div class="dropdown">
                        <button id="file-menu-button" class="action-button dropdown-trigger-button text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-file-alt"></i> 檔案 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="file-dropdown-content" class="dropdown-content">
                            <button id="save-workspace-button"><i class="fas fa-save"></i> 儲存工作區 (瀏覽器)</button>
                            <button id="load-workspace-button"><i class="fas fa-folder-open"></i> 載入工作區 (瀏覽器)</button>
                            <button id="download-backup-button"><i class="fas fa-file-download"></i> 下載備份 (.json)</button>
                            <label for="load-backup-input" id="load-backup-label"><i class="fas fa-file-upload"></i> 從備份載入 (.json)</label>
                            <input type="file" id="load-backup-input" accept=".json" style="display: none;">
                        </div>
                    </div>
                    <button id="undo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-undo"></i> 上一步
                    </button>
                    <button id="redo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-redo"></i> 下一步
                    </button>
                    <div class="zoom-controls">
                        <button id="zoom-out-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="縮小"><i class="fas fa-search-minus"></i></button>
                        <span id="zoom-level-display">100%</span>
                        <button id="zoom-in-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="放大"><i class="fas fa-search-plus"></i></button>
                        <button id="reset-zoom-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-md">重設縮放</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 justify-center">
                    <button id="finalize-diagram-button" class="action-button finalize-diagram text-white font-semibold py-2 px-4 rounded-md">完成圖表</button>
                    <button id="auto-adjust-layout-button" class="action-button bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-project-diagram"></i> 自動調整節點
                    </button>
                     <button id="toggle-triz-mcda-button" class="action-button bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-lightbulb mr-1"></i> TRIZ-MCDA 分析
                    </button>
                    <div class="dropdown">
                        <button id="export-menu-button" class="action-button dropdown-trigger-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-download"></i> 匯出 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="export-dropdown-content" class="dropdown-content">
                            <button id="export-cause-effect-csv-button"><i class="fas fa-file-csv"></i> 匯出原因效果表 (CSV)</button>
                            <button id="export-solution-csv-button"><i class="fas fa-file-csv"></i> 匯出改善方案表 (CSV)</button>
                            <button id="export-tracking-csv-button"><i class="fas fa-file-csv"></i> 匯出改善追蹤表 (CSV)</button>
                            <hr class="my-1 border-gray-300">
                            <button id="export-svg-button"><i class="fas fa-file-image"></i> 匯出圖表 (SVG)</button>
                            <hr class="my-1 border-gray-300">
                            <button id="print-document-button"><i class="fas fa-print"></i> 列印文件</button>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button id="view-tables-menu-button" class="action-button dropdown-trigger-button bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-table"></i> 檢視表格 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="view-tables-dropdown-content" class="dropdown-content">
                            <button id="show-cause-effect-table-button"><i class="fas fa-tasks"></i> 顯示原因效果表</button>
                            <button id="show-solution-table-button"><i class="fas fa-lightbulb"></i> 顯示改善方案表</button>
                            <button id="show-tracking-table-button"><i class="fas fa-clipboard-check"></i> 顯示改善追蹤表</button>
                            <button id="hide-all-tables-button"><i class="fas fa-eye-slash"></i> 隱藏所有表格</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="triz-mcda-section" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">TRIZ-MCDA 整合分析</h2>
            
            <div id="triz-phase-1" class="triz-mcda-phase">
                <h3>階段一：問題定義</h3>
                <div>
                    <label for="triz-problem-description" class="block text-sm font-medium text-gray-700 mb-1">問題描述：</label>
                    <textarea id="triz-problem-description" rows="3" class="input-field w-full" placeholder="詳細描述您待解決的問題..."></textarea>
                </div>
                <div class="mt-4">
                    <label for="triz-contradiction-phenomenon" class="block text-sm font-medium text-gray-700 mb-1">矛盾現象：</label>
                    <input type="text" id="triz-contradiction-phenomenon" class="input-field w-full" placeholder="例如：當A改善時，卻導致B惡化">
                </div>
            </div>

            <div id="triz-phase-2" class="triz-mcda-phase">
                <h3>階段二：TRIZ 方案生成</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="triz-improving-parameter" class="block text-sm font-medium text-gray-700 mb-1">改善參數 (Improving Feature)：</label>
                        <select id="triz-improving-parameter" class="triz-parameter-select"></select>
                    </div>
                    <div>
                        <label for="triz-worsening-parameter" class="block text-sm font-medium text-gray-700 mb-1">惡化參數 (Worsening Feature)：</label>
                        <select id="triz-worsening-parameter" class="triz-parameter-select"></select>
                    </div>
                </div>
                <button id="triz-generate-principles-button" class="action-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md mt-3">
                    <i class="fas fa-cogs mr-2"></i>應用矛盾矩陣建議發明原理
                </button>
                <div id="triz-principles-output" class="mt-4">
                    </div>
                 </div>

            <div id="triz-phase-3" class="triz-mcda-phase">
                <h3>階段三：MCDA 評估框架</h3>
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">設定評估標準與權重：</h4>
                    <div id="mcda-criteria-input-area" class="space-y-2 mb-4">
                        </div>
                    <button id="mcda-add-criterion-button" class="action-button bg-gray-500 hover:bg-gray-600 text-sm py-1 px-3 rounded-md">
                        <i class="fas fa-plus mr-1"></i>新增標準
                    </button>
                    <button id="mcda-calculate-total-weight-button" class="action-button bg-yellow-500 hover:bg-yellow-600 text-sm py-1 px-3 rounded-md ml-2">
                        檢查權重總和
                    </button>
                    <span id="mcda-total-weight-display" class="ml-2 text-sm text-gray-600"></span>
                </div>
                <div id="mcda-evaluation-area" class="mt-6">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">方案評估表：</h4>
                    <div class="overflow-x-auto">
                        <table id="mcda-evaluation-table" class="data-table w-full">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                     <button id="mcda-calculate-scores-button" class="action-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md mt-4">
                        <i class="fas fa-calculator mr-2"></i>計算總分並推薦方案
                    </button>
                </div>
                <div id="mcda-result-output" class="mcda-result" style="display: none;">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">評估結果：</h4>
                    <p id="mcda-best-solution-text" class="text-green-600 font-semibold"></p>
                    <div class="mt-2">
                        <label for="mcda-recommendation-reason-text" class="block text-sm font-medium text-gray-700">推薦理由：</label>
                        <textarea id="mcda-recommendation-reason-text" rows="3" class="input-field w-full mt-1" placeholder="手動輸入推薦理由..."></textarea>
                    </div>
                     </div>
            </div>
             <button id="save-triz-mcda-button" class="action-button bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md mt-6">
                <i class="fas fa-save mr-2"></i>儲存 TRIZ-MCDA 分析進度
            </button>
        </section>

        <section id="rca-diagram-section" class="bg-white p-0 md:p-0 rounded-lg shadow min-h-[400px]">
            <h2 class="text-xl font-semibold text-gray-700 my-4 text-center" id="diagram-title" style="display: none;">2. RCA+ 分析圖</h2>
            <div id="diagram-render-area"> 
                <div id="scalable-content-wrapper">
                    <div id="rca-diagram-container"></div> 
                    <svg id="svg-connector-layer"></svg>
                </div>
            </div>
        </section>

        <section id="cause-effect-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">3. 原因效果表</h2>
            <table class="data-table" id="cause-effect-data-table">
                <thead> <tr><th>原因</th><th>原因類型</th><th>正面效果</th><th>負面效果</th></tr> </thead>
                <tbody id="cause-effect-table-body"></tbody>
            </table>
        </section>
        <section id="solution-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">4. 矛盾點之創意改善方案表</h2>
            <table class="data-table" id="solution-data-table">
                <thead> <tr><th>矛盾原因</th><th>發明原理</th><th>改善方案</th></tr> </thead>
                <tbody id="solution-table-body"></tbody>
            </table>
        </section>
        <section id="tracking-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold text-gray-700">5. 改善方案追蹤表</h2>
                <button id="add-tracking-item-button" class="action-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">
                    <i class="fas fa-plus mr-2"></i>新增追蹤項目
                </button>
            </div>
            <table class="data-table" id="tracking-data-table">
                <thead> 
                    <tr>
                        <th style="width: 20%;">改善方案</th>
                        <th style="width: 10%;">負責人</th>
                        <th style="width: 10%;">完成日期</th>
                        <th style="width: 15%;">狀態</th>
                        <th style="width: 25%;">實際成效</th>
                        <th style="width: 10%;">備註</th>
                        <th class="action-cell">操作</th>
                    </tr> 
                </thead>
                <tbody id="tracking-table-body"></tbody>
            </table>
        </section>
        
        <div id="and-source-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('and-source-modal').style.display='none'; currentAndTargetNodeId = null;">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="and-source-modal-title">為效果設定 AND 輸入源</h3>
                    <div class="mt-4 px-2 py-3 max-h-72 overflow-y-auto modal-options-container" id="and-source-options-container"></div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-and-sources-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-and-sources-button" class="action-button px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-700">儲存AND來源</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="effect-parameter-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('effect-parameter-modal').style.display='none'; currentParameterTargetNodeId = null;">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="effect-parameter-modal-title">設定效果參數</h3>
                    <div class="mt-4 px-2 py-3 max-h-96 overflow-y-auto modal-options-container" id="effect-parameter-options-container"></div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-effect-parameters-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-effect-parameters-button" class="action-button px-4 py-2 bg-sky-500 text-white rounded-md hover:bg-sky-700">儲存參數</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="inventive-principle-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('inventive-principle-modal').style.display='none'; currentPrincipleTargetNodeId = null;">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="inventive-principle-modal-title">選擇發明原理與改善方案</h3>
                    <div class="mt-4 px-2 py-3 max-h-[calc(100vh-200px)] overflow-y-auto modal-options-container" id="inventive-principle-options-container">
                    </div>
                     <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-inventive-principles-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-inventive-principles-button" class="action-button px-4 py-2 bg-pink-500 text-white rounded-md hover:bg-pink-700">儲存原理與方案</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="tracking-item-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                 <button class="modal-close-button" onclick="closeTrackingItemModal()">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4" id="tracking-item-modal-title">新增/編輯追蹤項目</h3>
                    <input type="hidden" id="tracking-item-id">
                    <div>
                        <label for="tracking-solution-text" class="block text-sm font-medium text-gray-700">改善方案</label>
                        <textarea id="tracking-solution-text" rows="3" class="input-field w-full mt-1" placeholder="輸入改善方案描述"></textarea>
                    </div>
                    <div>
                        <label for="tracking-responsible-person" class="block text-sm font-medium text-gray-700 mt-2">負責人</label>
                        <input type="text" id="tracking-responsible-person" class="input-field w-full mt-1" placeholder="輸入負責人或團隊">
                    </div>
                    <div>
                        <label for="tracking-due-date" class="block text-sm font-medium text-gray-700 mt-2">預計完成日期</label>
                        <input type="date" id="tracking-due-date" class="input-field w-full mt-1">
                    </div>
                    <div>
                        <label for="tracking-status" class="block text-sm font-medium text-gray-700 mt-2">狀態</label>
                        <select id="tracking-status" class="input-field w-full mt-1">
                            <option value="未開始">未開始</option>
                            <option value="進行中">進行中</option>
                            <option value="已完成">已完成</option>
                            <option value="已驗證">已驗證</option>
                            <option value="遇到障礙">遇到障礙</option>
                            <option value="已取消">已取消</option>
                        </select>
                    </div>
                    <div>
                        <label for="tracking-actual-outcome" class="block text-sm font-medium text-gray-700 mt-2">實際成效</label>
                        <textarea id="tracking-actual-outcome" rows="3" class="input-field w-full mt-1" placeholder="記錄實際執行成效與結果"></textarea>
                    </div>
                    <div>
                        <label for="tracking-notes" class="block text-sm font-medium text-gray-700 mt-2">備註</label>
                        <textarea id="tracking-notes" rows="2" class="input-field w-full mt-1" placeholder="其他備註事項"></textarea>
                    </div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-tracking-item-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400" onclick="closeTrackingItemModal()">取消</button>
                        <button id="save-tracking-item-button" class="action-button px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-700">儲存項目</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- TRIZ-MCDA 相關資料與變數 ---
        let trizMcdaData = {
            problemDescription: "",
            contradictionPhenomenon: "",
            improvingParameter: null,
            worseningParameter: null,
            suggestedPrinciples: [], 
            mcdaCriteria: [], 
            mcdaSolutions: [], 
            mcdaBestSolution: null,
            mcdaRecommendation: ""
        };
        const TRIZ_PARAMETERS = []; 
        const TRIZ_PRINCIPLES = {}; 
        const TRIZ_CONTRADICTION_MATRIX = {}; 

        // --- 現有全域變數與常數 ---
        let trackingData = []; 
        let currentEditingTrackingItemId = null; 
        function deepCopy(obj) { return JSON.parse(JSON.stringify(obj)); } 
        let rcaData = null; 
        let nodeIdCounter = 0; 
        let currentAndTargetNodeId = null; 
        let isFinalizedView = false; 
        let currentParameterTargetNodeId = null; 
        let currentPrincipleTargetNodeId = null; 
        let currentZoom = 1.0; 
        const ZOOM_STEP = 0.1; 
        const MIN_ZOOM = 0.2; 
        const MAX_ZOOM = 3.0; 
        let historyStack = []; 
        let historyIndex = -1; 
        const MAX_HISTORY_STATES = 50; 

        const problemInput = document.getElementById('problem-statement-input');
        const setProblemButton = document.getElementById('set-problem-button');
        const diagramRenderArea = document.getElementById('diagram-render-area'); 
        const scalableContentWrapper = document.getElementById('scalable-content-wrapper');
        const diagramContainer = document.getElementById('rca-diagram-container'); 
        const svgLayer = document.getElementById('svg-connector-layer');
        const diagramTitle = document.getElementById('diagram-title');
        const problemInputArea = document.getElementById('problem-input-area');
        const toolButtonsContainer = document.getElementById('tool-buttons');
        const loadingSpinnerOverlay = document.getElementById('loading-spinner-overlay');
        
        const fileMenuButton = document.getElementById('file-menu-button');
        const fileDropdownContent = document.getElementById('file-dropdown-content');
        const saveWorkspaceButton = document.getElementById('save-workspace-button'); 
        const loadWorkspaceButton = document.getElementById('load-workspace-button'); 
        const downloadBackupButton = document.getElementById('download-backup-button');   
        const loadBackupLabel = document.getElementById('load-backup-label'); 
        const loadBackupInput = document.getElementById('load-backup-input');
        
        const undoButton = document.getElementById('undo-button');
        const redoButton = document.getElementById('redo-button');
        
        const zoomOutButton = document.getElementById('zoom-out-button'); 
        const zoomInButton = document.getElementById('zoom-in-button');   
        const resetZoomButton = document.getElementById('reset-zoom-button'); 
        const zoomLevelDisplay = document.getElementById('zoom-level-display'); 
        
        const finalizeDiagramButton = document.getElementById('finalize-diagram-button'); 
        const autoAdjustLayoutButton = document.getElementById('auto-adjust-layout-button'); 
        const toggleTrizMcdaButton = document.getElementById('toggle-triz-mcda-button'); 

        const exportMenuButton = document.getElementById('export-menu-button');
        const exportDropdownContent = document.getElementById('export-dropdown-content');
        const exportCauseEffectCsvButton = document.getElementById('export-cause-effect-csv-button'); 
        const exportSolutionCsvButton = document.getElementById('export-solution-csv-button'); 
        const exportTrackingCsvButton = document.getElementById('export-tracking-csv-button'); 
        const exportSvgButton = document.getElementById('export-svg-button');
        const printDocumentButton = document.getElementById('print-document-button'); 


        const viewTablesMenuButton = document.getElementById('view-tables-menu-button');
        const viewTablesDropdownContent = document.getElementById('view-tables-dropdown-content');
        const showCauseEffectTableButton = document.getElementById('show-cause-effect-table-button');
        const showSolutionTableButton = document.getElementById('show-solution-table-button');
        const showTrackingTableButton = document.getElementById('show-tracking-table-button'); 
        const hideAllTablesButton = document.getElementById('hide-all-tables-button');

        const causeEffectTableSection = document.getElementById('cause-effect-table-section');
        const causeEffectTableBody = document.getElementById('cause-effect-table-body');
        const solutionTableSection = document.getElementById('solution-table-section'); 
        const solutionTableBody = document.getElementById('solution-table-body'); 
        const trackingTableSection = document.getElementById('tracking-table-section'); 
        const trackingTableBody = document.getElementById('tracking-table-body'); 
        const addTrackingItemButton = document.getElementById('add-tracking-item-button'); 
        
        const andSourceModal = document.getElementById('and-source-modal');
        const andSourceOptionsContainer = document.getElementById('and-source-options-container');
        const andSourceModalTitle = document.getElementById('and-source-modal-title');
        const saveAndSourcesButton = document.getElementById('save-and-sources-button');
        const cancelAndSourcesButton = document.getElementById('cancel-and-sources-button');
        const effectParameterModal = document.getElementById('effect-parameter-modal');
        const effectParameterOptionsContainer = document.getElementById('effect-parameter-options-container');
        const effectParameterModalTitle = document.getElementById('effect-parameter-modal-title');
        const saveEffectParametersButton = document.getElementById('save-effect-parameters-button');
        const cancelEffectParametersButton = document.getElementById('cancel-effect-parameters-button');
        
        const inventivePrincipleModal = document.getElementById('inventive-principle-modal');
        const inventivePrincipleOptionsContainer = document.getElementById('inventive-principle-options-container');
        const inventivePrincipleModalTitle = document.getElementById('inventive-principle-modal-title');
        const saveInventivePrinciplesButton = document.getElementById('save-inventive-principles-button');
        const cancelInventivePrinciplesButton = document.getElementById('cancel-inventive-principles-button');

        const trackingItemModal = document.getElementById('tracking-item-modal');
        const trackingItemModalTitle = document.getElementById('tracking-item-modal-title');
        const trackingItemIdInput = document.getElementById('tracking-item-id');
        const trackingSolutionTextInput = document.getElementById('tracking-solution-text');
        const trackingResponsiblePersonInput = document.getElementById('tracking-responsible-person');
        const trackingDueDateInput = document.getElementById('tracking-due-date');
        const trackingStatusSelect = document.getElementById('tracking-status');
        const trackingActualOutcomeInput = document.getElementById('tracking-actual-outcome');
        const trackingNotesInput = document.getElementById('tracking-notes');
        const saveTrackingItemButton = document.getElementById('save-tracking-item-button');

        const trizMcdaSection = document.getElementById('triz-mcda-section');
        const trizProblemDescriptionInput = document.getElementById('triz-problem-description');
        const trizContradictionPhenomenonInput = document.getElementById('triz-contradiction-phenomenon');
        const trizImprovingParameterSelect = document.getElementById('triz-improving-parameter');
        const trizWorseningParameterSelect = document.getElementById('triz-worsening-parameter');
        const trizGeneratePrinciplesButton = document.getElementById('triz-generate-principles-button');
        const trizPrinciplesOutput = document.getElementById('triz-principles-output');
        const mcdaCriteriaInputArea = document.getElementById('mcda-criteria-input-area');
        const mcdaAddCriterionButton = document.getElementById('mcda-add-criterion-button');
        const mcdaCalculateTotalWeightButton = document.getElementById('mcda-calculate-total-weight-button');
        const mcdaTotalWeightDisplay = document.getElementById('mcda-total-weight-display');
        const mcdaEvaluationTable = document.getElementById('mcda-evaluation-table');
        const mcdaCalculateScoresButton = document.getElementById('mcda-calculate-scores-button');
        const mcdaResultOutput = document.getElementById('mcda-result-output');
        const mcdaBestSolutionText = document.getElementById('mcda-best-solution-text');
        const mcdaRecommendationReasonText = document.getElementById('mcda-recommendation-reason-text'); 
        const saveTrizMcdaButton = document.getElementById('save-triz-mcda-button');


        const EFFECT_PARAMETERS = {
            "活動": ["活動效用性", "活動可變性", "活動費用", "活動時間", "活動複雜性", "活動方便性", "活動安全性", "活動可靠性"],
            "系統": ["系統有效性", "系統可變性", "系統費用", "系統時間", "系統複雜性", "系統方便性", "系統安全性", "系統可靠性", "對系統的有害影響", "系統產生的有害影響", "組織壓力", "組織穩定性"],
            "其他": ["內部風險", "外部風險", "信息共享", "信息損失", "信息流", "回饋", "物料流", "適應性/多功能性", "顧客壓力", "顧客穩定性", "環境穩定性"]
        }; 
        const INVENTIVE_PRINCIPLES = [
            "分割", "取出/分離", "改變局部特性", "非對稱性", "合併/整合", "多用性/多功能", "套疊/巢狀結構", "反制行動", 
            "預先反制行動", "預先作用", "事先補償/預防", "消除緊張", "另一方向/反向操作", "非直線姓", "動態化", 
            "稍微少些或多些(的動作)", "另外維度/空間", "共鳴(協調)", "週期行動", "連續的有利作用", "快速行動", 
            "轉有害為利", "回饋", "中介物/媒介", "自助/自我服務", "使用複製品或模型", "廉價與短期[拋棄式]", 
            "替換系統運作原理/使用其他原理", "流動性和靈活性", "改變邊界條件", "孔洞和網路", "改變外觀/可見度", 
            "同質性", "丟棄與恢復", "改變特性", "模範轉移", "相對變化", "增強的環境", "鈍性(惰性)環境", "組合(複合)結構"
        ];
        
        // --- Helper Functions (Dropdown, Zoom, UI State, History, Persistence) ---
        function toggleDropdown(dropdownToShow, otherDropdownsToHide) {
            const currentDisplay = dropdownToShow.style.display;
            otherDropdownsToHide.forEach(dd => dd.style.display = 'none');
            dropdownToShow.style.display = currentDisplay === 'block' ? 'none' : 'block';
        }

        function closeAllDropdowns() {
            fileDropdownContent.style.display = 'none';
            exportDropdownContent.style.display = 'none';
            viewTablesDropdownContent.style.display = 'none';
        }
        
        function applyZoom(newZoomLevel, avoidRedraw = false) { 
            currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoomLevel)); 
            scalableContentWrapper.style.transform = `scale(${currentZoom})`; 
            zoomLevelDisplay.textContent = `${Math.round(currentZoom * 100)}%`; 
            if (!avoidRedraw && rcaData) { 
                requestAnimationFrame(() => drawAllSvgConnectors()); 
            } 
            updateButtonStates(); 
        }
        
        function showLoadingSpinner() { loadingSpinnerOverlay.style.display = 'flex'; }
        function hideLoadingSpinner() { loadingSpinnerOverlay.style.display = 'none'; }

        function updateButtonStates() { 
            const noData = !rcaData; 
            const noLocalStorageData = !localStorage.getItem('rcaPlusData'); 
            
            undoButton.disabled = historyIndex <= 0; 
            redoButton.disabled = historyIndex >= historyStack.length - 1; 
            
            saveWorkspaceButton.disabled = noData && trackingData.length === 0 && !hasTrizMcdaData(); 
            loadWorkspaceButton.disabled = noLocalStorageData; 
            downloadBackupButton.disabled = noData && trackingData.length === 0 && !hasTrizMcdaData(); 
            
            zoomInButton.disabled = currentZoom >= MAX_ZOOM; 
            zoomOutButton.disabled = currentZoom <= MIN_ZOOM; 
            resetZoomButton.disabled = currentZoom === 1.0; 
            
            exportCauseEffectCsvButton.disabled = noData || causeEffectTableSection.style.display === 'none';
            exportSolutionCsvButton.disabled = noData || solutionTableSection.style.display === 'none';
            exportTrackingCsvButton.disabled = noData || trackingTableSection.style.display === 'none';
            if (exportSvgButton) exportSvgButton.disabled = noData; 
            printDocumentButton.disabled = noData && trackingData.length === 0 && !hasTrizMcdaData(); 
            exportMenuButton.disabled = noData && trackingData.length === 0 && !hasTrizMcdaData(); 


            finalizeDiagramButton.disabled = noData; 
            autoAdjustLayoutButton.disabled = noData || isFinalizedView; 
            
            viewTablesMenuButton.disabled = noData;
            showCauseEffectTableButton.disabled = noData;
            showSolutionTableButton.disabled = noData;
            showTrackingTableButton.disabled = noData; 
            addTrackingItemButton.disabled = noData; 
            hideAllTablesButton.disabled = noData || (causeEffectTableSection.style.display === 'none' && solutionTableSection.style.display === 'none' && trackingTableSection.style.display === 'none');
        }
        
        function hasTrizMcdaData() {
            return trizMcdaData.problemDescription || trizMcdaData.contradictionPhenomenon || trizMcdaData.suggestedPrinciples.length > 0 || trizMcdaData.mcdaCriteria.length > 0;
        }

        function pushStateToHistory(currentRcaData, clearRedoStack = true) { 
            if (!currentRcaData && trackingData.length === 0 && !hasTrizMcdaData()) { updateButtonStates(); return; } 
            const stateCopy = {
                rca: currentRcaData ? deepCopy(currentRcaData) : null,
                tracking: deepCopy(trackingData),
                trizMcda: deepCopy(trizMcdaData) 
            };
            if (clearRedoStack) { 
                historyStack = historyStack.slice(0, historyIndex + 1); 
            } 
            historyStack.push({ diagramData: stateCopy.rca, trackingInfo: stateCopy.tracking, trizMcdaInfo: stateCopy.trizMcda, counter: nodeIdCounter, zoom: currentZoom }); 
            historyIndex = historyStack.length - 1; 
            if (historyStack.length > MAX_HISTORY_STATES) { 
                historyStack.shift(); 
                historyIndex--; 
            } 
            updateButtonStates(); 
        }
        function restoreStateFromHistory(historyEntry) { 
            if (historyEntry) { 
                rcaData = historyEntry.diagramData ? deepCopy(historyEntry.diagramData) : null; 
                trackingData = historyEntry.trackingInfo ? deepCopy(historyEntry.trackingInfo) : []; 
                trizMcdaData = historyEntry.trizMcdaInfo ? deepCopy(historyEntry.trizMcdaInfo) : initializeTrizMcdaDataObject(); 
                nodeIdCounter = historyEntry.counter; 
                recalculateNodeIdCounter(rcaData); 
                renderRcaDiagram(); 
                renderCauseEffectTable(); 
                renderSolutionTable(); 
                renderTrackingTable(); 
                renderTrizMcdaFromData(); 
                applyZoom(historyEntry.zoom, true); 
            } else { 
                console.error("無法從歷史記錄中檢索狀態。"); 
                return false; 
            } 
            return true; 
        } 
        function handleUndo() { 
            if (historyIndex > 0) { 
                historyIndex--; 
                if (!restoreStateFromHistory(historyStack[historyIndex])) { 
                    historyIndex++; 
                } 
            } 
            updateButtonStates(); 
        }
        function handleRedo() { 
            if (historyIndex < historyStack.length - 1) { 
                historyIndex++; 
                if (!restoreStateFromHistory(historyStack[historyIndex])) { 
                    historyIndex--; 
                } 
            } 
            updateButtonStates(); 
        }
        
        function processLoadedData(dataString) { 
            try { 
                const parsedJson = JSON.parse(dataString); 
                if (parsedJson && (typeof parsedJson.diagramData !== 'undefined' || typeof parsedJson.rcaDiagramData !== 'undefined') && typeof parsedJson.counter !== 'undefined') { 
                    rcaData = parsedJson.diagramData || parsedJson.rcaDiagramData; 
                    trackingData = parsedJson.trackingData || []; 
                    trizMcdaData = parsedJson.trizMcdaData || initializeTrizMcdaDataObject(); 
                    nodeIdCounter = parseInt(parsedJson.counter); 
                    if (isNaN(nodeIdCounter)) nodeIdCounter = 0; 
                    recalculateNodeIdCounter(rcaData); 
                    historyStack = []; 
                    historyIndex = -1; 
                    pushStateToHistory(rcaData, true); 
                    problemInputArea.style.display = rcaData ? 'none' : 'flex'; 
                    diagramTitle.style.display = rcaData ? 'block' : 'none'; 
                    toolButtonsContainer.style.display = 'flex'; 
                    renderRcaDiagram(); 
                    renderCauseEffectTable(); 
                    renderSolutionTable(); 
                    renderTrackingTable(); 
                    renderTrizMcdaFromData(); 
                    applyZoom(parsedJson.zoomLevel || 1.0, true); 
                    alert('圖表進度已成功載入！'); 
                    return true; 
                } else { 
                    alert('載入失敗：檔案格式不正確或資料不完整。'); 
                    return false; 
                } 
            } catch (e) { 
                console.error("載入資料時發生錯誤:", e); 
                alert('載入失敗：檔案內容可能不是有效的JSON格式，或已損毀。\n' + e.message); 
                return false; 
            } finally { 
                updateButtonStates(); 
            } 
        } 
        function handleSaveToLocalStorage() { 
            if (rcaData || trackingData.length > 0 || hasTrizMcdaData()) { 
                try { 
                    const dataToSave = { diagramData: rcaData, trackingData: trackingData, trizMcdaData: trizMcdaData, counter: nodeIdCounter, zoomLevel: currentZoom }; 
                    localStorage.setItem('rcaPlusData', JSON.stringify(dataToSave)); 
                    alert('圖表進度已儲存至瀏覽器！'); 
                } catch (e) { 
                    console.error("儲存至localStorage時發生錯誤:", e); 
                    alert('儲存失敗，可能是瀏覽器儲存空間已滿或功能受限。'); 
                } 
            } else { 
                alert('沒有圖表資料可儲存。'); 
            } 
            updateButtonStates(); 
        }
        function handleLoadFromLocalStorage() { 
            const savedDataString = localStorage.getItem('rcaPlusData'); 
            if (savedDataString) { 
                processLoadedData(savedDataString); 
            } else { 
                alert('瀏覽器中沒有儲存的圖表進度。'); 
            } 
        }
        function handleSaveToFile() { 
            if (!rcaData && trackingData.length === 0 && !hasTrizMcdaData()) { alert('沒有圖表資料可儲存至檔案。'); return; } 
            const dataToSave = { diagramData: rcaData, trackingData: trackingData, trizMcdaData: trizMcdaData, counter: nodeIdCounter, zoomLevel: currentZoom }; 
            const jsonData = JSON.stringify(dataToSave, null, 2); 
            const blob = new Blob([jsonData], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `rca-plus-triz-mcda-data-${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url); 
            alert('圖表資料已準備下載。'); 
        }
        function handleLoadFromFile(event) { 
            const file = event.target.files[0]; 
            if (file) { 
                if (file.type === "application/json") { 
                    const reader = new FileReader(); 
                    reader.onload = (e) => { 
                        const fileContent = e.target.result; 
                        processLoadedData(fileContent); 
                        loadBackupInput.value = ''; 
                    }; 
                    reader.onerror = (e) => { 
                        alert('讀取檔案時發生錯誤。'); 
                        console.error("FileReader error:", e); 
                        loadBackupInput.value = ''; 
                    }; 
                    reader.readAsText(file); 
                } else { 
                    alert('載入失敗：請選擇一個有效的 .json 檔案。'); 
                    loadBackupInput.value = ''; 
                } 
            } 
        }
        function recalculateNodeIdCounter(currentData) { 
            let maxId = 0; 
            function findMaxIdRecursive(node) { 
                if (!node) return; 
                if (node.id && typeof node.id === 'string') { 
                    const idNum = parseInt(node.id.replace('node-', '')); 
                    if (!isNaN(idNum) && idNum > maxId) { 
                        maxId = idNum; 
                    } 
                } 
                if (node.children) { 
                    node.children.forEach(findMaxIdRecursive); 
                } 
            } 
            if (currentData) { 
                findMaxIdRecursive(currentData); 
            } 
            nodeIdCounter = maxId; 
        }
        
        function handleSetInitialProblem() { 
            const problemText = problemInput.value.trim(); 
            if (!problemText) { alert('請輸入主要負面效果！'); return; } 
            nodeIdCounter = 0; 
            rcaData = createNode(problemText, 'initial-problem', null); 
            trackingData = []; 
            trizMcdaData = initializeTrizMcdaDataObject(); 
            historyStack = []; 
            historyIndex = -1; 
            pushStateToHistory(rcaData); 
            isFinalizedView = false; 
            finalizeDiagramButton.textContent = '完成圖表'; 
            finalizeDiagramButton.classList.remove('edit-diagram'); 
            finalizeDiagramButton.classList.add('finalize-diagram'); 
            problemInputArea.style.display = 'none'; 
            diagramTitle.style.display = 'block'; 
            toolButtonsContainer.style.display = 'flex'; 
            applyZoom(1.0, true); 
            renderRcaDiagram(); 
            renderCauseEffectTable(); 
            renderSolutionTable(); 
            renderTrackingTable();
            renderTrizMcdaFromData(); 
            updateButtonStates(); 
        } 
        
        function handleToggleFinalizeView() { 
            isFinalizedView = !isFinalizedView; 
            if (isFinalizedView) { 
                finalizeDiagramButton.textContent = '編輯圖表'; 
                finalizeDiagramButton.classList.remove('finalize-diagram'); 
                finalizeDiagramButton.classList.add('edit-diagram'); 
            } else { 
                finalizeDiagramButton.textContent = '完成圖表'; 
                finalizeDiagramButton.classList.remove('edit-diagram'); 
                finalizeDiagramButton.classList.add('finalize-diagram'); 
            } 
            renderRcaDiagram(); 
            updateButtonStates(); 
        }

        // --- SVG 匯出函式 (優化版) ---
        function exportSVG(filename = 'RCA_矛盾分析圖.svg') {
            const htmlContainer = document.getElementById('rca-diagram-container');
            const svgLinesContainer = document.getElementById('svg-connector-layer');
            const scalableWrapper = document.getElementById('scalable-content-wrapper'); // 用於取得 padding

            if (!htmlContainer || !svgLinesContainer || !scalableWrapper) {
                alert('錯誤：匯出 SVG 所需的圖表元素未找到。');
                console.error('Error: Diagram elements for SVG export not found.');
                return;
            }
            if (!rcaData) {
                alert('沒有圖表資料可匯出。');
                return;
            }
            
            showLoadingSpinner();

            // 暫時移除縮放以取得原始尺寸和樣式
            const originalTransform = scalableWrapper.style.transform;
            scalableWrapper.style.transform = 'scale(1)';
            // 強制重繪以確保尺寸計算正確
            void scalableWrapper.offsetHeight; 


            // 計算 SVG 的實際內容區域尺寸 (HTML 節點容器的滾動尺寸)
            const contentWidth = htmlContainer.scrollWidth;
            const contentHeight = htmlContainer.scrollHeight;

            // 建立新的 SVG 元素
            const newSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            newSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            newSvg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
            newSvg.setAttribute('width', contentWidth);
            newSvg.setAttribute('height', contentHeight);
            newSvg.setAttribute('viewBox', `0 0 ${contentWidth} ${contentHeight}`);
             // 添加一個白色背景，避免透明背景在某些檢視器中顯示不佳
            const backgroundRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            backgroundRect.setAttribute('x', '0');
            backgroundRect.setAttribute('y', '0');
            backgroundRect.setAttribute('width', '100%'); // 使用百分比確保填滿
            backgroundRect.setAttribute('height', '100%');
            backgroundRect.setAttribute('fill', '#ffffff'); // 白色背景
            newSvg.appendChild(backgroundRect);


            // 嵌入 CSS 樣式
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const styleTag = document.createElementNS('http://www.w3.org/2000/svg', 'style');
            styleTag.setAttribute('type', 'text/css');
            
            let cssText = "";
            // 確保字體也被嵌入 (如果瀏覽器允許)
            cssText += `@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');\n`;
            
            for (const styleSheet of Array.from(document.styleSheets)) {
                try {
                    if (styleSheet.cssRules) {
                        for (const rule of Array.from(styleSheet.cssRules)) {
                            cssText += rule.cssText + "\n";
                        }
                    } else if (styleSheet.href && styleSheet.href.includes('font-awesome')) {
                         // 對於 Font Awesome CDN，嘗試手動加入基本樣式 (這是一個簡化，可能不完整)
                        cssText += `
                            .fas { font-family: 'Font Awesome 6 Free'; font-weight: 900; }
                            /* 您可能需要根據使用的圖示添加更多 Font Awesome 規則 */
                        `;
                    }
                } catch (e) {
                    console.warn("無法存取樣式表規則 (可能是CORS問題):", styleSheet.href, e);
                }
            }
            styleTag.textContent = cssText;
            defs.appendChild(styleTag);
            newSvg.appendChild(defs);

            // 嵌入 HTML 內容
            const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
            foreignObject.setAttribute('x', '0');
            foreignObject.setAttribute('y', '0');
            foreignObject.setAttribute('width', contentWidth);
            foreignObject.setAttribute('height', contentHeight);

            // 複製 HTML 容器以避免修改原始 DOM，並確保其在 foreignObject 中正確渲染
            const clonedHtmlContainer = htmlContainer.cloneNode(true);
            // 移除可能影響 foreignObject 內部渲染的絕對定位相關樣式 (如果有的話)
            // clonedHtmlContainer.style.position = 'static'; // 或 'relative'
            // clonedHtmlContainer.style.left = 'auto';
            // clonedHtmlContainer.style.top = 'auto';
            // clonedHtmlContainer.style.transform = 'none'; // 移除任何 transform

            const xhtmlDiv = document.createElementNS('http://www.w3.org/1999/xhtml', 'div');
            // 為了讓 Tailwind 等樣式能正確套用，有時需要確保 xhtmlDiv 也有基本的佈局屬性
            xhtmlDiv.setAttribute('style', 'width: 100%; height: 100%;'); 
            xhtmlDiv.appendChild(clonedHtmlContainer);
            foreignObject.appendChild(xhtmlDiv);
            newSvg.appendChild(foreignObject);

            // 嵌入 SVG 連接線 (線條的座標已經是相對於 htmlContainer 的)
            const linesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            linesGroup.setAttribute('id', 'connector-lines-group');
            Array.from(svgLinesContainer.children).forEach(childLine => {
                linesGroup.appendChild(childLine.cloneNode(true));
            });
            newSvg.appendChild(linesGroup);
            
            // 恢復原始縮放
            scalableWrapper.style.transform = originalTransform;

            // 序列化並下載
            try {
                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(newSvg);
                
                // 確保 xmlns 存在，有些瀏覽器可能不會自動加入到 clone 的元素上
                if (!svgString.match(/xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)) {
                    svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                 if (!svgString.match(/xmlns:xlink="http:\/\/www\.w3\.org\/1999\/xlink"/)) {
                    svgString = svgString.replace('<svg', '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }


                const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert(`${filename} 已準備下載。`);
            } catch (error) {
                alert(`匯出 SVG 時發生錯誤： ${error.message}`);
                console.error("Error exporting SVG:", error);
            } finally {
                hideLoadingSpinner();
            }
        }


        // --- TRIZ-MCDA 相關函數 ---
        function initializeTrizMcdaDataObject() {
            return {
                problemDescription: "",
                contradictionPhenomenon: "",
                improvingParameter: null,
                worseningParameter: null,
                suggestedPrinciples: [],
                mcdaCriteria: [],
                mcdaSolutions: [],
                mcdaBestSolution: null,
                mcdaRecommendation: ""
            };
        }

        function populateTrizParameters() {
            const parameters = [
                { id: 1, name: "1. 移動物體的重量" }, { id: 2, name: "2. 固定物體的重量" },
                { id: 3, name: "3. 移動物體的長度" }, { id: 4, name: "4. 固定物體的長度" },
                { id: 5, name: "5. 移動物體的面積" }, { id: 6, name: "6. 固定物體的面積" },
                { id: 7, name: "7. 移動物體的體積" }, { id: 8, name: "8. 固定物體的體積" },
                { id: 9, name: "9. 速度" }, { id: 10, name: "10. 力" },
                { id: 11, name: "11. 應力或壓力" }, { id: 12, name: "12. 形狀" },
                { id: 13, name: "13. 物體組成的穩定性" }, { id: 14, name: "14. 強度" },
                { id: 15, name: "15. 移動物體的作用時間" }, { id: 16, name: "16. 固定物體的作用時間" },
                { id: 17, name: "17. 溫度" }, { id: 18, name: "18. 照明強度" },
                { id: 19, name: "19. 移動物體的能量消耗" }, { id: 20, name: "20. 固定物體的能量消耗" },
                { id: 21, name: "21. 功率" }, { id: 22, name: "22. 能量損失" },
                { id: 23, name: "23. 物質損失" }, { id: 24, name: "24. 資訊損失" },
                { id: 25, name: "25. 時間損失" }, { id: 26, name: "26. 物質數量" },
                { id: 27, name: "27. 可靠性" }, { id: 28, name: "28. 量測精度" },
                { id: 29, name: "29. 製造精度" }, { id: 30, name: "30. 物體相關的有害因素" },
                { id: 31, name: "31. 物體產生的有害因素" }, { id: 32, name: "32. 製造容易度" },
                { id: 33, name: "33. 操作容易度" }, { id: 34, name: "34. 維修容易度" },
                { id: 35, name: "35. 適應性或通用性" }, { id: 36, name: "36. 裝置複雜性" },
                { id: 37, name: "37. 偵測與量測的困難度" }, { id: 38, name: "38. 自動化程度" },
                { id: 39, name: "39. 生產率" }
            ];
            parameters.forEach(param => {
                TRIZ_PARAMETERS.push(param); 
                const option1 = new Option(param.name, param.id);
                const option2 = new Option(param.name, param.id);
                trizImprovingParameterSelect.add(option1);
                trizWorseningParameterSelect.add(option2);
            });

            const principles = [
                "1. 分割", "2. 取出", "3. 局部品質", "4. 不對稱", "5. 合併", "6. 通用性", "7. 套疊", "8. 反作用力（配重）",
                "9. 預先反作用", "10. 預先作用", "11. 事先防範", "12. 等勢能", "13. 反向作用", "14. 曲面化", "15. 動態化",
                "16. 不足或超額作用", "17. 維度變更", "18. 機械振動", "19. 週期性作用", "20. 連續有用作用", "21. 快速通過",
                "22. 轉害為利", "23. 回饋", "24. 中介物", "25. 自助服務", "26. 複製", "27. 廉價替代品", "28. 機械系統替代",
                "29. 氣壓與液壓", "30. 可撓性殼膜", "31. 多孔材料", "32. 改變顏色", "33. 同質性", "34. 拋棄與再生",
                "35. 參數改變", "36. 相態轉換", "37. 熱膨脹", "38. 強氧化劑", "39. 惰性環境", "40. 複合材料"
            ];
            principles.forEach((name, index) => {
                TRIZ_PRINCIPLES[index + 1] = name;
            });
        }

        function initializeTrizMatrix() {
            TRIZ_CONTRADICTION_MATRIX[1] = { 2: [1,40,27,3], 14: [1,40,27,3] }; 
            TRIZ_CONTRADICTION_MATRIX[2] = { 1: [1,40,27,3], 14: [1,40,27,3] }; 
            TRIZ_CONTRADICTION_MATRIX[9] = { 1: [15,1,28,35], 2: [15,1,28,35], 14: [10,15,40,1], 19:[15,18,10,35], 21:[10,15,18,35] }; 
            TRIZ_CONTRADICTION_MATRIX[14] = { 1: [1,40,27,3], 2: [1,40,27,3], 9: [10,15,40,1] }; 
            TRIZ_CONTRADICTION_MATRIX[17] = { 13:[35,2,19,37], 14:[35,1,19,13] }; 
            TRIZ_CONTRADICTION_MATRIX[19] = { 9:[10,18,15,35], 21:[10,15,18,35]}; 
            TRIZ_CONTRADICTION_MATRIX[21] = { 9:[10,18,15,35], 19:[10,15,18,35]}; 
        }
        
        function handleToggleTrizMcdaSection() {
            const isHidden = trizMcdaSection.style.display === 'none';
            trizMcdaSection.style.display = isHidden ? 'block' : 'none';
            toggleTrizMcdaButton.innerHTML = isHidden ? '<i class="fas fa-times mr-1"></i> 關閉 TRIZ-MCDA' : '<i class="fas fa-lightbulb mr-1"></i> TRIZ-MCDA 分析';
            if (isHidden) {
                renderMcdaEvaluationTableHeaders();
                renderMcdaSolutionsForEvaluation(); 
            }
        }

        function handleTrizGeneratePrinciples() {
            const improvingParamId = parseInt(trizImprovingParameterSelect.value);
            const worseningParamId = parseInt(trizWorseningParameterSelect.value);

            if (!improvingParamId || !worseningParamId) {
                alert("請選擇改善參數和惡化參數。");
                return;
            }
            if (improvingParamId === worseningParamId) {
                alert("改善參數和惡化參數不能相同。");
                return;
            }

            const principlesIds = (TRIZ_CONTRADICTION_MATRIX[improvingParamId] && TRIZ_CONTRADICTION_MATRIX[improvingParamId][worseningParamId]) || [];
            
            trizMcdaData.improvingParameter = improvingParamId;
            trizMcdaData.worseningParameter = worseningParamId;
            const newSuggestedPrinciples = principlesIds.slice(0, 4).map(pId => {
                const existingPrinciple = trizMcdaData.suggestedPrinciples.find(sp => sp.id === pId);
                return {
                    id: pId,
                    name: TRIZ_PRINCIPLES[pId] || `原理 ${pId}`,
                    concepts: existingPrinciple ? existingPrinciple.concepts : [""] 
                };
            });
            trizMcdaData.suggestedPrinciples = newSuggestedPrinciples;
            
            renderTrizPrinciplesOutput();
            updateMcdaSolutionsFromTriz(); 
        }

        function renderTrizPrinciplesOutput() {
            trizPrinciplesOutput.innerHTML = '';
            if (trizMcdaData.suggestedPrinciples.length === 0) {
                trizPrinciplesOutput.innerHTML = '<p class="text-gray-500">未找到匹配的發明原理，或此組合無建議原理。請嘗試其他參數組合。</p>';
                return;
            }

            trizMcdaData.suggestedPrinciples.forEach((principle, pIndex) => {
                const div = document.createElement('div');
                div.classList.add('mb-4', 'p-3', 'border', 'border-gray-200', 'rounded-md');
                div.innerHTML = `<h5 class="font-semibold text-indigo-700">${principle.name} (原理 #${principle.id})</h5>`;
                
                principle.concepts.forEach((concept, cIndex) => {
                    const conceptDiv = document.createElement('div');
                    conceptDiv.classList.add('triz-solution-concept', 'ml-4', 'mb-2');
                    const label = document.createElement('label');
                    label.textContent = `方案雛形 ${pIndex+1}-${cIndex+1}：`;
                    label.classList.add('block', 'text-sm', 'font-medium', 'text-gray-600', 'mb-1');
                    const textarea = document.createElement('textarea');
                    textarea.classList.add('input-field', 'w-full');
                    textarea.rows = 2;
                    textarea.placeholder = `基於「${principle.name}」的方案描述...`;
                    textarea.value = concept;
                    textarea.dataset.principleId = principle.id; 
                    textarea.dataset.conceptIndex = cIndex;      
                    textarea.oninput = (e) => { 
                        trizMcdaData.suggestedPrinciples[pIndex].concepts[cIndex] = e.target.value;
                        updateMcdaSolutionsFromTriz(); 
                    };
                    conceptDiv.appendChild(label);
                    conceptDiv.appendChild(textarea);
                    div.appendChild(conceptDiv);
                });
                const addConceptButton = document.createElement('button');
                addConceptButton.textContent = '新增此原理的方案雛形';
                addConceptButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'text-xs', 'py-1', 'px-2', 'rounded', 'mt-1', 'ml-4');
                addConceptButton.onclick = () => {
                    trizMcdaData.suggestedPrinciples[pIndex].concepts.push("");
                    renderTrizPrinciplesOutput(); 
                    updateMcdaSolutionsFromTriz();
                };
                div.appendChild(addConceptButton);
                trizPrinciplesOutput.appendChild(div);
            });
        }
        
        function updateMcdaSolutionsFromTriz() {
            const newMcdaSolutions = [];
            trizMcdaData.suggestedPrinciples.forEach(principle => {
                principle.concepts.forEach((conceptText, conceptIndex) => {
                    if (conceptText.trim() !== "") { 
                        const solutionId = `${principle.id}-${conceptIndex}`;
                        const existingSolution = trizMcdaData.mcdaSolutions.find(s => s.id === solutionId);
                        newMcdaSolutions.push({
                            id: solutionId,
                            principleId: principle.id,
                            principleName: principle.name,
                            conceptIndex: conceptIndex,
                            conceptText: conceptText,
                            scores: existingSolution ? existingSolution.scores : {},
                            weightedScore: existingSolution ? existingSolution.weightedScore : 0
                        });
                    }
                });
            });
            trizMcdaData.mcdaSolutions = newMcdaSolutions;
            renderMcdaEvaluationTableHeaders(); 
            renderMcdaSolutionsForEvaluation(); 
        }


        function handleMcdaAddCriterion() {
            const criterionId = `crit-${Date.now()}`;
            trizMcdaData.mcdaCriteria.push({ id: criterionId, name: "", weight: 0 });
            renderMcdaCriteriaInputs();
            renderMcdaEvaluationTableHeaders(); 
        }

        function renderMcdaCriteriaInputs() {
            mcdaCriteriaInputArea.innerHTML = '';
            trizMcdaData.mcdaCriteria.forEach((criterion, index) => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'gap-2', 'mb-2');
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = criterion.name;
                nameInput.placeholder = `標準 ${index + 1} 名稱`;
                nameInput.classList.add('input-field', 'flex-grow');
                nameInput.onchange = (e) => {
                    criterion.name = e.target.value;
                    renderMcdaEvaluationTableHeaders(); 
                };

                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.value = criterion.weight;
                weightInput.min = 0;
                weightInput.max = 100;
                weightInput.placeholder = '權重 %';
                weightInput.classList.add('input-field', 'w-24', 'text-right');
                weightInput.onchange = (e) => criterion.weight = parseInt(e.target.value) || 0;

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '<i class="fas fa-times text-red-500"></i>';
                removeButton.classList.add('p-1', 'hover:bg-red-100', 'rounded');
                removeButton.onclick = () => {
                    trizMcdaData.mcdaCriteria.splice(index, 1);
                    renderMcdaCriteriaInputs();
                    renderMcdaEvaluationTableHeaders(); 
                    renderMcdaSolutionsForEvaluation(); 
                };

                div.appendChild(nameInput);
                div.appendChild(weightInput);
                div.appendChild(removeButton);
                mcdaCriteriaInputArea.appendChild(div);
            });
        }
        
        function calculateAndDisplayTotalWeight() {
            const totalWeight = trizMcdaData.mcdaCriteria.reduce((sum, crit) => sum + (crit.weight || 0), 0);
            mcdaTotalWeightDisplay.textContent = `目前總權重: ${totalWeight}%`;
            if (totalWeight !== 100 && trizMcdaData.mcdaCriteria.length > 0) {
                mcdaTotalWeightDisplay.classList.add('text-red-500');
                mcdaTotalWeightDisplay.classList.remove('text-green-500');
                 alert(`提醒：目前評估標準的總權重為 ${totalWeight}%，建議調整至 100%。`);
            } else if (totalWeight === 100) {
                 mcdaTotalWeightDisplay.classList.remove('text-red-500');
                 mcdaTotalWeightDisplay.classList.add('text-green-500');
            } else {
                mcdaTotalWeightDisplay.classList.remove('text-red-500', 'text-green-500');
            }
        }


        function renderMcdaEvaluationTableHeaders() {
            const tableHead = mcdaEvaluationTable.querySelector('thead');
            if (!tableHead) return;
            tableHead.innerHTML = ''; 
            const headerRow = tableHead.insertRow();
            
            let th = document.createElement('th');
            th.textContent = '方案雛形';
            headerRow.appendChild(th);

            trizMcdaData.mcdaCriteria.forEach(criterion => {
                th = document.createElement('th');
                th.textContent = `${criterion.name || '未命名標準'} (${criterion.weight || 0}%)`;
                headerRow.appendChild(th);
            });

            th = document.createElement('th');
            th.textContent = '加權總分';
            headerRow.appendChild(th);
        }
        
        function renderMcdaSolutionsForEvaluation() {
            const tableBody = mcdaEvaluationTable.querySelector('tbody');
            if (!tableBody) return;
            tableBody.innerHTML = ''; 

            if (trizMcdaData.mcdaSolutions.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = trizMcdaData.mcdaCriteria.length + 2; 
                cell.textContent = "請先在階段二生成方案雛形，並在上方設定評估標準。";
                cell.classList.add("text-center", "text-gray-500", "py-4");
                return;
            }

            trizMcdaData.mcdaSolutions.forEach(solution => {
                const row = tableBody.insertRow();
                let cell = row.insertCell();
                cell.textContent = `${solution.principleName} - 方案 ${solution.conceptIndex + 1}: ${solution.conceptText.substring(0,30)}...`;
                cell.title = solution.conceptText;

                trizMcdaData.mcdaCriteria.forEach(criterion => {
                    cell = row.insertCell();
                    const scoreInput = document.createElement('input');
                    scoreInput.type = 'number';
                    scoreInput.min = 0; 
                    scoreInput.max = 10; 
                    scoreInput.classList.add('input-field', 'w-16', 'text-center');
                    scoreInput.value = solution.scores[criterion.id] || '';
                    scoreInput.onchange = (e) => {
                        solution.scores[criterion.id] = parseFloat(e.target.value) || 0;
                    };
                    cell.appendChild(scoreInput);
                });
                
                cell = row.insertCell();
                cell.textContent = solution.weightedScore.toFixed(2); 
                cell.id = `score-${solution.id}`; 
            });
        }


        function handleMcdaCalculateScores() {
            const totalWeight = trizMcdaData.mcdaCriteria.reduce((sum, crit) => sum + (crit.weight || 0), 0);
            if (totalWeight !== 100 && trizMcdaData.mcdaCriteria.length > 0) {
                alert(`警告：評估標準的總權重為 ${totalWeight}%，並非 100%。計算結果可能不符合預期。`);
            }
            if (trizMcdaData.mcdaSolutions.length === 0) {
                alert("請先定義方案雛形並設定評估標準。");
                return;
            }

            trizMcdaData.mcdaSolutions.forEach(solution => {
                solution.weightedScore = 0;
                trizMcdaData.mcdaCriteria.forEach(criterion => {
                    const score = solution.scores[criterion.id] || 0;
                    solution.weightedScore += score * (criterion.weight / 100);
                });
                const scoreCell = document.getElementById(`score-${solution.id}`);
                if (scoreCell) {
                    scoreCell.textContent = solution.weightedScore.toFixed(2);
                }
            });

            if (trizMcdaData.mcdaSolutions.length > 0) {
                trizMcdaData.mcdaSolutions.sort((a, b) => b.weightedScore - a.weightedScore);
                trizMcdaData.mcdaBestSolution = trizMcdaData.mcdaSolutions[0];
                mcdaBestSolutionText.textContent = `最佳方案推薦：${trizMcdaData.mcdaBestSolution.principleName} - 方案 ${trizMcdaData.mcdaBestSolution.conceptIndex + 1} (${trizMcdaData.mcdaBestSolution.conceptText.substring(0,30)}...)，總分：${trizMcdaData.mcdaBestSolution.weightedScore.toFixed(2)}`;
                
                mcdaRecommendationReasonText.value = ""; 
                trizMcdaData.mcdaRecommendation = ""; 
                mcdaResultOutput.style.display = 'block';
            } else {
                 mcdaBestSolutionText.textContent = `沒有可評估的方案。`;
                 mcdaRecommendationReasonText.value = "";
                 mcdaResultOutput.style.display = 'block';
            }
        }
        
        function saveTrizMcdaProgress() {
            trizMcdaData.problemDescription = trizProblemDescriptionInput.value;
            trizMcdaData.contradictionPhenomenon = trizContradictionPhenomenonInput.value;
            trizMcdaData.mcdaRecommendation = mcdaRecommendationReasonText.value; 
            handleSaveToLocalStorage(); 
            alert("TRIZ-MCDA 分析進度已儲存。");
        }

        function loadTrizMcdaDataFromLocalStorage() {
            const savedDataString = localStorage.getItem('rcaPlusData');
            if (savedDataString) {
                const parsedJson = JSON.parse(savedDataString);
                if (parsedJson && parsedJson.trizMcdaData) {
                    trizMcdaData = { ...initializeTrizMcdaDataObject(), ...parsedJson.trizMcdaData }; 
                    renderTrizMcdaFromData();
                }
            }
        }
        
        function renderTrizMcdaFromData() {
            trizProblemDescriptionInput.value = trizMcdaData.problemDescription || "";
            trizContradictionPhenomenonInput.value = trizMcdaData.contradictionPhenomenon || "";
            if (trizMcdaData.improvingParameter) trizImprovingParameterSelect.value = trizMcdaData.improvingParameter;
            if (trizMcdaData.worseningParameter) trizWorseningParameterSelect.value = trizMcdaData.worseningParameter;
            
            renderTrizPrinciplesOutput(); 
            renderMcdaCriteriaInputs(); 
            renderMcdaEvaluationTableHeaders();
            renderMcdaSolutionsForEvaluation(); 

            if (trizMcdaData.mcdaBestSolution && trizMcdaData.mcdaSolutions.length > 0) { 
                mcdaBestSolutionText.textContent = `最佳方案推薦：${trizMcdaData.mcdaBestSolution.principleName} - 方案 ${trizMcdaData.mcdaBestSolution.conceptIndex + 1} (${trizMcdaData.mcdaBestSolution.conceptText.substring(0,30)}...)，總分：${trizMcdaData.mcdaBestSolution.weightedScore.toFixed(2)}`;
                mcdaRecommendationReasonText.value = trizMcdaData.mcdaRecommendation || ""; 
                mcdaResultOutput.style.display = 'block';
            } else {
                mcdaResultOutput.style.display = 'none';
                mcdaBestSolutionText.textContent = "";
                mcdaRecommendationReasonText.value = "";
            }
            calculateAndDisplayTotalWeight(); 
        }
        
        function handleShowCauseEffectTable() {
            causeEffectTableSection.style.display = 'block';
            solutionTableSection.style.display = 'none'; 
            trackingTableSection.style.display = 'none';
            trizMcdaSection.style.display = 'none'; 
            renderCauseEffectTable();
            updateButtonStates();
        }
        function handleShowSolutionTable() {
            solutionTableSection.style.display = 'block';
            causeEffectTableSection.style.display = 'none'; 
            trackingTableSection.style.display = 'none';
            trizMcdaSection.style.display = 'none'; 
            renderSolutionTable();
            updateButtonStates();
        }
        function handleShowTrackingTable() { 
            trackingTableSection.style.display = 'block';
            causeEffectTableSection.style.display = 'none'; 
            solutionTableSection.style.display = 'none';
            trizMcdaSection.style.display = 'none'; 
            renderTrackingTable();
            updateButtonStates();
        }
        function handleHideAllTables() {
            causeEffectTableSection.style.display = 'none';
            solutionTableSection.style.display = 'none';
            trackingTableSection.style.display = 'none';
            updateButtonStates();
        }
        
        function createNode(text, type, parentId, isNonChangeable = false) { 
            nodeIdCounter++; 
            const node = { 
                id: `node-${nodeIdCounter}`, 
                text: text, 
                type: type, 
                parentId: parentId, 
                children: [], 
                andSourceNodeIds: [], 
                effectParameters: [], 
                inventivePrinciples: [] 
            }; 
            if (type === 'cause') node.isNonChangeable = isNonChangeable; 
            return node; 
        }
        
        function renderRcaDiagram() { 
            diagramContainer.innerHTML = ''; 
            if (rcaData) { 
                diagramContainer.appendChild(createNodeElement(rcaData)); 
            } 
            requestAnimationFrame(() => drawAllSvgConnectors()); 
        }
        function createNodeElement(nodeData) { 
            const nodeWrapper = document.createElement('div'); 
            nodeWrapper.classList.add('rca-node-wrapper'); 
            const nodeDiv = document.createElement('div'); 
            nodeDiv.classList.add('rca-node', `rca-node-${nodeData.type}`); 
            nodeDiv.id = nodeData.id; 
            nodeDiv.dataset.nodeId = nodeData.id; 
            
            const contentDiv = document.createElement('div'); 
            contentDiv.classList.add('rca-node-content'); 
            
            const headerDiv = document.createElement('div'); 
            headerDiv.classList.add('rca-node-header'); 
            
            const textSpan = document.createElement('span'); 
            textSpan.classList.add('rca-node-text'); 
            textSpan.textContent = nodeData.text; 
            headerDiv.appendChild(textSpan); 

            if (nodeData.type === 'cause' && nodeData.isNonChangeable) { 
                const ncBadge = document.createElement('span'); 
                ncBadge.classList.add('nc-badge'); 
                ncBadge.textContent = 'NC'; 
                headerDiv.appendChild(ncBadge); 
            } 
            
            const iconSpan = document.createElement('span'); 
            iconSpan.classList.add('rca-node-icon'); 
            let iconShouldBeDisplayed = true;
            let isContradictory = false;

            if (nodeData.type === 'initial-problem') iconSpan.textContent = '(-)'; 
            else if (nodeData.type === 'cause') { 
                const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(nodeData); 
                if (hasPositiveChild && hasNegativeChild) { 
                    iconSpan.textContent = '+/-'; 
                    iconSpan.classList.add('contradictory'); 
                    isContradictory = true;
                } else { 
                    iconShouldBeDisplayed = false; 
                } 
            } else if (nodeData.type === 'positive-effect') iconSpan.textContent = '(+)'; 
            else if (nodeData.type === 'negative-effect') iconSpan.textContent = '(-)'; 
            else { 
                iconShouldBeDisplayed = false; 
            } 

            if (iconShouldBeDisplayed) {
                iconSpan.style.display = 'flex';
                headerDiv.appendChild(iconSpan); 
            }
            
            contentDiv.appendChild(headerDiv); 

            if (nodeData.effectParameters && nodeData.effectParameters.length > 0) { 
                const paramsDiv = document.createElement('div'); 
                paramsDiv.classList.add('selected-items-list'); 
                paramsDiv.innerHTML = `<strong>效果參數:</strong> <ul>${nodeData.effectParameters.map(p => `<li>${p}</li>`).join('')}</ul>`; 
                contentDiv.appendChild(paramsDiv); 
            } 
            if (nodeData.inventivePrinciples && nodeData.inventivePrinciples.length > 0) { 
                const principlesDiv = document.createElement('div'); 
                principlesDiv.classList.add('selected-items-list'); 
                let principlesHtml = '<strong>發明原理:</strong> <ul>'; 
                nodeData.inventivePrinciples.forEach(ip => { 
                    principlesHtml += `<li>${ip.name}${ip.solution ? `<span class="solution-text">- ${ip.solution.substring(0, 20)}${ip.solution.length > 20 ? '...' : ''}</span>` : ''}</li>`; 
                }); 
                principlesHtml += '</ul>'; 
                principlesDiv.innerHTML = principlesHtml; 
                contentDiv.appendChild(principlesDiv); 
            } 
            
            if (!isFinalizedView) { 
                const actionsDiv = document.createElement('div'); 
                actionsDiv.classList.add('rca-node-actions'); 
                actionsDiv.appendChild(createActionButton('修訂此項', 'edit-node', () => promptEditNode(nodeData.id, contentDiv))); 
                if (nodeData.type === 'initial-problem') { 
                    actionsDiv.appendChild(createActionButton('新增原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入原因描述'))); 
                } else if (nodeData.type === 'cause') { 
                    actionsDiv.appendChild(createActionButton('新增子原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入子原因描述'))); 
                    actionsDiv.appendChild(createActionButton('(+) 正面效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入此原因帶來的正面效果'))); 
                    actionsDiv.appendChild(createActionButton('(-) 負面效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入此原因導致的負面效果'))); 
                    const ncButtonText = nodeData.isNonChangeable ? '取消NC標記' : '設為NC'; 
                    actionsDiv.appendChild(createActionButton(ncButtonText, 'toggle-nc', () => toggleNonChangeable(nodeData.id))); 
                    actionsDiv.appendChild(createActionButton('選擇發明原理', 'set-principles', () => openInventivePrincipleModal(nodeData.id, isContradictory))); 
                    if (nodeData.parentId) { 
                        actionsDiv.appendChild(createActionButton('移除此原因', 'remove-button', () => removeNode(nodeData.id))); 
                    } 
                } else if (nodeData.type === 'positive-effect' || nodeData.type === 'negative-effect') { 
                    actionsDiv.appendChild(createActionButton('(+) 新增正面子效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入正面子效果描述'))); 
                    actionsDiv.appendChild(createActionButton('(-) 新增負面子效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入負面子效果描述'))); 
                    actionsDiv.appendChild(createActionButton('設定效果參數', 'set-parameters', () => openEffectParameterModal(nodeData.id))); 
                    actionsDiv.appendChild(createActionButton('設定AND輸入源', 'set-and-sources', () => openAndSourceModal(nodeData.id))); 
                    actionsDiv.appendChild(createActionButton('移除效果', 'remove-button', () => removeNode(nodeData.id))); 
                } 
                contentDiv.appendChild(actionsDiv); 
                const inputContainer = document.createElement('div'); 
                inputContainer.classList.add('input-group-container'); 
                contentDiv.appendChild(inputContainer); 
            } 
            nodeDiv.appendChild(contentDiv); 
            nodeWrapper.appendChild(nodeDiv); 
            if (nodeData.children && nodeData.children.length > 0) { 
                const childrenContainer = document.createElement('div'); 
                childrenContainer.classList.add('rca-children-container'); 
                nodeData.children.forEach(childNode => childrenContainer.appendChild(createNodeElement(childNode))); 
                nodeWrapper.appendChild(childrenContainer); 
            } 
            return nodeWrapper; 
        }
        
        function promptEditNode(nodeId, parentNodeContentDiv) { 
            if (isFinalizedView) return; 
            const nodeToEdit = findNodeById(rcaData, nodeId); 
            if (!nodeToEdit) return; 
            const inputContainer = parentNodeContentDiv.querySelector('.input-group-container'); 
            if (!inputContainer) { console.error("找不到節點的輸入容器:", nodeId); return; } 
            document.querySelectorAll('.input-group').forEach(ig => ig.remove()); 
            inputContainer.innerHTML = ''; 
            const inputGroup = document.createElement('div'); 
            inputGroup.classList.add('input-group'); 
            const nodeInput = document.createElement('input'); 
            nodeInput.type = 'text'; 
            nodeInput.value = nodeToEdit.text; 
            nodeInput.classList.add('input-field'); 
            const saveEditButton = document.createElement('button'); 
            saveEditButton.textContent = '儲存修訂'; 
            saveEditButton.classList.add('action-button', 'save-edit-button', 'w-full', 'mt-2'); 
            saveEditButton.onclick = () => { 
                const newText = nodeInput.value.trim(); 
                if (newText) { 
                    nodeToEdit.text = newText; 
                    pushStateToHistory(rcaData); 
                    renderRcaDiagram(); 
                    renderCauseEffectTable(); 
                    renderSolutionTable(); 
                    inputContainer.innerHTML = ''; 
                } else { alert('描述不能為空！'); } 
            }; 
            nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveEditButton.click(); }); 
            const cancelEditButton = document.createElement('button'); 
            cancelEditButton.textContent = '取消修訂'; 
            cancelEditButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1'); 
            cancelEditButton.onclick = () => { inputContainer.innerHTML = ''; }; 
            inputGroup.appendChild(nodeInput); 
            inputGroup.appendChild(saveEditButton); 
            inputGroup.appendChild(cancelEditButton); 
            inputContainer.appendChild(inputGroup); 
            nodeInput.focus(); 
            nodeInput.select(); 
        }
        function handleSaveAndSources() { 
            if (!currentAndTargetNodeId) return; 
            const targetNode = findNodeById(rcaData, currentAndTargetNodeId); 
            if (!targetNode) return; 
            const selectedSourceIds = []; 
            const checkboxes = andSourceOptionsContainer.querySelectorAll('input[type="checkbox"]:checked'); 
            checkboxes.forEach(chk => selectedSourceIds.push(chk.value)); 
            targetNode.andSourceNodeIds = selectedSourceIds; 
            pushStateToHistory(rcaData); 
            andSourceModal.style.display = 'none'; 
            currentAndTargetNodeId = null; 
            renderRcaDiagram(); 
        }
        function openAndSourceModal(targetNodeId) { 
            if (isFinalizedView) return; 
            currentAndTargetNodeId = targetNodeId; 
            const targetNode = findNodeById(rcaData, targetNodeId); 
            if (!targetNode) return; 
            andSourceModalTitle.textContent = `為效果 "${targetNode.text}" 設定 AND 輸入源`; 
            andSourceOptionsContainer.innerHTML = ''; 
            const availableCauses = []; 
            function findCausesRecursive(node) { 
                if (!node) return; 
                if (node.type === 'cause') availableCauses.push(node); 
                if (node.children) node.children.forEach(findCausesRecursive); 
            } 
            if (rcaData) findCausesRecursive(rcaData); 
            if (availableCauses.length === 0) { 
                andSourceOptionsContainer.innerHTML = '<p class="text-gray-500 text-center">圖表中尚無可用的原因節點。</p>'; 
            } else { 
                availableCauses.forEach(causeNode => { 
                    if (causeNode.id === targetNode.id || isDescendant(targetNode, causeNode.id) || causeNode.id === targetNode.parentId) return; 
                    const div = document.createElement('div'); 
                    div.classList.add('flex', 'items-center', 'my-2', 'p-2', 'hover:bg-gray-100', 'rounded'); 
                    const checkbox = document.createElement('input'); 
                    checkbox.type = 'checkbox'; 
                    checkbox.id = `and-source-chk-${causeNode.id}`; 
                    checkbox.value = causeNode.id; 
                    checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded', 'border-gray-300'); 
                    if (targetNode.andSourceNodeIds && targetNode.andSourceNodeIds.includes(causeNode.id)) { 
                        checkbox.checked = true; 
                    } 
                    const label = document.createElement('label'); 
                    label.htmlFor = `and-source-chk-${causeNode.id}`; 
                    label.textContent = `${causeNode.text} (ID: ${causeNode.id.split('-')[1]})`; 
                    label.classList.add('ml-3', 'text-sm', 'text-gray-700', 'flex-grow'); 
                    div.appendChild(checkbox); 
                    div.appendChild(label); 
                    andSourceOptionsContainer.appendChild(div); 
                }); 
                if (andSourceOptionsContainer.childElementCount === 0) { 
                    andSourceOptionsContainer.innerHTML = '<p class="text-gray-500 text-center">無有效的 AND 輸入源選項。</p>'; 
                } 
            } 
            andSourceModal.style.display = 'flex'; 
        }
        function isDescendant(parentNode, childNodeIdToFind) { 
            if (!parentNode || !parentNode.children || parentNode.children.length === 0) return false; 
            for (const child of parentNode.children) { 
                if (child.id === childNodeIdToFind) return true; 
                if (isDescendant(child, childNodeIdToFind)) return true; 
            } 
            return false; 
        }
        function handleSaveEffectParameters() { 
            if (!currentParameterTargetNodeId) return; 
            const targetNode = findNodeById(rcaData, currentParameterTargetNodeId); 
            if (!targetNode) return; 
            const selectedParameters = []; 
            const checkboxes = effectParameterOptionsContainer.querySelectorAll('input[type="checkbox"]:checked'); 
            checkboxes.forEach(chk => selectedParameters.push(chk.value)); 
            targetNode.effectParameters = selectedParameters; 
            pushStateToHistory(rcaData); 
            effectParameterModal.style.display = 'none'; 
            currentParameterTargetNodeId = null; 
            renderRcaDiagram(); 
        }
        function openEffectParameterModal(targetNodeId) { 
            if (isFinalizedView) return; 
            currentParameterTargetNodeId = targetNodeId; 
            const targetNode = findNodeById(rcaData, targetNodeId); 
            if (!targetNode || (targetNode.type !== 'positive-effect' && targetNode.type !== 'negative-effect')) return; 
            effectParameterModalTitle.textContent = `為效果 "${targetNode.text}" 設定效果參數`; 
            effectParameterOptionsContainer.innerHTML = ''; 
            Object.keys(EFFECT_PARAMETERS).forEach(category => { 
                const categoryTitle = document.createElement('h4'); 
                categoryTitle.textContent = category; 
                effectParameterOptionsContainer.appendChild(categoryTitle); 
                EFFECT_PARAMETERS[category].forEach(param => { 
                    const div = document.createElement('div'); 
                    div.classList.add('flex', 'items-center', 'my-1', 'p-1', 'hover:bg-gray-50', 'rounded'); 
                    const checkbox = document.createElement('input'); 
                    checkbox.type = 'checkbox'; 
                    checkbox.id = `param-chk-${param.replace(/\s|\/|[\(\)]/g, '-')}`; 
                    checkbox.value = param; 
                    checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-sky-600', 'rounded', 'border-gray-300', 'focus:ring-sky-500'); 
                    if (targetNode.effectParameters && targetNode.effectParameters.includes(param)) { 
                        checkbox.checked = true; 
                    } 
                    const label = document.createElement('label'); 
                    label.htmlFor = checkbox.id; 
                    label.textContent = param; 
                    label.classList.add('ml-2', 'text-sm', 'text-gray-700'); 
                    div.appendChild(checkbox); 
                    div.appendChild(label); 
                    effectParameterOptionsContainer.appendChild(div); 
                }); 
            }); 
            effectParameterModal.style.display = 'flex'; 
        }
        function handleSaveInventivePrinciples() { 
            if (!currentPrincipleTargetNodeId) return; 
            const targetNode = findNodeById(rcaData, currentPrincipleTargetNodeId); 
            if (!targetNode) return; 
            const selectedPrinciples = []; 
            const principleCheckboxes = inventivePrincipleOptionsContainer.querySelectorAll('input[type="checkbox"]');
            principleCheckboxes.forEach(chk => {
                if (chk.checked) {
                    const principleName = chk.value;
                    const solutionInput = chk.closest('.my-2').querySelector('input[type="text"][data-principle-name]');
                    selectedPrinciples.push({ 
                        name: principleName, 
                        solution: solutionInput ? solutionInput.value.trim() : '' 
                    });
                }
            });
            targetNode.inventivePrinciples = selectedPrinciples; 
            pushStateToHistory(rcaData); 
            inventivePrincipleModal.style.display = 'none'; 
            currentPrincipleTargetNodeId = null; 
            renderRcaDiagram(); 
            renderSolutionTable(); 
        }
        function openInventivePrincipleModal(targetNodeId, isContradictoryCause) { 
            if (isFinalizedView) return; 
            currentPrincipleTargetNodeId = targetNodeId; 
            const targetNode = findNodeById(rcaData, targetNodeId); 
            if (!targetNode || targetNode.type !== 'cause') return; 
            
            inventivePrincipleModalTitle.textContent = `為原因 "${targetNode.text}" 選擇發明原理與改善方案`; 
            inventivePrincipleOptionsContainer.innerHTML = ''; 
            INVENTIVE_PRINCIPLES.forEach(principleName => { 
                const principleContainer = document.createElement('div'); 
                principleContainer.classList.add('my-2', 'p-2', 'border-b', 'border-gray-200'); 
                const div = document.createElement('div'); 
                div.classList.add('flex', 'items-center'); 
                const checkbox = document.createElement('input'); 
                checkbox.type = 'checkbox'; 
                const checkboxId = `principle-chk-${principleName.replace(/\s|\/|[\(\)\[\]]/g, '-')}`; 
                checkbox.id = checkboxId; 
                checkbox.value = principleName; 
                checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-pink-600', 'rounded', 'border-gray-300', 'focus:ring-pink-500'); 
                const existingPrinciple = targetNode.inventivePrinciples.find(p => p.name === principleName); 
                if (existingPrinciple) { 
                    checkbox.checked = true; 
                } 
                const label = document.createElement('label'); 
                label.htmlFor = checkboxId; 
                label.textContent = principleName; 
                label.classList.add('ml-2', 'text-sm', 'text-gray-700', 'font-medium'); 
                div.appendChild(checkbox); 
                div.appendChild(label); 
                principleContainer.appendChild(div); 
                const solutionInput = document.createElement('input'); 
                solutionInput.type = 'text'; 
                solutionInput.placeholder = '輸入此原理的改善方案...'; 
                solutionInput.dataset.principleName = principleName; 
                solutionInput.classList.add('principle-solution-input', 'input-field', 'mt-1'); 
                solutionInput.value = existingPrinciple && existingPrinciple.solution ? existingPrinciple.solution : ''; 
                solutionInput.style.display = checkbox.checked ? 'block' : 'none'; 
                checkbox.onchange = () => { 
                    solutionInput.style.display = checkbox.checked ? 'block' : 'none'; 
                    if (!checkbox.checked) solutionInput.value = ''; 
                }; 
                principleContainer.appendChild(solutionInput); 
                inventivePrincipleOptionsContainer.appendChild(principleContainer); 
            }); 
            inventivePrincipleModal.style.display = 'flex'; 
        }
        
        function drawAllSvgConnectors(
            targetSvgLayer = svgLayer, 
            targetDiagramContainer = diagramContainer, 
            targetScalableWrapper = scalableContentWrapper, 
            zoom = currentZoom
        ) { 
            targetSvgLayer.innerHTML = ''; 
            if (!rcaData || !targetDiagramContainer.querySelector(`#${rcaData.id}`) || !targetScalableWrapper) { 
                targetSvgLayer.setAttribute('width', 0); 
                targetSvgLayer.setAttribute('height', 0); 
                return; 
            } 
            
            const wrapperStyle = getComputedStyle(targetScalableWrapper);
            const wrapperPaddingLeft = parseFloat(wrapperStyle.paddingLeft) || 0;
            const wrapperPaddingTop = parseFloat(wrapperStyle.paddingTop) || 0;

            const unscaledDiagramWidth = targetDiagramContainer.scrollWidth; 
            const unscaledDiagramHeight = targetDiagramContainer.scrollHeight; 
            targetSvgLayer.setAttribute('width', unscaledDiagramWidth); 
            targetSvgLayer.setAttribute('height', unscaledDiagramHeight); 
            targetSvgLayer.setAttribute('viewBox', `0 0 ${unscaledDiagramWidth} ${unscaledDiagramHeight}`); 
            
            const lineVerticalOffset = 25; 
            const scalableWrapperRect = targetScalableWrapper.getBoundingClientRect(); 

            function drawRecursive(parentNodeData, currentContainer) { 
                const parentElement = currentContainer.querySelector(`#${parentNodeData.id}`); 
                if (!parentElement) return; 
                
                const parentRect = parentElement.getBoundingClientRect(); 
                const parentBottomCenterX_svg = (parentRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + parentRect.width / 2) / zoom; 
                const parentBottomY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + parentRect.height) / zoom; 
                const parentTopY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                const parentCenterX_svg = parentBottomCenterX_svg; 

                if (parentNodeData.andSourceNodeIds && parentNodeData.andSourceNodeIds.length > 0) { 
                    const mergePointYOffset = 40; 
                    const mergePoint_svg = { x: parentCenterX_svg, y: parentTopY_svg - mergePointYOffset }; 
                    if(mergePoint_svg.y < 0) mergePoint_svg.y = 10; 
                    _drawSvgCircle(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, 6, '#6d28d9', zoom); 
                    parentNodeData.andSourceNodeIds.forEach(sourceId => { 
                        const sourceElement = currentContainer.querySelector(`#${sourceId}`); 
                        if (sourceElement) { 
                            const sourceRect = sourceElement.getBoundingClientRect(); 
                            const sourceConnX_svg = (sourceRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + sourceRect.width / 2) / zoom; 
                            const sourceConnY_svg = (sourceRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + sourceRect.height) / zoom; 
                            if (sourceConnY_svg < mergePoint_svg.y) { 
                                _drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceConnY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom); 
                            } else { 
                                const sourceTopY_svg = (sourceRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                                _drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceTopY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom); 
                            } 
                        } 
                    }); 
                    if (parentTopY_svg > mergePoint_svg.y) { 
                        _drawSvgLine(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, parentCenterX_svg, parentTopY_svg, '#6b7280', 2, zoom); 
                    } 
                } 
                const standardChildren = parentNodeData.children.filter(c => !(c.andSourceNodeIds && c.andSourceNodeIds.length > 0 && c.andSourceNodeIds.includes(parentNodeData.id))); 
                if (standardChildren.length > 0) { 
                    const horizontalLineY_svg = parentBottomY_svg + lineVerticalOffset; 
                    _drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, parentBottomY_svg, parentBottomCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                    if (standardChildren.length > 1) { 
                        const firstChildElement = currentContainer.querySelector(`#${standardChildren[0].id}`); 
                        const lastChildElement = currentContainer.querySelector(`#${standardChildren[standardChildren.length - 1].id}`); 
                        if (firstChildElement && lastChildElement) { 
                            const firstChildRect = firstChildElement.getBoundingClientRect(); 
                            const lastChildRect = lastChildElement.getBoundingClientRect(); 
                            const hLineStartX_svg = (firstChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + firstChildRect.width / 2) / zoom; 
                            const hLineEndX_svg = (lastChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + lastChildRect.width / 2) / zoom; 
                            if (Math.abs(hLineStartX_svg - hLineEndX_svg) > 1) { 
                                _drawSvgLine(targetSvgLayer, hLineStartX_svg, horizontalLineY_svg, hLineEndX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                            } 
                        } 
                    } else if (standardChildren.length === 1) { 
                        const childElement = currentContainer.querySelector(`#${standardChildren[0].id}`); 
                        if (childElement) { 
                            const childRect = childElement.getBoundingClientRect(); 
                            const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom; 
                            if (Math.abs(parentBottomCenterX_svg - childCenterX_svg) > 1) { 
                                _drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, horizontalLineY_svg, childCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                            } 
                        } 
                    } 
                    standardChildren.forEach(childNode => { 
                        const childElement = currentContainer.querySelector(`#${childNode.id}`); 
                        if (childElement) { 
                            const childRect = childElement.getBoundingClientRect(); 
                            const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom; 
                            const childTopY_svg = (childRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                            if (childTopY_svg > horizontalLineY_svg) { 
                                _drawSvgLine(targetSvgLayer, childCenterX_svg, horizontalLineY_svg, childCenterX_svg, childTopY_svg, '#9ca3af', 2, zoom); 
                            } 
                        } 
                    }); 
                } 
                if (parentNodeData.children) { 
                    parentNodeData.children.forEach(childNode => drawRecursive(childNode, currentContainer)); 
                } 
            } 
            if(rcaData) drawRecursive(rcaData, targetDiagramContainer); 
        }
        function _drawSvgLine(svg, x1, y1, x2, y2, color = 'black', strokeWidth = 2, zoomFactor = 1) { 
            if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) { return; } 
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line'); 
            line.setAttribute('x1', x1); line.setAttribute('y1', y1); 
            line.setAttribute('x2', x2); line.setAttribute('y2', y2); 
            line.setAttribute('stroke', color); 
            line.setAttribute('stroke-width', strokeWidth / zoomFactor); 
            svg.appendChild(line); 
        }
        function _drawSvgCircle(svg, cx, cy, r, fillColor = 'black', zoomFactor = 1) { 
            if (isNaN(cx) || isNaN(cy) || isNaN(r)) { return; } 
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle'); 
            circle.setAttribute('cx', cx); circle.setAttribute('cy', cy); 
            circle.setAttribute('r', r / zoomFactor); 
            circle.setAttribute('fill', fillColor); 
            svg.appendChild(circle); 
        }
        
        function checkChildrenEffects(nodeData) { 
            let hasPositiveChild = false; let hasNegativeChild = false; 
            if (nodeData.children) { 
                for (const child of nodeData.children) { 
                    if (child.type === 'positive-effect') hasPositiveChild = true; 
                    if (child.type === 'negative-effect') hasNegativeChild = true; 
                    if (hasPositiveChild && hasNegativeChild) break; 
                } 
            } 
            return { hasPositiveChild, hasNegativeChild }; 
        }
        function toggleNonChangeable(nodeId) { 
            if (isFinalizedView) return; 
            const node = findNodeById(rcaData, nodeId); 
            if (node && node.type === 'cause') { 
                node.isNonChangeable = !node.isNonChangeable; 
                pushStateToHistory(rcaData); 
                renderRcaDiagram(); 
                renderCauseEffectTable(); 
            } 
        }
        function createActionButton(text, className, onClickHandler) { 
            const button = document.createElement('button'); 
            button.classList.add('action-button', ...className.split(' ')); 
            button.textContent = text; 
            button.addEventListener('click', onClickHandler); 
            return button; 
        }
        function promptAddNode(parentId, parentNodeContentDiv, nodeTypeToAdd, placeholderText) { 
            if (isFinalizedView) return; 
            const inputContainer = parentNodeContentDiv.querySelector('.input-group-container'); 
            if (!inputContainer) return; 
            inputContainer.innerHTML = ''; 
            document.querySelectorAll('.input-group').forEach(ig => ig.remove()); 
            const inputGroup = document.createElement('div'); 
            inputGroup.classList.add('input-group'); 
            const nodeInput = document.createElement('input'); 
            nodeInput.type = 'text'; 
            nodeInput.placeholder = placeholderText; 
            nodeInput.classList.add('input-field'); 
            const saveButton = document.createElement('button'); 
            saveButton.textContent = '儲存'; 
            saveButton.classList.add('action-button', 'save-button', 'w-full', 'mt-2'); 
            saveButton.onclick = () => { 
                const nodeText = nodeInput.value.trim(); 
                if (nodeText) { 
                    addNodeToData(parentId, nodeText, nodeTypeToAdd); 
                    inputContainer.innerHTML = ''; 
                } else { alert('描述不能為空！'); } 
            }; 
            nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveButton.click(); }); 
            const cancelButton = document.createElement('button'); 
            cancelButton.textContent = '取消'; 
            cancelButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1'); 
            cancelButton.onclick = () => { inputContainer.innerHTML = ''; }; 
            inputGroup.appendChild(nodeInput); 
            inputGroup.appendChild(saveButton); 
            inputGroup.appendChild(cancelButton); 
            inputContainer.appendChild(inputGroup); 
            nodeInput.focus(); 
        }
        function addNodeToData(parentId, nodeText, nodeType) { 
            const parentNode = findNodeById(rcaData, parentId); 
            if (parentNode) { 
                const newNode = createNode(nodeText, nodeType, parentId); 
                parentNode.children.push(newNode); 
                pushStateToHistory(rcaData); 
                renderRcaDiagram(); 
                renderCauseEffectTable(); 
                renderSolutionTable(); 
            } 
        }
        function removeNode(nodeIdToRemove) { 
            if (isFinalizedView) return; 
            if (rcaData && rcaData.id === nodeIdToRemove) { 
                alert('不能移除主要問題根源節點！'); 
                return; 
            } 
            let nodeRemoved = false; 
            function filterRecursive(node, idToRemove) { 
                if (!node) return null; 
                if (node.id === idToRemove) { 
                    nodeRemoved = true; 
                    function removeAndSourceFromEntireTree(currentNodeData, removedId) {
                        if (!currentNodeData) return;
                        if (currentNodeData.andSourceNodeIds && currentNodeData.andSourceNodeIds.includes(removedId)) {
                            currentNodeData.andSourceNodeIds = currentNodeData.andSourceNodeIds.filter(srcId => srcId !== removedId);
                        }
                        if (currentNodeData.children) {
                            currentNodeData.children.forEach(child => removeAndSourceFromEntireTree(child, removedId));
                        }
                    }
                    removeAndSourceFromEntireTree(rcaData, idToRemove);
                    return null; 
                } 
                if (node.children) { 
                    node.children = node.children.map(child => filterRecursive(child, idToRemove)).filter(child => child !== null); 
                } 
                return node; 
            } 
            rcaData = filterRecursive(rcaData, nodeIdToRemove); 
            if (nodeRemoved) { 
                pushStateToHistory(rcaData); 
            } 
            if (!rcaData) { 
                problemInputArea.style.display = 'flex'; 
                diagramTitle.style.display = 'none'; 
                toolButtonsContainer.style.display = 'flex'; 
                causeEffectTableSection.style.display = 'none'; 
                solutionTableSection.style.display = 'none'; 
                trackingTableSection.style.display = 'none';
                trizMcdaSection.style.display = 'none'; 
                historyStack = []; 
                historyIndex = -1; 
                applyZoom(1.0); 
            } 
            renderRcaDiagram(); 
            renderCauseEffectTable(); 
            renderSolutionTable(); 
            renderTrackingTable();
            updateButtonStates(); 
        }
        function findNodeById(node, id) { 
            if (!node) return null; 
            if (node.id === id) return node; 
            if (node.children) { 
                for (const child of node.children) { 
                    const found = findNodeById(child, id); 
                    if (found) return found; 
                } 
            } 
            return null; 
        }
        
        function getCauseEffectTableData() { 
            const tableRowsData = []; 
            function collectDataRecursive(node) { 
                if (!node) return; 
                if (node.type === 'cause') { 
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node); 
                    let causeType = ''; 
                    if (node.isNonChangeable) causeType = 'NC'; 
                    else if (hasPositiveChild && hasNegativeChild) causeType = 'N+P (矛盾)'; 
                    else if (hasNegativeChild) causeType = 'N (純負面)'; 
                    else if (hasPositiveChild) causeType = 'P (純正面)'; 
                    else causeType = '未定義效果'; 
                    if (causeType !== 'P (純正面)' || (hasPositiveChild || hasNegativeChild)) { 
                        const positiveEffects = node.children.filter(c => c.type === 'positive-effect').map(c => c.text).join('; ') || '無'; 
                        const negativeEffects = node.children.filter(c => c.type === 'negative-effect').map(c => c.text).join('; ') || '無'; 
                        tableRowsData.push({ cause: node.text, type: causeType, positive: positiveEffects, negative: negativeEffects }); 
                    } 
                } 
                if (node.children) node.children.forEach(collectDataRecursive); 
            } 
            if (rcaData) collectDataRecursive(rcaData); 
            return tableRowsData; 
        }
        function renderCauseEffectTable() { 
            if (!rcaData) { 
                causeEffectTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; 
                return; 
            } 
            const tableData = getCauseEffectTableData(); 
            causeEffectTableBody.innerHTML = ''; 
            if (tableData.length === 0) { 
                causeEffectTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">目前圖表中沒有定義直接帶有正面或負面效果的原因 (且非純粹正面原因)。</td></tr>'; 
                return; 
            } 
            tableData.forEach(rowData => { 
                const row = causeEffectTableBody.insertRow(); 
                row.insertCell().textContent = rowData.cause; 
                row.insertCell().textContent = rowData.type; 
                row.insertCell().textContent = rowData.positive; 
                row.insertCell().textContent = rowData.negative; 
            }); 
        }
        
        function renderSolutionTable() { 
            if (!rcaData) { 
                solutionTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; 
                return; 
            } 
            const tableData = getSolutionTableData(); 
            solutionTableBody.innerHTML = ''; 
            if (tableData.length === 0) { 
                let message = '目前沒有矛盾原因已選擇發明原理並填寫改善方案。'; 
                let hasContradictoryCause = false; 
                function findContradictory(node) { 
                    if (!node) return; 
                    if (node.type === 'cause') { 
                        const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node); 
                        if (hasPositiveChild && hasNegativeChild) { 
                            hasContradictoryCause = true; 
                            return; 
                        } 
                    } 
                    if (node.children && !hasContradictoryCause) node.children.forEach(findContradictory); 
                } 
                if (rcaData) findContradictory(rcaData); 
                if (!hasContradictoryCause) { 
                    message = '提示：圖表中尚無「矛盾原因」(即同時直接導致正面及負面效果的原因)。請先建立矛盾原因。'; 
                } else { 
                    message = '提示：已找到矛盾原因，但尚未為其「選擇發明原理」並填寫「改善方案」。'; 
                } 
                solutionTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">${message}</td></tr>`; 
                return; 
            } 
            const groupedSolutions = {}; 
            tableData.forEach(item => { 
                if (!groupedSolutions[item.contradictoryCause]) { 
                    groupedSolutions[item.contradictoryCause] = []; 
                } 
                groupedSolutions[item.contradictoryCause].push({ principle: item.principle, solution: item.solution }); 
            }); 
            Object.keys(groupedSolutions).forEach(causeText => { 
                const solutionsForCause = groupedSolutions[causeText]; 
                solutionsForCause.forEach((solutionItem, index) => { 
                    const row = solutionTableBody.insertRow(); 
                    if (index === 0) { 
                        const causeCell = row.insertCell(); 
                        causeCell.textContent = causeText; 
                        causeCell.rowSpan = solutionsForCause.length; 
                    } 
                    row.insertCell().textContent = solutionItem.principle; 
                    row.insertCell().textContent = solutionItem.solution; 
                }); 
            }); 
        }
        function getSolutionTableData() { 
            const solutionData = []; 
            function collectSolutionsRecursive(node) { 
                if (!node) return; 
                if (node.type === 'cause') { 
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node); 
                    if (hasPositiveChild && hasNegativeChild && node.inventivePrinciples && node.inventivePrinciples.length > 0) { 
                        node.inventivePrinciples.forEach(ip => { 
                            if (ip.solution && ip.solution.trim() !== '') { 
                                solutionData.push({ contradictoryCause: node.text, principle: ip.name, solution: ip.solution }); 
                            } 
                        }); 
                    } 
                } 
                if (node.children) node.children.forEach(collectSolutionsRecursive); 
            } 
            if (rcaData) { 
                collectSolutionsRecursive(rcaData); 
            } 
            return solutionData; 
        }

        function renderTrackingTable() {
            trackingTableBody.innerHTML = '';
            if (trackingData.length === 0) {
                trackingTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">目前沒有追蹤中的改善方案。</td></tr>';
                return;
            }
            trackingData.forEach(item => {
                const row = trackingTableBody.insertRow();
                row.insertCell().textContent = item.solutionText;
                row.insertCell().textContent = item.responsiblePerson;
                row.insertCell().textContent = item.dueDate;
                row.insertCell().textContent = item.status;
                row.insertCell().textContent = item.actualOutcome;
                row.insertCell().textContent = item.notes;
                
                const actionCell = row.insertCell();
                actionCell.classList.add('action-cell');
                const editButton = createActionButton('編輯', 'edit-node !py-1 !px-2', () => openTrackingItemModalForEdit(item.id));
                const deleteButton = createActionButton('刪除', 'remove-button !py-1 !px-2 ml-1', () => handleDeleteTrackingItem(item.id));
                actionCell.appendChild(editButton);
                actionCell.appendChild(deleteButton);
            });
            updateButtonStates();
        }

        function openTrackingItemModalForAdd() {
            currentEditingTrackingItemId = null;
            trackingItemModalTitle.textContent = '新增追蹤項目';
            trackingItemIdInput.value = '';
            trackingSolutionTextInput.value = '';
            trackingResponsiblePersonInput.value = '';
            trackingDueDateInput.value = '';
            trackingStatusSelect.value = '未開始';
            trackingActualOutcomeInput.value = '';
            trackingNotesInput.value = '';
            trackingItemModal.style.display = 'flex';
        }

        function openTrackingItemModalForEdit(itemId) {
            const item = trackingData.find(t => t.id === itemId);
            if (!item) return;
            currentEditingTrackingItemId = itemId;
            trackingItemModalTitle.textContent = '編輯追蹤項目';
            trackingItemIdInput.value = item.id;
            trackingSolutionTextInput.value = item.solutionText;
            trackingResponsiblePersonInput.value = item.responsiblePerson;
            trackingDueDateInput.value = item.dueDate;
            trackingStatusSelect.value = item.status;
            trackingActualOutcomeInput.value = item.actualOutcome;
            trackingNotesInput.value = item.notes;
            trackingItemModal.style.display = 'flex';
        }

        function closeTrackingItemModal() {
            trackingItemModal.style.display = 'none';
            currentEditingTrackingItemId = null;
        }

        function handleSaveTrackingItem() {
            const solutionText = trackingSolutionTextInput.value.trim();
            if (!solutionText) {
                alert('改善方案描述不能為空！');
                return;
            }
            const itemData = {
                solutionText: solutionText,
                responsiblePerson: trackingResponsiblePersonInput.value.trim(),
                dueDate: trackingDueDateInput.value,
                status: trackingStatusSelect.value,
                actualOutcome: trackingActualOutcomeInput.value.trim(),
                notes: trackingNotesInput.value.trim()
            };

            if (currentEditingTrackingItemId) { 
                const index = trackingData.findIndex(item => item.id === currentEditingTrackingItemId);
                if (index > -1) {
                    trackingData[index] = { ...trackingData[index], ...itemData };
                }
            } else { 
                itemData.id = `track-${Date.now()}`; 
                trackingData.push(itemData);
            }
            pushStateToHistory(rcaData); 
            renderTrackingTable();
            closeTrackingItemModal();
        }

        function handleDeleteTrackingItem(itemId) {
            if (confirm('確定要刪除此追蹤項目嗎？')) {
                trackingData = trackingData.filter(item => item.id !== itemId);
                pushStateToHistory(rcaData); 
                renderTrackingTable();
            }
        }
        
        function autoAdjustNodeLayout() { 
            if (!rcaData || isFinalizedView) {
                alert('請先建立圖表或結束「完成圖表」模式以調整節點位置。');
                return;
            }
            const nodeWrappers = Array.from(diagramContainer.querySelectorAll('.rca-node-wrapper'));
            const MIN_SPACING = 20; 
            for (let i = 0; i < nodeWrappers.length; i++) {
                const wrapper1 = nodeWrappers[i];
                const rect1 = wrapper1.getBoundingClientRect();
                for (let j = i + 1; j < nodeWrappers.length; j++) {
                    const wrapper2 = nodeWrappers[j];
                    if (wrapper1.parentNode !== wrapper2.parentNode || wrapper1.parentNode.classList.contains('rca-diagram-container')) {
                        continue; 
                    }
                    const rect2 = wrapper2.getBoundingClientRect();
                    const overlapX = Math.max(0, Math.min(rect1.right, rect2.right) - Math.max(rect1.left, rect2.left));
                    const verticalAlign = Math.abs(rect1.top - rect2.top) < rect1.height / 2; 
                    
                    if (verticalAlign && overlapX > -MIN_SPACING) { 
                        const adjustment = (overlapX > 0 ? overlapX : 0) + MIN_SPACING; 
                        let currentMarginLeft = parseFloat(getComputedStyle(wrapper2).marginLeft) || 0;
                        wrapper2.style.marginLeft = (currentMarginLeft + adjustment) + 'px';
                        wrapper2.getBoundingClientRect(); 
                    }
                }
            }
            requestAnimationFrame(() => drawAllSvgConnectors()); 
            alert('嘗試自動調整節點位置。您可能需要多次點擊或手動微調以獲得最佳效果。');
        }

        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                alert(`找不到表格 ID: ${tableId}`);
                return;
            }
            let csv = [];
            const rows = table.querySelectorAll("tr");
            
            for (const row of rows) {
                const rowData = [];
                const cols = row.querySelectorAll("td, th");
                for (const col of cols) {
                    let cellData = col.innerText.replace(/"/g, '""'); 
                    if (cellData.includes(',')) { 
                        cellData = `"${cellData}"`;
                    }
                    rowData.push(cellData);
                }
                csv.push(rowData.join(","));
            }

            const csvFile = new Blob(["\uFEFF" + csv.join("\n")], {type: "text/csv;charset=utf-8;"}); 
            const downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            alert(`${filename} 已準備下載。`);
        }
        
        // --- 初始化函數定義 ---
        function initialize() {
            populateTrizParameters();
            initializeTrizMatrix();

            setProblemButton.addEventListener('click', handleSetInitialProblem);
            problemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSetInitialProblem(); });
            
            fileMenuButton.addEventListener('click', (event) => { 
                event.stopPropagation(); 
                toggleDropdown(fileDropdownContent, [exportDropdownContent, viewTablesDropdownContent]);
                updateButtonStates(); 
            });
            saveWorkspaceButton.addEventListener('click', () => { handleSaveToLocalStorage(); closeAllDropdowns(); });
            loadWorkspaceButton.addEventListener('click', () => { handleLoadFromLocalStorage(); closeAllDropdowns(); });
            downloadBackupButton.addEventListener('click', () => { handleSaveToFile(); closeAllDropdowns(); });
            loadBackupLabel.addEventListener('click', () => { loadBackupInput.click(); }); 
            loadBackupInput.addEventListener('change', (event) => { handleLoadFromFile(event); closeAllDropdowns(); });

            undoButton.addEventListener('click', handleUndo);
            redoButton.addEventListener('click', handleRedo);

            zoomInButton.addEventListener('click', () => applyZoom(currentZoom + ZOOM_STEP));
            zoomOutButton.addEventListener('click', () => applyZoom(currentZoom - ZOOM_STEP));
            resetZoomButton.addEventListener('click', () => applyZoom(1.0));

            finalizeDiagramButton.addEventListener('click', handleToggleFinalizeView); 
            autoAdjustLayoutButton.addEventListener('click', autoAdjustNodeLayout); 
            toggleTrizMcdaButton.addEventListener('click', handleToggleTrizMcdaSection); 

            exportMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleDropdown(exportDropdownContent, [fileDropdownContent, viewTablesDropdownContent]);
                updateButtonStates();
            });
            exportCauseEffectCsvButton.addEventListener('click', () => { exportTableToCSV('cause-effect-data-table', 'cause_effect_table.csv'); closeAllDropdowns(); });
            exportSolutionCsvButton.addEventListener('click', () => { exportTableToCSV('solution-data-table', 'solution_table.csv'); closeAllDropdowns(); });
            exportTrackingCsvButton.addEventListener('click', () => { exportTableToCSV('tracking-data-table', 'tracking_table.csv'); closeAllDropdowns(); });
            
            if (exportSvgButton) {
                exportSvgButton.addEventListener('click', () => { 
                    exportSVG('RCA_矛盾分析圖.svg'); 
                    closeAllDropdowns(); 
                });
            }

            printDocumentButton.addEventListener('click', () => { 
                if(rcaData || trackingData.length > 0 || hasTrizMcdaData()) { 
                    requestAnimationFrame(() => {
                        if (rcaData) drawAllSvgConnectors(svgLayer, diagramContainer, scalableContentWrapper, currentZoom); 
                        setTimeout(() => window.print(), 100); 
                    });
                } else {
                     alert("沒有可列印的內容。");
                }
                closeAllDropdowns(); 
            });
            
            viewTablesMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleDropdown(viewTablesDropdownContent, [fileDropdownContent, exportDropdownContent]);
                updateButtonStates();
            });
            showCauseEffectTableButton.addEventListener('click', () => { handleShowCauseEffectTable(); closeAllDropdowns(); });
            showSolutionTableButton.addEventListener('click', () => { handleShowSolutionTable(); closeAllDropdowns(); });
            showTrackingTableButton.addEventListener('click', () => { handleShowTrackingTable(); closeAllDropdowns(); }); 
            hideAllTablesButton.addEventListener('click', () => { handleHideAllTables(); closeAllDropdowns(); });
            
            addTrackingItemButton.addEventListener('click', openTrackingItemModalForAdd); 
            saveTrackingItemButton.addEventListener('click', handleSaveTrackingItem); 

            saveAndSourcesButton.addEventListener('click', handleSaveAndSources);
            cancelAndSourcesButton.addEventListener('click', () => { andSourceModal.style.display = 'none'; currentAndTargetNodeId = null; });
            saveEffectParametersButton.addEventListener('click', handleSaveEffectParameters);
            cancelEffectParametersButton.addEventListener('click', () => { effectParameterModal.style.display = 'none'; currentParameterTargetNodeId = null; });
            saveInventivePrinciplesButton.addEventListener('click', handleSaveInventivePrinciples);
            cancelInventivePrinciplesButton.addEventListener('click', () => { inventivePrincipleModal.style.display = 'none'; currentPrincipleTargetNodeId = null; });
            
            trizGeneratePrinciplesButton.addEventListener('click', handleTrizGeneratePrinciples);
            mcdaAddCriterionButton.addEventListener('click', handleMcdaAddCriterion);
            mcdaCalculateTotalWeightButton.addEventListener('click', calculateAndDisplayTotalWeight);
            mcdaCalculateScoresButton.addEventListener('click', handleMcdaCalculateScores);
            saveTrizMcdaButton.addEventListener('click', saveTrizMcdaProgress);

            window.addEventListener('click', (event) => { 
                if (!event.target.closest('.dropdown')) {
                    closeAllDropdowns();
                }
            });

            new ResizeObserver(() => { if(rcaData) drawAllSvgConnectors(); }).observe(scalableContentWrapper); 
            toolButtonsContainer.style.display = 'flex'; 
            applyZoom(1.0, true); 
            updateButtonStates(); 
            
            scalableContentWrapper.addEventListener('contextmenu', (event) => {
                event.preventDefault(); 
            });
             loadTrizMcdaDataFromLocalStorage(); 
        }
        
        // --- 初始化應用程式 ---
        initialize(); 
    </script>
</body>
</html>
