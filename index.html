<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>創新問題解決工具 (含進度上傳下載)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .step-section {
            display: none;
        }
        .step-section.active {
            display: block;
        }
        .dynamic-list-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
        }
        .dynamic-list-item input[type="text"] {
            flex-grow: 1;
            margin-right: 0.5rem;
        }
        .remove-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        .remove-btn:hover {
            background-color: #dc2626;
        }
        .ideas-landscape-plot {
            width: 100%;
            max-width: 500px;
            height: 400px;
            border: 1px solid #ccc;
            position: relative;
            margin: 20px auto;
            background-color: #f9fafb;
        }
        .plot-point {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #3b82f6;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            text-align: center;
            line-height: 10px;
            color: white;
            cursor: pointer;
        }
        .plot-point .tooltip {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .plot-point:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .plot-axis {
            position: absolute;
            background-color: #9ca3af;
        }
        .x-axis {
            bottom: 50%;
            left: 0;
            width: 100%;
            height: 1px;
        }
        .y-axis {
            top: 0;
            left: 50%;
            width: 1px;
            height: 100%;
        }
        .axis-label {
            position: absolute;
            font-size: 12px;
            color: #6b7280;
        }
        .x-axis-label {
            bottom: calc(50% - 20px);
            left: 50%;
            transform: translateX(-50%);
        }
        .y-axis-label {
            top: 50%;
            left: calc(50% - 30px);
            transform: translateY(-50%) rotate(-90deg);
        }
         .quadrant-label {
            position: absolute;
            font-size: 11px;
            color: #a0aec0;
            padding: 5px;
        }
        .lean-canvas-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr); 
            gap: 1rem;
        }
        @media (min-width: 768px) { 
            .lean-canvas-grid {
                grid-template-columns: repeat(3, 1fr); 
            }
            .lc-problem { grid-column: span 1 / span 1; }
            .lc-solution { grid-column: span 1 / span 1; }
            .lc-key-metrics { grid-column: span 1 / span 1; }
            .lc-uvp { grid-column: span 3 / span 3;  }
            .lc-unfair-advantage { grid-column: span 1 / span 1; }
            .lc-channels { grid-column: span 1 / span 1; }
            .lc-customer-segments { grid-column: span 1 / span 1; }
            .lc-cost-structure { grid-column: span 1 / span 1; grid-row: 4 / span 1; }
            .lc-revenue-streams { grid-column: span 2 / span 2; grid-row: 4 / span 1; }
        }
         @media (min-width: 1024px) { 
            .lean-canvas-grid {
                grid-template-columns: repeat(5, 1fr);
                grid-template-rows: auto auto auto; 
            }
            .lc-problem { grid-column: 1 / span 1; grid-row: 1 / span 1; }
            .lc-solution { grid-column: 2 / span 1; grid-row: 1 / span 1; }
            .lc-key-metrics { grid-column: 4 / span 1; grid-row: 1 / span 1; }
            .lc-uvp { grid-column: 3 / span 1; grid-row: 1 / span 2;  }
            .lc-unfair-advantage { grid-column: 1 / span 1; grid-row: 2 / span 1; }
            .lc-channels { grid-column: 2 / span 1; grid-row: 2 / span 1; }
            .lc-customer-segments { grid-column: 5 / span 1; grid-row: 1 / span 2;  }
            .lc-cost-structure { grid-column: 1 / span 2; grid-row: 3 / span 1; } 
            .lc-revenue-streams { grid-column: 3 / span 3; grid-row: 3 / span 1; } 
        }

        .lean-canvas-cell {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            min-height: 150px; 
            display: flex;
            flex-direction: column;
        }
        .lean-canvas-cell label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .lean-canvas-cell textarea {
            width: 100%;
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            resize: vertical; 
        }
        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 600px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .modal-close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .ai-suggestion-container {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #eef2ff; 
            border: 1px solid #c7d2fe; 
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #4338ca; 
        }
        .loading-spinner {
            border: 2px solid #f3f3f3; 
            border-top: 2px solid #3498db; 
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .notification-area {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="container mx-auto bg-white p-6 rounded-lg shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">創新問題解決工具</h1>
            <button id="manageProgressBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">管理進度</button>
        </div>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap space-x-1 sm:space-x-4" aria-label="Tabs">
                <button data-tab="step1" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-xs sm:text-base">1. 問題與RCA</button>
                <button data-tab="step2" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-xs sm:text-base">2. 衝突分析</button>
                <button data-tab="step3" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-xs sm:text-base">3. TRIZ方案生成</button>
                <button data-tab="step4" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-xs sm:text-base">4. 方案評估選擇</button>
                <button data-tab="step5" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-xs sm:text-base">5. 精實畫布</button>
                <button data-tab="step6" class="tab-button py-3 px-2 sm:px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-xs sm:text-base">6. 最終報告</button>
            </nav>
        </div>

        <section id="step1" class="step-section active">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">步驟 1: 界定關鍵問題與根本原因分析 (RCA)</h2>
            <div class="mb-6">
                <label for="keyProblem" class="block text-sm font-medium text-gray-700 mb-1">關鍵問題描述:</label>
                <textarea id="keyProblem" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="請明確界定一個您想解決的關鍵問題..."></textarea>
                 <button id="aiSuggestRcaBtn" class="mt-2 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-sm">✨ AI 協助分析潛在根本原因</button>
                 <div id="aiRcaSuggestions_notification_area" class="notification-area"></div>
                 <div id="aiRcaSuggestionsContainer" class="ai-suggestion-container" style="display: none;"></div>
            </div>
            <div class="mb-4">
                <h3 class="text-lg font-medium text-gray-700 mb-2">根本原因分析 (RCA):</h3>
                <p class="text-sm text-gray-500 mb-2">不斷追問「是什麼原因造成這個問題？」以及「這個原因又是被什麼造成的？」</p>
                <div id="rcaCausesContainer">
                    </div>
                <button id="addRcaCauseBtn" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">新增原因</button>
            </div>
        </section>

        <section id="step2" class="step-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">步驟 2: 衝突分析</h2>
            <p class="text-sm text-gray-500 mb-3">根據根本原因，找出導致問題的「衝突點」。衝突通常體現為：當試圖改善一個方面（帶來好處）時，會導致另一個方面惡化（帶來壞處）。</p>
            <div class="my-4">
                <button id="aiSuggestConflictsBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-sm">✨ AI 建議衝突點</button>
                <div id="aiConflictSuggestions_notification_area" class="notification-area"></div>
                <div id="aiConflictSuggestionsContainer" class="ai-suggestion-container mt-2" style="display: none;"></div>
            </div>
            <div id="conflictAnalysisContainer">
                </div>
            <button id="addConflictBtn" class="mt-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">新增衝突點</button>
        </section>

        <section id="step3" class="step-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">步驟 3: 利用 TRIZ 方法生成解決方案</h2>
            <p class="text-sm text-gray-500 mb-3">根據識別出的衝突，運用 TRIZ 的工具來生成潛在的解決方案。</p>
            <div class="mb-4 p-4 border border-blue-200 bg-blue-50 rounded-md">
                <h4 class="font-semibold text-blue-700">提示：對應工程參數與查找發明原則</h4>
                <p class="text-sm text-blue-600">將衝突中的「好處」和「壞處」對應到相應的工程參數。然後，系統將根據這些參數（簡化版對應）建議一些發明原則，協助您發想解決方案。</p>
            </div>
            <div id="trizSolutionsContainer_notification_area" class="notification-area"></div>
            <div id="trizSolutionsContainer">
                </div>
            <button id="addTrizSolutionSetBtn" class="mt-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">為衝突點生成方案</button>
        </section>

        <section id="step4" class="step-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">步驟 4: 評估與選擇解決方案</h2>
            <div class="mb-8 p-4 border rounded-md shadow-sm">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">4.1 初步篩選 (ABC Filtering)</h3>
                <p class="text-sm text-gray-500 mb-2">對所有生成的方案進行初步分級 (A: 值得考慮, B: 有懷疑/保守, C: 無考慮價值)。</p>
                <div id="abcFilteringContainer"></div>
            </div>
            <div class="mb-8 p-4 border rounded-md shadow-sm">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">4.2 多準則決策評估 (MCDM)</h3>
                <p class="text-sm text-gray-500 mb-2">對 A 級方案進行更詳細的評估。請先設定評估準則及其權重。</p>
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-medium text-gray-700">設定評估準則:</h4>
                        <button id="aiSuggestMcdmCriteriaBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-1 px-2 rounded-md shadow-sm text-xs">✨ AI 建議準則</button>
                    </div>
                    <div id="aiMcdmCriteriaSuggestions_notification_area" class="notification-area"></div>
                    <div id="aiMcdmCriteriaSuggestionsContainer" class="ai-suggestion-container mb-2" style="display: none;"></div>
                    <div id="mcdmCriteriaContainer"></div>
                    <button id="addMcdmCriterionBtn" class="mt-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm">新增準則</button>
                </div>
                <div id="mcdmEvaluationContainer">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">A級方案評分:</h4>
                </div>
            </div>
            <div class="mb-8 p-4 border rounded-md shadow-sm">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">4.3 創意景觀圖 (Ideas Landscape)</h3>
                <p class="text-sm text-gray-500 mb-2">將方案的評估結果以圖形方式呈現。橫軸：導入所需時間，縱軸：MCDM總分。</p>
                <div id="ideasLandscapeInputContainer" class="mb-4"></div>
                <div id="ideasLandscapePlotContainer" class="ideas-landscape-plot">
                    <div class="plot-axis x-axis"></div> <div class="plot-axis y-axis"></div>
                    <div class="axis-label x-axis-label">導入所需時間 (短 → 長)</div>
                    <div class="axis-label y-axis-label">MCDM 總分 (低 → 高)</div>
                    <div class="quadrant-label" style="top: 10px; left: 10px;">II. 優先</div> <div class="quadrant-label" style="top: 10px; right: 10px;">I. 長期</div>
                    <div class="quadrant-label" style="bottom: 10px; left: 10px;">III. 捨棄</div> <div class="quadrant-label" style="bottom: 10px; right: 10px;">IV. 避免</div>
                </div>
                <button id="generateIdeasLandscapeBtn" class="mt-4 bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">產生/更新景觀圖</button>
                <button id="aiAnalyzeLandscapeBtn" class="mt-4 ml-2 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-sm">✨ AI 分析景觀圖</button>
                <div id="aiLandscapeAnalysis_notification_area" class="notification-area"></div>
                <div id="aiLandscapeAnalysisContainer" class="ai-suggestion-container mt-2" style="display: none;"></div>
            </div>
            <div class="p-4 border rounded-md shadow-sm">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">4.4 TRIZ 理想性評估 (可選)</h3>
                <p class="text-sm text-gray-500 mb-2">對最終選出的 Top Ideas 進行更嚴格的 TRIZ 理想性評估。</p>
                <div id="trizIdealnessContainer"></div>
                 <button id="startTrizIdealnessBtn" class="mt-2 bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm">開始理想性評估</button>
            </div>
        </section>

        <section id="step5" class="step-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">步驟 5: 精實畫布 / 商業模式 (Lean Canvas)</h2>
            <p class="text-sm text-gray-500 mb-1">針對您選定的解決方案，規劃其商業模式。 </p>
            <p class="text-xs text-blue-500 mb-3">提示：點擊下方按鈕可快速帶入先前步驟的相關資訊。</p>
            <div class="mb-3">
                <button id="prefillLeanCanvasProblemBtn" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 py-1 px-2 rounded-md mr-2">從步驟1帶入「問題」</button>
                <button id="prefillLeanCanvasSolutionBtn" class="text-xs bg-green-100 hover:bg-green-200 text-green-700 py-1 px-2 rounded-md">從最佳A級方案帶入「解決方案」與「獨特價值主張」建議</button>
            </div>
            <div id="leanCanvasGridContainer_notification_area" class="notification-area"></div>
            <div id="leanCanvasGridContainer" class="lean-canvas-grid">
                </div>
        </section>

        <section id="step6" class="step-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">步驟 6: 最終方案與報告呈現</h2>
            <p class="text-sm text-gray-500 mb-3">綜合所有分析與評估，選定最終方案並檢視完整報告。</p>
             <button id="aiGenerateReportSummaryBtn" class="mb-3 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-sm">✨ AI 產生報告摘要</button>
            <div id="aiReportSummaryContainer_notification_area" class="notification-area"></div>
            <div id="aiReportSummaryContainer" class="ai-suggestion-container mb-4" style="display:none;"></div>
            <div id="finalReportContainer" class="space-y-6">
                </div>
            <button id="generateReportBtn" class="mt-4 bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-md shadow-sm">產生最終報告</button>
        </section>

        <div class="mt-8 pt-6 border-t border-gray-200 flex justify-between">
            <button id="prevStepBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md shadow-sm">上一步</button>
            <button id="nextStepBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-md shadow-sm">下一步</button>
        </div>
    </div>

    <div id="progressModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="closeProgressModalBtn">&times;</span>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">管理進度</h2>
            
            <div class="mb-4 p-4 border rounded-md">
                <h3 class="text-lg font-medium text-gray-700 mb-2">檔案操作</h3>
                <div class="flex space-x-2">
                    <label for="uploadProgressInput" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm cursor-pointer text-center">
                        上傳進度檔案
                        <input type="file" id="uploadProgressInput" accept=".json" class="hidden">
                    </label>
                    <button id="downloadProgressBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm">下載目前進度</button>
                </div>
            </div>
            
            <div class="mb-4 p-4 border rounded-md">
                <h3 class="text-lg font-medium text-gray-700 mb-2">儲存目前進度至瀏覽器</h3>
                <label for="progressNameInput" class="block text-sm font-medium text-gray-600 mb-1">進度名稱 (可選):</label>
                <input type="text" id="progressNameInput" class="w-full p-2 border border-gray-300 rounded-md mb-2" placeholder="例如：我的第一個專案">
                <button id="saveNewProgressBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm w-full">儲存至瀏覽器</button>
            </div>

            <div class="p-4 border rounded-md">
                <h3 class="text-lg font-medium text-gray-700 mb-2">瀏覽器中已儲存的進度</h3>
                <div id="savedProgressList" class="space-y-2 max-h-60 overflow-y-auto">
                    <p class="text-sm text-gray-500">尚未儲存任何進度。</p>
                </div>
            </div>
             <div id="globalNotification" class="notification-area"></div>
        </div>
    </div>


    <script>
        // --- Global State and Data ---
        let appState = {
            keyProblem: "",
            rcaCauses: [], 
            conflicts: [], 
            trizSolutions: [], 
            abcCategories: {}, 
            mcdmCriteria: [], 
            mcdmScores: {}, 
            solutionImplementationTimes: {}, 
            trizIdealnessScores: {}, 
            leanCanvas: { 
                problem: "", solution: "", keyMetrics: "", uniqueValueProposition: "",
                unfairAdvantage: "", channels: "", customerSegments: "",
                costStructure: "", revenueStreams: "",
                selectedSolutionTextForCanvas: "" 
            },
            currentStep: 1
        };
        
        const LOCAL_STORAGE_KEY = 'innovationToolSaves_v2_gemini_advanced_fileIO'; // Updated key

        // --- Gemini API Helper ---
        const API_KEY = ""; 
        const API_URL_GEMINI = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

        async function callGeminiAPI(promptText, buttonElement, notificationTargetId = "globalNotification", loadingText = "AI 思考中...") {
            if (!promptText || promptText.trim() === "") {
                showNotification("請先提供相關內容以供 AI 分析。", "error", notificationTargetId);
                return null;
            }

            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = `${loadingText} <div class="loading-spinner"></div>`;
            buttonElement.disabled = true;

            const payload = {
                contents: [{ role: "user", parts: [{ text: promptText }] }]
            };

            try {
                const response = await fetch(API_URL_GEMINI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error:", errorData);
                    throw new Error(`API 請求失敗，狀態碼：${response.status}. ${errorData?.error?.message || ''}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API 意外的回應結構:", result);
                    throw new Error("AI 未能產生有效的回應內容。");
                }
            } catch (error) {
                console.error("呼叫 Gemini API 時發生錯誤:", error);
                showNotification(`AI 服務錯誤: ${error.message}`, "error", notificationTargetId);
                return null;
            } finally {
                buttonElement.innerHTML = originalButtonText;
                buttonElement.disabled = false;
            }
        }


        // --- TRIZ Data (Simplified) ---
        const engineeringParameters = [
            { id: "1", name: "1. 移動物體的重量" }, { id: "2", name: "2. 靜止物體的重量" },
            { id: "3", name: "3. 移動物體的長度" }, { id: "4", name: "4. 靜止物體的長度" },
            { id: "5", name: "5. 移動物體的面積" }, { id: "6", name: "6. 靜止物體的面積" },
            { id: "7", name: "7. 移動物體的體積" }, { id: "8", name: "8. 靜止物體的體積" },
            { id: "9", name: "9. 速度" }, { id: "10", name: "10. 力" },
            { id: "11", name: "11. 應力或壓力" }, { id: "12", name: "12. 形狀" },
            { id: "13", name: "13. 物體組成的穩定性" }, { id: "14", name: "14. 強度" },
            { id: "15", name: "15. 移動物體的作用持續時間" }, { id: "16", name: "16. 靜止物體的作用持續時間" },
            { id: "17", name: "17. 溫度" }, { id: "18", name: "18. 照明強度" },
            { id: "19", name: "19. 移動物體的能量消耗" }, { id: "20", name: "20. 靜止物體的能量消耗" },
            { id: "21", name: "21. 功率" }, { id: "22", name: "22. 能量損失" },
            { id: "23", name: "23. 物質損失" }, { id: "24", name: "24. 資訊損失" },
            { id: "25", name: "25. 時間損失 (系統時間)" }, { id: "26", name: "26. 物質數量" },
            { id: "27", name: "27. 可靠性 (系統有效性)" }, { id: "28", name: "28. 量測準確性" },
            { id: "29", name: "29. 製造精密度" }, { id: "30", name: "30. 物體受外部有害因素影響" },
            { id: "31", name: "31. 物體產生的有害因素" }, { id: "32", name: "32. 製造容易度" },
            { id: "33", name: "33. 操作容易度" }, { id: "34", name: "34. 維修容易度" },
            { id: "35", name: "35. 適應性或通用性" }, { id: "36", name: "36. 裝置複雜性" },
            { id: "37", name: "37. 偵測與量測困難度" }, { id: "38", name: "38. 自動化程度" },
            { id: "39", name: "39. 生產力／效能" }
        ];
        const inventivePrinciples = [
            { id: "1", name: "1. 分割 (Segmentation)"}, { id: "2", name: "2. 取出 (Taking out / Extraction)"},
            { id: "3", name: "3. 局部性質 (Local quality)"}, { id: "4", name: "4. 非對稱 (Asymmetry)"},
            { id: "5", name: "5. 合併 (Merging / Consolidation)"}, { id: "6", name: "6. 泛用性 (Universality)"},
            { id: "7", name: "7. 套疊 (Nested doll / Matryoshka)"}, { id: "8", name: "8. 反重力 (Anti-weight / Counterweight)"},
            { id: "9", name: "9. 預先反向作用 (Preliminary anti-action / Prior counteraction)"}, { id: "10", name: "10. 預先作用 (Preliminary action / Prior action)"},
            { id: "11", name: "11. 預先保護 (Beforehand cushioning / Cushion in advance)"}, { id: "12", name: "12. 等勢能 (Equipotentiality)"},
            { id: "13", name: "13. 反向 (The other way round / Inversion)"}, { id: "14", name: "14. 曲面化 (Spheroidality / Curvature)"},
            { id: "15", name: "15. 動態化 (Dynamics / Dynamization)"}, { id: "16", name: "16. 不足或超額作用 (Partial or excessive actions)"},
            { id: "17", name: "17. 維度轉換 (Another dimension / Transition into a new dimension)"}, { id: "18", name: "18. 機械振動 (Mechanical vibration)"},
            { id: "19", name: "19. 週期性作用 (Periodic action)"}, { id: "20", name: "20. 有用作用的連續性 (Continuity of useful action)"},
            { id: "21", name: "21. 高速執行 (Skipping / Rushing through)"}, { id: "22", name: "22. 化害為利 (Blessing in disguise / Convert harm into benefit)"},
            { id: "23", name: "23. 回饋 (Feedback)"}, { id: "24", name: "24. 中介物 (Intermediary / Mediator)"},
            { id: "25", name: "25. 自助服務 (Self-service)"}, { id: "26", name: "26. 複製 (Copying)"},
            { id: "27", name: "27. 廉價替代品 (Cheap short-living objects)"}, { id: "28", name: "28. 機械系統替代 (Mechanics substitution / Replace mechanical system)"},
            { id: "29", name: "29. 氣動或液壓系統 (Pneumatics and hydraulics)"}, { id: "30", name: "30. 可撓性殼膜 (Flexible shells and thin films)"},
            { id: "31", name: "31. 多孔材料 (Porous materials)"}, { id: "32", name: "32. 顏色改變 (Color changes)"},
            { id: "33", name: "33. 同質性 (Homogeneity)"}, { id: "34", name: "34. 拋棄與再生 (Discarding and recovering / Rejection and regeneration)"},
            { id: "35", name: "35. 參數改變 (Parameter changes)"}, { id: "36", name: "36. 相態轉換 (Phase transitions)"},
            { id: "37", name: "37. 熱膨脹 (Thermal expansion)"}, { id: "38", name: "38. 強氧化劑 (Strong oxidants / Accelerated oxidation)"},
            { id: "39", name: "39. 惰性環境 (Inert atmosphere)"}, { id: "40", name: "40. 複合材料 (Composite materials)"}
        ];
        const simplifiedContradictionMap = { "25_27": ["9", "5", "40", "4"], "default": ["1", "2", "5", "10", "13", "35"] };
        function getSuggestedPrinciples(improvingParamId, worseningParamId) {
            const key = `${improvingParamId}_${worseningParamId}`;
            const principleIds = simplifiedContradictionMap[key] || simplifiedContradictionMap["default"];
            return principleIds.map(id => inventivePrinciples.find(p => p.id === id)).filter(p => p);
        }

        // --- Utility Functions ---
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        
        function updateUI() {
            document.querySelectorAll('.step-section').forEach(section => section.classList.remove('active'));
            const currentStepSection = document.getElementById(`step${appState.currentStep}`);
            if (currentStepSection) currentStepSection.classList.add('active');
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.tab === `step${appState.currentStep}`) button.classList.add('active');
            });
            
            const prevStepBtn = document.getElementById('prevStepBtn');
            if (prevStepBtn) prevStepBtn.disabled = appState.currentStep === 1;
            
            const nextStepBtn = document.getElementById('nextStepBtn');
            if (nextStepBtn) nextStepBtn.textContent = appState.currentStep === 6 ? '完成並檢視報告' : '下一步';
        }

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const targetStep = parseInt(button.dataset.tab.replace('step', ''));
                saveCurrentStepDataToState(); 
                appState.currentStep = targetStep;
                populateCurrentStepUIFromState(); 
                updateUI();
            });
        });

        function populateAllUIFromState() {
            document.getElementById('keyProblem').value = appState.keyProblem;
            renderRcaCauses();
            renderConflicts();
            renderTrizSolutions();
            renderAbcFiltering();
            renderMcdmCriteria();
            renderMcdmEvaluation();
            renderIdeasLandscapeInputs();
            renderIdeasLandscapePlot(); 
            renderLeanCanvas();
            if (appState.currentStep === 6) renderFinalReport(); 

            updateUI();
            populateCurrentStepUIFromState();
        }
        
        function populateCurrentStepUIFromState() {
            if (appState.currentStep === 1) {
                document.getElementById('keyProblem').value = appState.keyProblem;
                renderRcaCauses();
            }
            if (appState.currentStep === 2) renderConflicts();
            if (appState.currentStep === 3) renderTrizSolutions();
            if (appState.currentStep === 4) { 
                renderAbcFiltering(); 
                renderMcdmCriteria(); 
                renderMcdmEvaluation(); 
                renderIdeasLandscapeInputs(); 
                renderIdeasLandscapePlot(); 
                renderTrizIdealnessAssessment(); 
            }
            if (appState.currentStep === 5) renderLeanCanvas();
            if (appState.currentStep === 6) renderFinalReport(); 
        }

        function saveCurrentStepDataToState() {
            appState.keyProblem = document.getElementById('keyProblem').value; // Always save key problem
            if (document.getElementById('step5').classList.contains('active')) {
                 saveLeanCanvasData(); 
            }
        }


        // --- Step 1: Problem Definition & RCA ---
        const keyProblemTextarea = document.getElementById('keyProblem'); 
        const rcaCausesContainer = document.getElementById('rcaCausesContainer');
        const aiSuggestRcaBtn = document.getElementById('aiSuggestRcaBtn');
        const aiRcaSuggestionsContainer = document.getElementById('aiRcaSuggestionsContainer');

        if (keyProblemTextarea) {
            keyProblemTextarea.addEventListener('input', () => {
                appState.keyProblem = keyProblemTextarea.value;
            });
        }

        document.getElementById('addRcaCauseBtn').addEventListener('click', () => addRcaCause());
        
        aiSuggestRcaBtn.addEventListener('click', async () => {
            const keyProblemText = appState.keyProblem; 
            const notificationId = "aiRcaSuggestions_notification_area";
            if (!keyProblemText.trim()) {
                showNotification("請先在上方描述關鍵問題。", "error", notificationId);
                return;
            }
            const prompt = `針對以下關鍵問題：「${keyProblemText}」，請提出3至5個可能的根本原因（Root Causes）。每個原因請簡潔表述。`;
            const suggestions = await callGeminiAPI(prompt, aiSuggestRcaBtn, notificationId, "AI 分析中...");
            if (suggestions) {
                aiRcaSuggestionsContainer.innerHTML = `<p class="font-semibold mb-1">AI 建議的潛在根本原因：</p><div class="whitespace-pre-wrap p-2 bg-indigo-50 rounded">${suggestions}</div><p class="text-xs mt-1 text-gray-500">您可以參考以上建議，手動將其加入下方的根本原因分析列表。</p>`;
                aiRcaSuggestionsContainer.style.display = 'block';
            } else {
                aiRcaSuggestionsContainer.innerHTML = ''; 
                aiRcaSuggestionsContainer.style.display = 'none'; 
            }
        });

        function addRcaCause(parentId = null, level = 0, initialText = "") {
            const causeId = generateId(); appState.rcaCauses.push({ id: causeId, text: initialText, parentId: parentId, level: level }); renderRcaCauses();
        }
        function renderRcaCauses() {
            rcaCausesContainer.innerHTML = '';
            const buildCauseTree = (parentId = null, level = 0) => {
                appState.rcaCauses.filter(cause => cause.parentId === parentId).forEach(cause => {
                    const causeDiv = document.createElement('div'); causeDiv.className = 'dynamic-list-item mb-2'; causeDiv.style.marginLeft = `${level * 20}px`;
                    const input = document.createElement('input'); input.type = 'text'; input.value = cause.text; input.placeholder = level === 0 ? '主要原因...' : '造成此原因的子原因...'; input.className = 'p-1 border border-gray-300 rounded-md flex-grow'; input.onchange = (e) => cause.text = e.target.value;
                    const removeBtn = document.createElement('button'); removeBtn.textContent = '移除'; removeBtn.className = 'remove-btn text-xs'; removeBtn.onclick = () => { appState.rcaCauses = appState.rcaCauses.filter(c => c.id !== cause.id); removeChildrenCauses(cause.id); renderRcaCauses(); };
                    const addSubCauseBtn = document.createElement('button'); addSubCauseBtn.textContent = '新增子原因'; addSubCauseBtn.className = 'ml-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs py-1 px-2 rounded'; addSubCauseBtn.onclick = () => addRcaCause(cause.id, level + 1);
                    causeDiv.appendChild(input); causeDiv.appendChild(addSubCauseBtn); causeDiv.appendChild(removeBtn); rcaCausesContainer.appendChild(causeDiv); buildCauseTree(cause.id, level + 1);
                });
            }; buildCauseTree();
        }
        function removeChildrenCauses(parentId) {
            const children = appState.rcaCauses.filter(c => c.parentId === parentId);
            children.forEach(child => { removeChildrenCauses(child.id); appState.rcaCauses = appState.rcaCauses.filter(c => c.id !== child.id); });
        }

        // --- Step 2: Conflict Analysis ---
        const conflictAnalysisContainer = document.getElementById('conflictAnalysisContainer');
        const aiSuggestConflictsBtn = document.getElementById('aiSuggestConflictsBtn');
        const aiConflictSuggestionsContainer = document.getElementById('aiConflictSuggestionsContainer');

        document.getElementById('addConflictBtn').addEventListener('click', () => addConflict());

        aiSuggestConflictsBtn.addEventListener('click', async () => {
            const keyProblemText = appState.keyProblem; 
            const notificationId = "aiConflictSuggestions_notification_area";
            if (!keyProblemText.trim()) {
                showNotification("請先在步驟 1 定義關鍵問題。", "error", notificationId);
                return;
            }
            let rcaSummary = "根本原因分析 (RCA) 結果：\n";
            if (appState.rcaCauses.length > 0) {
                appState.rcaCauses.filter(c => c.text.trim() !== "").forEach(c => rcaSummary += `- ${c.text}\n`);
            } else {
                rcaSummary += "尚未定義具體的根本原因。\n";
            }

            const prompt = `我正在解決一個關鍵問題：「${keyProblemText}」。\n${rcaSummary}\n請根據以上問題和已分析的根本原因，提出 2-3 個可能的衝突點。每個衝突點請明確指出「試圖改善的方面（帶來的好處）」以及「因此可能導致惡化的方面（帶來的壞處）」。格式如下：\n衝突點 1:\n好處: [描述好處]\n壞處: [描述壞處]\n相關根本原因(可選): [根本原因]\n`;
            
            const suggestions = await callGeminiAPI(prompt, aiSuggestConflictsBtn, notificationId, "AI 建議中...");
            if (suggestions) {
                aiConflictSuggestionsContainer.innerHTML = `<p class="font-semibold mb-1">AI 建議的潛在衝突點：</p><div class="whitespace-pre-wrap p-2 bg-indigo-50 rounded">${suggestions}</div><p class="text-xs mt-1 text-gray-500">您可以參考以上建議，手動將其加入下方的衝突點列表。</p>`;
                aiConflictSuggestionsContainer.style.display = 'block';
            } else {
                aiConflictSuggestionsContainer.innerHTML = '';
                aiConflictSuggestionsContainer.style.display = 'none';
            }
        });


        function addConflict(initialBenefit = "", initialDrawback = "", initialRcaText = "") { 
            const conflictId = generateId(); 
            appState.conflicts.push({ 
                id: conflictId, 
                rcaCauseText: initialRcaText, 
                benefit: initialBenefit, 
                drawback: initialDrawback 
            }); 
            renderConflicts(); 
        }
        function renderConflicts() {
            conflictAnalysisContainer.innerHTML = '';
            appState.conflicts.forEach((conflict, index) => {
                const div = document.createElement('div'); div.className = 'p-4 border border-gray-200 rounded-md mb-4 shadow';
                div.innerHTML = `<h4 class="font-semibold text-md mb-2">衝突點 ${index + 1}</h4>
                    <div class="mb-2"><label class="block text-sm font-medium text-gray-600">相關根本原因 (可選):</label><input type="text" value="${conflict.rcaCauseText}" onchange="appState.conflicts[${index}].rcaCauseText = this.value" class="w-full p-1 border border-gray-300 rounded-md" placeholder="例如：文卷室工作制度不完善"></div>
                    <div class="mb-2"><label class="block text-sm font-medium text-gray-600">試圖改善的方面 (帶來的好處):</label><input type="text" value="${conflict.benefit}" onchange="appState.conflicts[${index}].benefit = this.value" class="w-full p-1 border border-gray-300 rounded-md" placeholder="例如：人員培養的時間較短"></div>
                    <div class="mb-2"><label class="block text-sm font-medium text-gray-600">導致惡化的方面 (帶來的壞處):</label><input type="text" value="${conflict.drawback}" onchange="appState.conflicts[${index}].drawback = this.value" class="w-full p-1 border border-gray-300 rounded-md" placeholder="例如：文卷室工作制度不完善"></div>
                    <button onclick="removeConflict('${conflict.id}')" class="remove-btn text-xs">移除此衝突</button>`;
                conflictAnalysisContainer.appendChild(div);
            });
        }
        function removeConflict(conflictId) { appState.conflicts = appState.conflicts.filter(c => c.id !== conflictId); appState.trizSolutions = appState.trizSolutions.filter(s => s.conflictId !== conflictId); renderConflicts(); }

        // --- Step 3: TRIZ Solution Generation ---
        const trizSolutionsContainer = document.getElementById('trizSolutionsContainer');
        document.getElementById('addTrizSolutionSetBtn').addEventListener('click', showConflictSelectorForTriz);
        function showConflictSelectorForTriz() {
            const notificationId = "trizSolutionsContainer_notification_area";
            if (appState.conflicts.length === 0) { showNotification("請先在步驟2新增至少一個衝突點。", "error", notificationId); return; }
            const existingSelector = trizSolutionsContainer.querySelector('#trizConflictSelectorContainer');
            if (existingSelector) return; 

            const selectorDiv = document.createElement('div'); selectorDiv.id = 'trizConflictSelectorContainer'; selectorDiv.className = 'mb-4 p-3 border rounded bg-gray-50';
            selectorDiv.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">選擇一個衝突點來生成方案：</label>
                <select id="trizConflictSelector" class="w-full p-2 border border-gray-300 rounded-md"></select>
                <button id="confirmTrizConflictSelect" class="mt-2 bg-purple-500 hover:bg-purple-600 text-white py-1 px-3 rounded text-sm">確定並新增方案區塊</button>`;
            
            const notificationArea = document.getElementById(notificationId); 
            if (notificationArea) {
                notificationArea.insertAdjacentElement('afterend', selectorDiv); 
            } else {
                trizSolutionsContainer.insertBefore(selectorDiv, trizSolutionsContainer.firstChild);
            }

            const selectConflictEl = document.getElementById('trizConflictSelector');
            appState.conflicts.forEach(conflict => { const option = document.createElement('option'); option.value = conflict.id; option.textContent = `衝突: "${conflict.benefit}" vs "${conflict.drawback}"`; selectConflictEl.appendChild(option); });
            document.getElementById('confirmTrizConflictSelect').onclick = () => { if (selectConflictEl.value) { addTrizSolutionSet(selectConflictEl.value); trizSolutionsContainer.removeChild(selectorDiv); } };
        }
        function addTrizSolutionSet(conflictId) { const solutionSetId = generateId(); appState.trizSolutions.push({ id: solutionSetId, conflictId: conflictId, improvingParam: "", worseningParam: "", principles: [] }); renderTrizSolutions(); }
        function renderTrizSolutions() {
            const container = document.getElementById('trizSolutionsContainer');
            const selectorDiv = container.querySelector('#trizConflictSelectorContainer'); 
            const notificationArea = document.getElementById("trizSolutionsContainer_notification_area");
            
            let contentNodes = [];
            appState.trizSolutions.forEach((solutionSet, setIndex) => {
                const conflict = appState.conflicts.find(c => c.id === solutionSet.conflictId); if (!conflict) return;
                const setDiv = document.createElement('div'); setDiv.className = 'p-4 border border-purple-200 rounded-md mb-6 shadow-md bg-white';
                let paramOptions = engineeringParameters.map(p => `<option value="${p.id}" ${solutionSet.improvingParam === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                let paramOptionsWorsening = engineeringParameters.map(p => `<option value="${p.id}" ${solutionSet.worseningParam === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                setDiv.innerHTML = `<h4 class="font-semibold text-lg text-purple-700 mb-2">方案集 (針對衝突: "${conflict.benefit}" vs "${conflict.drawback}")</h4>
                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                        <div><label class="block text-sm font-medium text-gray-600">改善的工程參數:</label><select class="param-select w-full p-1 border border-gray-300 rounded-md" data-type="improving" data-setindex="${setIndex}"><option value="">請選擇...</option>${paramOptions}</select></div>
                        <div><label class="block text-sm font-medium text-gray-600">惡化的工程參數:</label><select class="param-select w-full p-1 border border-gray-300 rounded-md" data-type="worsening" data-setindex="${setIndex}"><option value="">請選擇...</option>${paramOptionsWorsening}</select></div>
                    </div>
                    <div class="suggested-principles-container mt-3 mb-3 p-3 bg-purple-50 border border-purple-100 rounded-md" id="suggestedPrinciples_${solutionSet.id}"></div>
                    <div id="solutionsForSet_${solutionSet.id}"></div>
                    <button onclick="removeTrizSolutionSet('${solutionSet.id}')" class="mt-3 remove-btn text-xs bg-red-500 hover:bg-red-600">移除此方案集</button>`;
                contentNodes.push(setDiv); 
                if (solutionSet.improvingParam && solutionSet.worseningParam) updateSuggestedPrinciples(solutionSet.id, solutionSet.improvingParam, solutionSet.worseningParam, setIndex);
                renderSolutionsForPrinciple(solutionSet.id, setIndex, conflict); 
            });

            container.innerHTML = ''; 
            if (notificationArea) container.appendChild(notificationArea); 
            if (selectorDiv) container.appendChild(selectorDiv); 
            contentNodes.forEach(node => container.appendChild(node)); 

            document.querySelectorAll('.param-select').forEach(select => {
                select.onchange = (e) => {
                    const setIndex = parseInt(e.target.dataset.setindex); const type = e.target.dataset.type;
                    appState.trizSolutions[setIndex][type === 'improving' ? 'improvingParam' : 'worseningParam'] = e.target.value;
                    const currentSolutionSet = appState.trizSolutions[setIndex];
                    const conflictContext = appState.conflicts.find(c => c.id === currentSolutionSet.conflictId);
                    if (currentSolutionSet.improvingParam && currentSolutionSet.worseningParam) updateSuggestedPrinciples(currentSolutionSet.id, currentSolutionSet.improvingParam, currentSolutionSet.worseningParam, setIndex);
                    else { document.getElementById(`suggestedPrinciples_${currentSolutionSet.id}`).innerHTML = '<p class="text-sm text-gray-500">請選擇改善與惡化的工程參數以查看建議原則。</p>'; currentSolutionSet.principles = []; renderSolutionsForPrinciple(currentSolutionSet.id, setIndex, conflictContext); }
                };
            });
        }
        function updateSuggestedPrinciples(solutionSetId, improvingParamId, worseningParamId, setIndex) {
            const principles = getSuggestedPrinciples(improvingParamId, worseningParamId); const container = document.getElementById(`suggestedPrinciples_${solutionSetId}`);
            container.innerHTML = '<h5 class="font-medium text-md text-purple-600 mb-1">建議發明原則:</h5>';
            const currentSolutionSet = appState.trizSolutions[setIndex];
            const conflictContext = appState.conflicts.find(c => c.id === currentSolutionSet.conflictId);

            if (principles.length > 0) {
                const ul = document.createElement('ul'); ul.className = 'list-disc list-inside space-y-1'; principles.forEach(p => { const li = document.createElement('li'); li.className = 'text-sm text-gray-700'; li.textContent = p.name; ul.appendChild(li); }); container.appendChild(ul);
                currentSolutionSet.principles = principles.map(p => ({ id: p.id, name: p.name, solutionText: currentSolutionSet.principles.find(sp => sp.id === p.id)?.solutionText || "" }));
            } else { container.innerHTML = '<p class="text-sm text-gray-500">未找到針對此參數組合的特定建議原則。</p>'; currentSolutionSet.principles = []; }
            renderSolutionsForPrinciple(solutionSetId, setIndex, conflictContext);
        }

        function renderSolutionsForPrinciple(solutionSetId, setIndex, conflict) {
            const solutionInputsContainer = document.getElementById(`solutionsForSet_${solutionSetId}`); 
            solutionInputsContainer.innerHTML = '';
            const currentSolutionSet = appState.trizSolutions[setIndex];

            if (currentSolutionSet.principles && currentSolutionSet.principles.length > 0) {
                const header = document.createElement('h5'); 
                header.className = 'font-medium text-md text-purple-600 mt-4 mb-2'; 
                header.textContent = '針對原則發想具體解決方案:'; 
                solutionInputsContainer.appendChild(header);

                currentSolutionSet.principles.forEach((principle, principleIndex) => {
                    const div = document.createElement('div'); 
                    div.className = 'mb-3 p-2 border border-gray-200 rounded';
                    
                    const label = document.createElement('label');
                    label.className = 'block text-sm font-medium text-gray-700';
                    label.textContent = principle.name + ":";
                    div.appendChild(label);

                    const textareaId = `trizSolutionText_${solutionSetId}_${principle.id}`;
                    const textarea = document.createElement('textarea');
                    textarea.rows = 2;
                    textarea.id = textareaId;
                    textarea.className = 'w-full p-1 border border-gray-300 rounded-md mt-1';
                    textarea.placeholder = `針對 ${principle.name} 原則的具體解決方案...`;
                    textarea.value = principle.solutionText;
                    textarea.onchange = (e) => {
                        appState.trizSolutions[setIndex].principles[principleIndex].solutionText = e.target.value;
                    };
                    div.appendChild(textarea);

                    const aiButton = document.createElement('button');
                    aiButton.innerHTML = `✨ AI 協助發想方案`;
                    aiButton.className = 'mt-1 text-xs bg-sky-500 hover:bg-sky-600 text-white py-1 px-2 rounded-md shadow-sm';
                    const notificationId = `${textareaId}_notification_area`;
                    aiButton.onclick = async () => {
                        const keyProblemText = appState.keyProblem;
                        const conflictText = conflict ? `好處是 "${conflict.benefit}"，但壞處是 "${conflict.drawback}"` : "未指定衝突";
                        const principleName = principle.name;
                        const prompt = `我正在解決一個問題：「${keyProblemText}」。\n目前面臨的衝突是：「${conflictText}」。\n請基於 TRIZ 的「${principleName}」發明原則，針對這個情境，提出2-3個具體的解決方案點子。請讓點子簡潔且具啟發性。`;
                        
                        const suggestions = await callGeminiAPI(prompt, aiButton, notificationId, "AI 發想中...");
                        if (suggestions) {
                            textarea.value += (textarea.value.trim() ? "\n\n--- AI 建議 ---\n" : "") + suggestions;
                            appState.trizSolutions[setIndex].principles[principleIndex].solutionText = textarea.value; 
                            showNotification("AI 建議已加入方案描述中。", "success", notificationId);
                        }
                    };
                    div.appendChild(aiButton);
                    const aiNotificationArea = document.createElement('div'); 
                    aiNotificationArea.id = notificationId; 
                    aiNotificationArea.className = "notification-area";
                    div.appendChild(aiNotificationArea);

                    solutionInputsContainer.appendChild(div);
                });
            }
        }
        function removeTrizSolutionSet(solutionSetId) { appState.trizSolutions = appState.trizSolutions.filter(s => s.id !== solutionSetId); renderTrizSolutions(); }

        // --- Step 4: Evaluation ---
        const aiSuggestMcdmCriteriaBtn = document.getElementById('aiSuggestMcdmCriteriaBtn');
        const aiMcdmCriteriaSuggestionsContainer = document.getElementById('aiMcdmCriteriaSuggestionsContainer');
        const aiAnalyzeLandscapeBtn = document.getElementById('aiAnalyzeLandscapeBtn');
        const aiLandscapeAnalysisContainer = document.getElementById('aiLandscapeAnalysisContainer');


        aiSuggestMcdmCriteriaBtn.addEventListener('click', async () => {
            const keyProblemText = appState.keyProblem;
            const notificationId = "aiMcdmCriteriaSuggestions_notification_area";
            if (!keyProblemText.trim()) {
                showNotification("請先在步驟 1 定義關鍵問題。", "error", notificationId);
                return;
            }
            let solutionsSummary = "目前考慮的A級解決方案有：\n";
            const aSolutions = getASolutions();
            if (aSolutions.length > 0) {
                aSolutions.slice(0, 5).forEach(s => solutionsSummary += `- ${s.text.substring(0, 70)}...\n`); 
            } else {
                solutionsSummary += "尚未選定A級解決方案。\n";
            }

            const prompt = `我正在為解決「${keyProblemText}」這個問題評估方案。\n${solutionsSummary}請建議 3-5 個適合用來進行多準則決策評估 (MCDM) 的評估準則。準則應涵蓋可行性、影響力、成本效益、創新性等不同面向。請直接列出準則名稱即可，例如「技術可行性」。`;
            
            const suggestions = await callGeminiAPI(prompt, aiSuggestMcdmCriteriaBtn, notificationId, "AI 建議中...");
            if (suggestions) {
                aiMcdmCriteriaSuggestionsContainer.innerHTML = `<p class="font-semibold mb-1">AI 建議的評估準則：</p><div class="whitespace-pre-wrap p-2 bg-indigo-50 rounded">${suggestions}</div><p class="text-xs mt-1 text-gray-500">您可以參考以上建議，手動將其加入下方的準則列表。</p>`;
                aiMcdmCriteriaSuggestionsContainer.style.display = 'block';
            } else {
                aiMcdmCriteriaSuggestionsContainer.innerHTML = '';
                aiMcdmCriteriaSuggestionsContainer.style.display = 'none';
            }
        });

        aiAnalyzeLandscapeBtn.addEventListener('click', async () => {
            let landscapeData = "創意景觀圖資料：\n";
            let dataPointsCount = 0;
            const notificationId = "aiLandscapeAnalysis_notification_area";
            getASolutions().forEach(sol => {
                let totalScore = 0;
                if (appState.mcdmScores[sol.id] && appState.mcdmCriteria.length > 0) {
                    appState.mcdmCriteria.forEach(crit => totalScore += (appState.mcdmScores[sol.id][crit.id] || 0) * (crit.weight || 1));
                }
                const time = appState.solutionImplementationTimes[sol.id] || 5;
                landscapeData += `- 方案: ${sol.text.substring(0, 50)}... (導入時間: ${time}, MCDM總分: ${totalScore.toFixed(1)})\n`;
                dataPointsCount++;
            });

            if (dataPointsCount === 0) {
                showNotification("景觀圖尚無資料可供分析。請先完成A級方案評分與導入時間設定。", "error", notificationId);
                return;
            }
            const prompt = `以下是創意景觀圖的資料點，橫軸代表導入所需時間（1短-10長），縱軸代表MCDM總分（越高越好）。圖分為四個象限：\nII. 優先 (時間短, 分數高)\nI. 長期 (時間長, 分數高)\nIII. 捨棄 (時間短, 分數低)\nIV. 避免 (時間長, 分數低)\n\n資料：\n${landscapeData}\n請分析這些資料點在景觀圖上的分佈，指出哪些方案可能落在「優先」或「長期」象限，並提供簡短的策略建議（例如，應優先考慮哪些方案，哪些方案可能需要更多資源或時間）。`;

            const analysis = await callGeminiAPI(prompt, aiAnalyzeLandscapeBtn, notificationId, "AI 分析中...");
            if (analysis) {
                aiLandscapeAnalysisContainer.innerHTML = `<p class="font-semibold mb-1">AI 對景觀圖的分析：</p><div class="whitespace-pre-wrap p-2 bg-indigo-50 rounded">${analysis}</div>`;
                aiLandscapeAnalysisContainer.style.display = 'block';
            } else {
                aiLandscapeAnalysisContainer.innerHTML = '';
                aiLandscapeAnalysisContainer.style.display = 'none';
            }
        });


        function renderAbcFiltering() {
            const container = document.getElementById('abcFilteringContainer'); container.innerHTML = ''; let solutionCount = 0;
            appState.trizSolutions.forEach(set => {
                set.principles.forEach(principle => {
                    if (principle.solutionText && principle.solutionText.trim() !== "") {
                        solutionCount++; const solutionId = `${set.id}_${principle.id}`; const div = document.createElement('div');
                        div.className = 'p-3 mb-2 border rounded-md flex justify-between items-center';
                        div.innerHTML = `<p class="text-sm flex-grow mr-4">方案: ${principle.solutionText.substring(0,50)}... (來自原則: ${principle.name})</p>
                            <select class="p-1 border border-gray-300 rounded-md text-sm" onchange="appState.abcCategories['${solutionId}'] = this.value; renderMcdmEvaluation(); renderIdeasLandscapeInputs();">
                                <option value="" ${!appState.abcCategories[solutionId] ? 'selected' : ''}>選擇等級</option> <option value="A" ${appState.abcCategories[solutionId] === 'A' ? 'selected' : ''}>A (值得考慮)</option>
                                <option value="B" ${appState.abcCategories[solutionId] === 'B' ? 'selected' : ''}>B (有懷疑)</option> <option value="C" ${appState.abcCategories[solutionId] === 'C' ? 'selected' : ''}>C (不考慮)</option>
                            </select>`;
                        container.appendChild(div);
                    }
                });
            });
            if (solutionCount === 0) container.innerHTML = '<p class="text-sm text-gray-500">請先在步驟3生成解決方案。</p>';
        }
        const mcdmCriteriaContainer = document.getElementById('mcdmCriteriaContainer');
        document.getElementById('addMcdmCriterionBtn').addEventListener('click', () => addMcdmCriterion());
        function addMcdmCriterion(name = "", type = "problem-specific", weight = 1) { 
            const criterionId = generateId(); 
            appState.mcdmCriteria.push({ id: criterionId, name: name, type: type, weight: weight }); 
            renderMcdmCriteria(); 
        }
        function renderMcdmCriteria() {
            mcdmCriteriaContainer.innerHTML = ''; if (appState.mcdmCriteria.length === 0) mcdmCriteriaContainer.innerHTML = '<p class="text-sm text-gray-500 mb-2">尚未新增評估準則。</p>';
            appState.mcdmCriteria.forEach((criterion, index) => {
                const div = document.createElement('div'); div.className = 'dynamic-list-item items-end gap-2 mb-2 p-2 border bg-gray-50 rounded';
                div.innerHTML = `<div class="flex-grow"><label class="text-xs text-gray-500">準則 ${index + 1} 名稱:</label><input type="text" value="${criterion.name}" class="w-full p-1 border border-gray-300 rounded-md text-sm" placeholder="例如：確保準時送達" onchange="appState.mcdmCriteria[${index}].name = this.value"></div>
                    <div class="w-1/4"><label class="text-xs text-gray-500">類型:</label><select class="w-full p-1 border border-gray-300 rounded-md text-sm" onchange="appState.mcdmCriteria[${index}].type = this.value"><option value="problem-specific" ${criterion.type === 'problem-specific' ? 'selected' : ''}>問題特定</option><option value="triz-idealness" ${criterion.type === 'triz-idealness' ? 'selected' : ''}>TRIZ理想性</option><option value="general" ${criterion.type === 'general' ? 'selected' : ''}>一般性</option></select></div>
                    <div class="w-1/6"><label class="text-xs text-gray-500">權重:</label><input type="number" value="${criterion.weight}" min="0" step="0.1" class="w-full p-1 border border-gray-300 rounded-md text-sm" placeholder="權重" onchange="appState.mcdmCriteria[${index}].weight = parseFloat(this.value) || 1"></div>
                    <button onclick="removeMcdmCriterion('${criterion.id}')" class="remove-btn text-xs self-center">移除</button>`;
                mcdmCriteriaContainer.appendChild(div);
            }); renderMcdmEvaluation();
        }
        function removeMcdmCriterion(criterionId) { appState.mcdmCriteria = appState.mcdmCriteria.filter(c => c.id !== criterionId); Object.keys(appState.mcdmScores).forEach(solId => delete appState.mcdmScores[solId][criterionId]); renderMcdmCriteria(); }
        function renderMcdmEvaluation() {
            const container = document.getElementById('mcdmEvaluationContainer'); container.innerHTML = '<h4 class="text-lg font-medium text-gray-700 mb-2">A級方案評分:</h4>';
            const aSolutions = getASolutions(); if (aSolutions.length === 0 || appState.mcdmCriteria.length === 0) { container.innerHTML += '<p class="text-sm text-gray-500">沒有A級方案或未設定評估準則。</p>'; return; }
            const table = document.createElement('table'); table.className = 'w-full border-collapse border border-gray-300 text-sm';
            let headerHtml = '<thead><tr class="bg-gray-100"><th class="border p-2">方案</th>'; appState.mcdmCriteria.forEach(c => headerHtml += `<th class="border p-2">${c.name} (權重:${c.weight})</th>`); headerHtml += '<th class="border p-2">總分</th></tr></thead>'; table.innerHTML = headerHtml;
            const tbody = document.createElement('tbody');
            aSolutions.forEach(sol => {
                const row = document.createElement('tr'); let rowHtml = `<td class="border p-2">${sol.text.substring(0,30)}... <span class="text-xs text-gray-500">(${sol.principleName})</span></td>`; let totalScore = 0;
                appState.mcdmCriteria.forEach(crit => {
                    if (!appState.mcdmScores[sol.id]) appState.mcdmScores[sol.id] = {}; const score = appState.mcdmScores[sol.id][crit.id] || 0;
                    rowHtml += `<td class="border p-2"><input type="number" value="${score}" min="-5" max="5" step="1" class="w-16 p-1 border rounded" onchange="appState.mcdmScores['${sol.id}']['${crit.id}'] = parseInt(this.value) || 0; renderMcdmEvaluation(); renderIdeasLandscapeInputs();"></td>`;
                    totalScore += (parseInt(score) || 0) * (crit.weight || 1);
                });
                rowHtml += `<td class="border p-2 font-semibold">${totalScore.toFixed(1)}</td>`; row.innerHTML = rowHtml; tbody.appendChild(row);
            }); table.appendChild(tbody); container.appendChild(table);
        }
        const ideasLandscapeInputContainer = document.getElementById('ideasLandscapeInputContainer');
        document.getElementById('generateIdeasLandscapeBtn').addEventListener('click', renderIdeasLandscapePlot);
        function renderIdeasLandscapeInputs() {
            ideasLandscapeInputContainer.innerHTML = '<h5 class="text-md font-medium text-gray-600 mb-2">設定A級方案的導入所需時間 (1=短, 10=長):</h5>';
            const aSolutions = getASolutions(); if (aSolutions.length === 0) { ideasLandscapeInputContainer.innerHTML += '<p class="text-sm text-gray-500">沒有A級方案。</p>'; return; }
            aSolutions.forEach(sol => {
                const div = document.createElement('div'); div.className = 'flex items-center mb-2'; const timeValue = appState.solutionImplementationTimes[sol.id] || 5;
                div.innerHTML = `<label class="text-sm text-gray-700 w-3/5 truncate" title="${sol.text}">${sol.text.substring(0,40)}... :</label>
                    <input type="number" value="${timeValue}" min="1" max="10" step="1" class="w-1/5 p-1 border rounded-md ml-2" onchange="appState.solutionImplementationTimes['${sol.id}'] = parseInt(this.value) || 5;">`;
                ideasLandscapeInputContainer.appendChild(div);
            });
        }
        function renderIdeasLandscapePlot() {
            const plotContainer = document.getElementById('ideasLandscapePlotContainer');
            const existingPoints = plotContainer.querySelectorAll('.plot-point'); existingPoints.forEach(p => p.remove());
            const aSolutionsData = []; let maxScore = -Infinity; let minScore = Infinity;
            getASolutions().forEach(sol => {
                let totalScore = 0; if (appState.mcdmScores[sol.id] && appState.mcdmCriteria.length > 0) { appState.mcdmCriteria.forEach(crit => totalScore += (appState.mcdmScores[sol.id][crit.id] || 0) * (crit.weight || 1)); }
                if (isFinite(totalScore)) { 
                    if (totalScore > maxScore) maxScore = totalScore; 
                    if (totalScore < minScore) minScore = totalScore;
                }
                aSolutionsData.push({ id: sol.id, text: sol.text, time: appState.solutionImplementationTimes[sol.id] || 5, score: totalScore });
            });
            if (aSolutionsData.length === 0) return;
            if (minScore === Infinity) minScore = 0; 
            if (maxScore === -Infinity) maxScore = 0;

            const scoreRange = (maxScore - minScore === 0) ? 1 : (maxScore - minScore); 
            aSolutionsData.forEach((sol, index) => {
                if (!isFinite(sol.score)) sol.score = minScore; 
                const point = document.createElement('div'); point.className = 'plot-point';
                const xPercent = ((sol.time - 1) / 9) * 90 + 5; 
                let yPercent = (((sol.score - minScore) / scoreRange) * 90 + 5);
                if (maxScore === minScore) yPercent = 50; 
                point.style.left = `${xPercent}%`; point.style.bottom = `${yPercent}%`;
                const tooltip = document.createElement('span'); tooltip.className = 'tooltip'; tooltip.textContent = `方案 ${index+1}: ${sol.text.substring(0,20)}... (時間: ${sol.time}, 分數: ${sol.score.toFixed(1)})`;
                point.appendChild(tooltip); plotContainer.appendChild(point);
            });
        }
        const trizIdealnessContainer = document.getElementById('trizIdealnessContainer');
        document.getElementById('startTrizIdealnessBtn').addEventListener('click', renderTrizIdealnessAssessment);
        const idealnessCriteria = [ { name: "問題是否完全解決", weight: 5, key: "fullySolved" }, { name: "是否為雙贏策略", weight: 4, key: "winWin" }, { name: "是否有負面效應", weight: 3, key: "negativeEffects" }, { name: "多符合理想性 (低成本/資源)", weight: 2, key: "lowCost" }];
        function renderTrizIdealnessAssessment() {
            trizIdealnessContainer.innerHTML = ''; const topSolutions = getTopSolutionsByMcdm(3);
            if (topSolutions.length === 0) { trizIdealnessContainer.innerHTML = '<p class="text-sm text-gray-500">無足夠A級方案或MCDM評分。</p>'; return; }
            const table = document.createElement('table'); table.className = 'w-full border-collapse border border-gray-300 text-sm mt-2';
            let headerHtml = '<thead><tr class="bg-gray-100"><th class="border p-2">Top 方案</th>'; idealnessCriteria.forEach(c => headerHtml += `<th class="border p-2">${c.name} (權重:${c.weight})</th>`); headerHtml += '<th class="border p-2">理想性總分</th></tr></thead>'; table.innerHTML = headerHtml;
            const tbody = document.createElement('tbody');
            topSolutions.forEach(sol => {
                const row = document.createElement('tr'); let rowHtml = `<td class="border p-2">${sol.text.substring(0,30)}...</td>`; let idealTotalScore = 0;
                if (!appState.trizIdealnessScores[sol.id]) appState.trizIdealnessScores[sol.id] = {};
                idealnessCriteria.forEach(crit => {
                    const score = appState.trizIdealnessScores[sol.id]?.[crit.key] || 0;
                    rowHtml += `<td class="border p-2"><input type="number" value="${score}" min="0" max="5" step="1" class="w-16 p-1 border rounded" onchange="appState.trizIdealnessScores['${sol.id}']['${crit.key}'] = parseInt(this.value) || 0; renderTrizIdealnessAssessment();"></td>`;
                    idealTotalScore += (parseInt(score) || 0) * crit.weight;
                });
                rowHtml += `<td class="border p-2 font-semibold">${idealTotalScore}</td>`; row.innerHTML = rowHtml; tbody.appendChild(row);
            }); table.appendChild(tbody); trizIdealnessContainer.appendChild(table);
        }
        function getASolutions() {
            const solutions = []; appState.trizSolutions.forEach(set => { set.principles.forEach(principle => { if (principle.solutionText && principle.solutionText.trim() !== "") { const solutionId = `${set.id}_${principle.id}`; if (appState.abcCategories[solutionId] === 'A') solutions.push({ id: solutionId, text: principle.solutionText, principleName: principle.name }); } }); }); return solutions;
        }
        function getTopSolutionsByMcdm(count = 3) {
            const aSolutionsScores = []; getASolutions().forEach(sol => { let totalScore = 0; if (appState.mcdmScores[sol.id] && appState.mcdmCriteria.length > 0) { appState.mcdmCriteria.forEach(crit => totalScore += (appState.mcdmScores[sol.id][crit.id] || 0) * (crit.weight || 1)); } aSolutionsScores.push({ ...sol, mcdmScore: totalScore }); });
            aSolutionsScores.sort((a, b) => b.mcdmScore - a.mcdmScore); return aSolutionsScores.slice(0, count);
        }
        
        // --- Step 5: Lean Canvas ---
        const leanCanvasGridContainer = document.getElementById('leanCanvasGridContainer');
        const leanCanvasFields = [ 
            { key: "problem", label: "問題 (Problem)", placeholder: "您的目標客群面臨哪1-3個最主要的問題？這些問題如何影響他們？(可參考步驟1)", cssClass: "lc-problem" },
            { key: "solution", label: "解決方案 (Solution)", placeholder: "針對上述問題，您的核心解決方案是什麼？它如何運作？(可參考步驟4選定方案)", cssClass: "lc-solution" },
            { key: "uniqueValueProposition", label: "獨特價值主張 (UVP)", placeholder: "您的方案為何與眾不同且值得選擇？用一句話總結顧客能獲得的核心利益與獨特之處。", cssClass: "lc-uvp" },
            { key: "keyMetrics", label: "關鍵指標 (Key Metrics)", placeholder: "您將如何衡量解決方案的成功與業務進展？(例如：用戶數、轉換率、顧客滿意度)", cssClass: "lc-key-metrics" },
            { key: "unfairAdvantage", label: "不公平競爭優勢", placeholder: "您的方案有什麼是競爭對手難以複製或超越的？(例如：專利、品牌、社群、獨家資源)", cssClass: "lc-unfair-advantage" },
            { key: "channels", label: "通路 (Channels)", placeholder: "您將如何接觸、教育並交付價值給您的目標客群？(例如：線上廣告、社群媒體、合作夥伴)", cssClass: "lc-channels" },
            { key: "customerSegments", label: "目標客群 (Customer Segments)", placeholder: "您的解決方案主要服務哪些特定群體？他們有哪些共同特徵？(思考誰最能從您的UVP中受益)", cssClass: "lc-customer-segments" },
            { key: "costStructure", label: "成本結構 (Cost Structure)", placeholder: "推動此解決方案最重要的成本有哪些？(例如：研發、行銷、營運、人事)", cssClass: "lc-cost-structure" },
            { key: "revenueStreams", label: "收入來源 (Revenue Streams)", placeholder: "顧客會為您的解決方案的哪些價值付費？您將如何收費？(例如：一次性購買、訂閱、服務費)", cssClass: "lc-revenue-streams" }
        ];

        function renderLeanCanvas() {
            leanCanvasGridContainer.innerHTML = ''; 
            leanCanvasFields.forEach(field => {
                const cell = document.createElement('div'); cell.className = `lean-canvas-cell ${field.cssClass}`;
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'flex justify-between items-center mb-1';

                const label = document.createElement('label'); 
                label.htmlFor = `lc-${field.key}`; 
                label.textContent = field.label;
                labelDiv.appendChild(label);

                const aiButton = document.createElement('button');
                aiButton.innerHTML = `✨ AI 建議`;
                aiButton.className = 'text-xs bg-sky-500 hover:bg-sky-600 text-white py-1 px-2 rounded-md shadow-sm';
                const notificationId = `aiNotification_lc_${field.key}`;
                aiButton.onclick = async () => {
                    const keyProblemText = appState.keyProblem;
                    const solutionText = appState.leanCanvas.solution || "尚未定義解決方案";
                    const fieldLabel = field.label;
                    const existingContent = appState.leanCanvas[field.key] || "";

                    let prompt = `我正在為一個創新方案製作精實畫布。\n`;
                    prompt += `主要問題是：「${keyProblemText}」。\n`;
                    prompt += `核心解決方案是：「${solutionText}」。\n`;
                    if (existingContent) {
                        prompt += `目前「${fieldLabel}」區塊的內容是：「${existingContent}」。\n`;
                        prompt += `請針對「${fieldLabel}」這個區塊，根據以上資訊，提供更豐富或不同的建議（2-3點）。`;
                    } else {
                        prompt += `請針對「${fieldLabel}」這個區塊，根據以上資訊，提供初步的填寫建議（2-3點）。`;
                    }
                    prompt += `請讓建議具體且有啟發性。`;
                    
                    const suggestions = await callGeminiAPI(prompt, aiButton, notificationId, "AI 建議中...");
                    if (suggestions) {
                        const targetTextarea = document.getElementById(`lc-${field.key}`);
                        targetTextarea.value += (targetTextarea.value.trim() ? "\n\n--- AI 建議 ---\n" : "") + suggestions;
                        appState.leanCanvas[field.key] = targetTextarea.value; 
                        showNotification(`AI 建議已加入「${fieldLabel}」區塊。`, "success", notificationId);
                    }
                };
                labelDiv.appendChild(aiButton);
                cell.appendChild(labelDiv);

                const textarea = document.createElement('textarea'); 
                textarea.id = `lc-${field.key}`; 
                textarea.name = field.key; 
                textarea.rows = 4; 
                textarea.placeholder = field.placeholder; 
                textarea.value = appState.leanCanvas[field.key] || "";
                textarea.onchange = (e) => { appState.leanCanvas[field.key] = e.target.value; };
                cell.appendChild(textarea); 
                
                const aiNotificationArea = document.createElement('div'); 
                aiNotificationArea.id = notificationId;
                aiNotificationArea.className = "notification-area";
                cell.appendChild(aiNotificationArea);

                leanCanvasGridContainer.appendChild(cell);
            });
        }
        
        document.getElementById('prefillLeanCanvasProblemBtn').addEventListener('click', () => {
            appState.leanCanvas.problem = appState.keyProblem;
            const problemTextarea = document.getElementById('lc-problem');
            if(problemTextarea) problemTextarea.value = appState.keyProblem;
        });

        document.getElementById('prefillLeanCanvasSolutionBtn').addEventListener('click', () => {
            const topASolution = getTopSolutionsByMcdm(1);
            const notificationId = "leanCanvasGridContainer_notification_area";
            if (topASolution.length > 0) {
                const solutionText = topASolution[0].text;
                appState.leanCanvas.solution = solutionText;
                appState.leanCanvas.selectedSolutionTextForCanvas = solutionText; 

                const solutionTextarea = document.getElementById('lc-solution');
                if(solutionTextarea) solutionTextarea.value = solutionText;

                const suggestedUVP = `我們的解決方案「${solutionText.substring(0, 25)}...」提供獨特的價值，因為它能 [提示：簡述此方案如何比其他方式更好地解決問題，或其獨特之處，例如：更有效率、成本更低、體驗更好等]。`;
                appState.leanCanvas.uniqueValueProposition = suggestedUVP;
                const uvpTextarea = document.getElementById('lc-uniqueValueProposition');
                if(uvpTextarea) uvpTextarea.value = suggestedUVP;

            } else {
                showNotification("尚未評選出A級方案，或A級方案無MCDM評分。請先完成步驟4的評估。", "error", notificationId);
            }
        });

        function saveLeanCanvasData() {
            leanCanvasFields.forEach(field => {
                const textarea = document.getElementById(`lc-${field.key}`);
                if (textarea) appState.leanCanvas[field.key] = textarea.value;
            });
        }

        // --- Step 6: Final Report ---
        const finalReportContainer = document.getElementById('finalReportContainer');
        const aiGenerateReportSummaryBtn = document.getElementById('aiGenerateReportSummaryBtn');
        const aiReportSummaryContainer = document.getElementById('aiReportSummaryContainer');

        document.getElementById('generateReportBtn').addEventListener('click', renderFinalReport);
        
        aiGenerateReportSummaryBtn.addEventListener('click', async () => {
            saveCurrentStepDataToState(); 
            const notificationId = "aiReportSummaryContainer_notification_area";
            let reportContext = `這是一份創新問題解決報告的內容：\n`;
            reportContext += `1. 關鍵問題: ${appState.keyProblem || "未定義"}\n\n`;
            
            reportContext += `2. 根本原因分析:\n`;
            let rcaTexts = [];
            const collectRca = (parentId = null) => { appState.rcaCauses.filter(c => c.parentId === parentId && c.text.trim() !== "").forEach(cause => { rcaTexts.push(cause.text); collectRca(cause.id); }); };
            collectRca();
            reportContext += rcaTexts.length > 0 ? rcaTexts.join("; ") : "未記錄根本原因";
            reportContext += `\n\n`;

            reportContext += `3. 衝突分析:\n`;
            appState.conflicts.forEach(c => { reportContext += `衝突點 - 好處: ${c.benefit}, 壞處: ${c.drawback} (相關原因: ${c.rcaCauseText || "未指定"})\n`; });
            if (appState.conflicts.length === 0) reportContext += "未記錄衝突點\n";
            reportContext += `\n`;

            reportContext += `4. 最佳潛在解決方案 (A級):\n`;
            const topSolutions = getTopSolutionsByMcdm(3); 
            topSolutions.forEach(s => { reportContext += `- ${s.text} (基於原則: ${s.principleName}, MCDM分數: ${s.mcdmScore.toFixed(1)})\n`; });
            if (topSolutions.length === 0) reportContext += "沒有A級解決方案或未完成評分\n";
            reportContext += `\n`;
            
            reportContext += `5. 精實畫布摘要:\n`;
            leanCanvasFields.forEach(field => {
                if (appState.leanCanvas[field.key] && appState.leanCanvas[field.key].trim() !== "") {
                    reportContext += `${field.label}: ${appState.leanCanvas[field.key].substring(0, 100)}...\n`; 
                }
            });
            if (!Object.values(appState.leanCanvas).some(val => val && val.trim() !== "")) reportContext += "尚未填寫精實畫布內容。\n";

            const prompt = `請根據以下提供的創新問題解決流程中的資料，產生一份簡潔（約150-250字）的整體報告摘要，點出關鍵問題、主要解決方向以及商業潛力（如果精實畫布有相關資訊）。摘要內容應流暢且專業。\n\n資料如下：\n${reportContext}`;

            const summary = await callGeminiAPI(prompt, aiGenerateReportSummaryBtn, notificationId, "AI 撰寫摘要中...");
            if (summary) {
                aiReportSummaryContainer.innerHTML = `<p class="font-semibold mb-1">AI 產生的報告摘要：</p><div class="whitespace-pre-wrap p-2 bg-indigo-50 rounded">${summary}</div>`;
                aiReportSummaryContainer.style.display = 'block';
            } else {
                aiReportSummaryContainer.innerHTML = '';
                aiReportSummaryContainer.style.display = 'none';
            }
        });


        function renderFinalReport() {
            finalReportContainer.innerHTML = ''; saveCurrentStepDataToState(); 
            finalReportContainer.innerHTML += `<div class="mb-6 p-4 border rounded-lg shadow"><h3 class="text-xl font-semibold text-gray-800 mb-2">1. 關鍵問題</h3><p class="text-gray-700 whitespace-pre-wrap">${appState.keyProblem || "未定義"}</p></div>`;
            let rcaHtml = `<div class="mb-6 p-4 border rounded-lg shadow"><h3 class="text-xl font-semibold text-gray-800 mb-2">2. 根本原因分析</h3>`;
            const rcaList = document.createElement('ul'); rcaList.className = 'list-disc list-inside ml-4 text-gray-700';
            const buildRcaList = (parentId = null, level = 0) => { appState.rcaCauses.filter(c => c.parentId === parentId && c.text.trim() !== "").forEach(cause => { const li = document.createElement('li'); li.style.marginLeft = `${level * 15}px`; li.className = "whitespace-pre-wrap"; li.textContent = cause.text; rcaList.appendChild(li); buildRcaList(cause.id, level + 1); }); }; buildRcaList();
            if (rcaList.children.length === 0) rcaList.innerHTML = '<li class="text-gray-500">未記錄根本原因</li>'; rcaHtml += rcaList.outerHTML + `</div>`; finalReportContainer.innerHTML += rcaHtml;
            let conflictHtml = `<div class="mb-6 p-4 border rounded-lg shadow"><h3 class="text-xl font-semibold text-gray-800 mb-2">3. 衝突分析</h3>`;
            if (appState.conflicts.length > 0) { const conflictList = document.createElement('ul'); conflictList.className = 'list-decimal list-inside ml-4 text-gray-700 space-y-2'; appState.conflicts.forEach(c => { const li = document.createElement('li'); li.innerHTML = `相關原因: <span class="font-medium">${c.rcaCauseText || "未指定"}</span><br><span class="ml-4"><strong>好處:</strong> ${c.benefit}</span><br><span class="ml-4"><strong>壞處:</strong> ${c.drawback}</span>`; conflictList.appendChild(li); }); conflictHtml += conflictList.outerHTML; } else { conflictHtml += '<p class="text-gray-500">未記錄衝突點</p>'; } conflictHtml += `</div>`; finalReportContainer.innerHTML += conflictHtml;
            let solutionsHtml = `<div class="mb-6 p-4 border rounded-lg shadow"><h3 class="text-xl font-semibold text-gray-800 mb-2">4. 潛在解決方案 (A級)</h3>`;
            const aSolutionsReport = getTopSolutionsByMcdm(15); 
            if (aSolutionsReport.length > 0) { const solList = document.createElement('ul'); solList.className = 'list-decimal list-inside ml-4 text-gray-700 space-y-1'; aSolutionsReport.forEach(s => { const li = document.createElement('li'); li.innerHTML = `${s.text} (基於原則: ${s.principleName}, MCDM分數: ${s.mcdmScore.toFixed(1)})`; solList.appendChild(li); }); solutionsHtml += solList.outerHTML; } else { solutionsHtml += '<p class="text-gray-500">沒有A級解決方案或未完成評分</p>'; } solutionsHtml += `</div>`; finalReportContainer.innerHTML += solutionsHtml;
            
            let leanCanvasHtml = `<div class="mb-6 p-4 border rounded-lg shadow"><h3 class="text-xl font-semibold text-gray-800 mb-2">5. 精實畫布 (Lean Canvas)</h3>`;
            const canvasTargetSolution = appState.leanCanvas.selectedSolutionTextForCanvas || appState.leanCanvas.solution;
            if (canvasTargetSolution && canvasTargetSolution.trim() !== "") {
                leanCanvasHtml += `<p class="text-sm text-gray-600 mb-3">此精實畫布針對方案：「<span class="font-semibold">${canvasTargetSolution}</span>」進行規劃。</p>`;
            }

            let lcContentAdded = false; const dl = document.createElement('dl'); dl.className = 'space-y-3';
            leanCanvasFields.forEach(field => { if (appState.leanCanvas[field.key] && appState.leanCanvas[field.key].trim() !== "") { lcContentAdded = true; const dt = document.createElement('dt'); dt.className = "font-semibold text-gray-600"; dt.textContent = field.label + ":"; const dd = document.createElement('dd'); dd.className = "ml-4 text-gray-700 whitespace-pre-wrap"; dd.textContent = appState.leanCanvas[field.key]; dl.appendChild(dt); dl.appendChild(dd); } });
            if (lcContentAdded) leanCanvasHtml += dl.outerHTML; else leanCanvasHtml += '<p class="text-gray-500">尚未填寫精實畫布內容。</p>';
            leanCanvasHtml += `</div>`; finalReportContainer.innerHTML += leanCanvasHtml;

            let finalChoiceHtml = `<div class="mb-6 p-4 border rounded-lg shadow"><h3 class="text-xl font-semibold text-gray-800 mb-2">6. 建議方案 (依評估排序)</h3>`;
            const topMcdm = getTopSolutionsByMcdm(5); if(topMcdm.length > 0){ finalChoiceHtml += `<h4 class="text-lg font-medium text-gray-700 mt-2 mb-1">依MCDM總分:</h4><ul class="list-disc list-inside ml-4 text-gray-600">`; topMcdm.forEach(s => finalChoiceHtml += `<li>${s.text.substring(0,50)}... (MCDM 分數: ${s.mcdmScore.toFixed(1)})</li>`); finalChoiceHtml += `</ul>`; }
            const idealSolutionsRanked = []; Object.keys(appState.trizIdealnessScores).forEach(solId => { let totalIdealScore = 0; const solDetails = findSolutionById(solId); if (solDetails) { idealnessCriteria.forEach(crit => totalIdealScore += (appState.trizIdealnessScores[solId][crit.key] || 0) * crit.weight); idealSolutionsRanked.push({ text: solDetails.text, idealScore: totalIdealScore }); } });
            idealSolutionsRanked.sort((a,b) => b.idealScore - a.idealScore); if(idealSolutionsRanked.length > 0){ finalChoiceHtml += `<h4 class="text-lg font-medium text-gray-700 mt-3 mb-1">依TRIZ理想性評估:</h4><ul class="list-disc list-inside ml-4 text-gray-600">`; idealSolutionsRanked.slice(0,3).forEach(s => finalChoiceHtml += `<li>${s.text.substring(0,50)}... (理想性分數: ${s.idealScore})</li>`); finalChoiceHtml += `</ul>`; }
            if(topMcdm.length === 0 && idealSolutionsRanked.length === 0) finalChoiceHtml += '<p class="text-gray-500">尚無足夠評估資料以建議方案。</p>';
            finalChoiceHtml += `</div>`; finalReportContainer.innerHTML += finalChoiceHtml;
        }
        function findSolutionById(solutionIdToFind) { for (const set of appState.trizSolutions) { for (const principle of set.principles) { if (principle.solutionText && principle.solutionText.trim() !== "") { const currentSolutionId = `${set.id}_${principle.id}`; if (currentSolutionId === solutionIdToFind) return { id: currentSolutionId, text: principle.solutionText, principleName: principle.name }; } } } return null; }

        // --- Navigation Logic ---
        document.getElementById('nextStepBtn').addEventListener('click', () => { 
            if (appState.currentStep < 6) { 
                saveCurrentStepDataToState(); 
                appState.currentStep++; 
                populateCurrentStepUIFromState(); 
                updateUI(); 
            } else { 
                renderFinalReport(); 
                showNotification("已到達流程結尾！請檢視最終報告。", "info", "globalNotification", 5000);
            } 
        });
        document.getElementById('prevStepBtn').addEventListener('click', () => { 
            if (appState.currentStep > 1) { 
                saveCurrentStepDataToState(); 
                appState.currentStep--; 
                populateCurrentStepUIFromState(); 
                updateUI(); 
            } 
        });

        // --- Progress Management (Save/Load/Upload/Download) ---
        const progressModal = document.getElementById('progressModal');
        const manageProgressBtn = document.getElementById('manageProgressBtn');
        const closeProgressModalBtn = document.getElementById('closeProgressModalBtn');
        const saveNewProgressBtn = document.getElementById('saveNewProgressBtn');
        const progressNameInput = document.getElementById('progressNameInput');
        const savedProgressListEl = document.getElementById('savedProgressList');
        const globalNotificationEl = document.getElementById('globalNotification'); 
        const uploadProgressInput = document.getElementById('uploadProgressInput');
        const downloadProgressBtn = document.getElementById('downloadProgressBtn');


        function showNotification(message, type = 'info', targetId = 'globalNotification', duration = 3000) {
            let notificationElement = document.getElementById(targetId);
            
            if (!notificationElement) { 
                if (targetId === 'globalNotification' && globalNotificationEl) { 
                    notificationElement = globalNotificationEl;
                } else {
                    console.warn("Notification area with ID:", targetId, "not found. Cannot display notification.");
                    return;
                }
            }

            notificationElement.textContent = message;
            notificationElement.className = `notification-area p-3 text-sm rounded-md ${type === 'error' ? 'bg-red-100 text-red-700' : (type === 'success' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700')}`;
            notificationElement.style.display = 'block';
            
            if (notificationElement.timeoutId) {
                clearTimeout(notificationElement.timeoutId);
            }

            notificationElement.timeoutId = setTimeout(() => {
                notificationElement.style.display = 'none';
            }, duration);
        }


        manageProgressBtn.onclick = () => {
            progressModal.style.display = "block";
            loadSavedProgressList();
        }
        closeProgressModalBtn.onclick = () => {
            progressModal.style.display = "none";
        }
        window.onclick = (event) => {
            if (event.target == progressModal) {
                progressModal.style.display = "none";
            }
        }

        function getSavedProgresses() {
            const saves = localStorage.getItem(LOCAL_STORAGE_KEY);
            return saves ? JSON.parse(saves) : [];
        }

        function saveProgresses(progresses) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(progresses));
        }

        saveNewProgressBtn.onclick = () => {
            saveCurrentStepDataToState(); 
            const progresses = getSavedProgresses();
            let name = progressNameInput.value.trim();
            if (!name) {
                name = `進度 (瀏覽器) ${new Date().toLocaleString('zh-TW')}`;
            }
            
            const existingProgressIndex = progresses.findIndex(p => p.name === name);
            if (existingProgressIndex !== -1) {
                 if (!confirm(`名稱 "${name}" 已存在於瀏覽器儲存中。要覆蓋它嗎？`)) { 
                    showNotification("儲存已取消。", "info", "globalNotification");
                    return;
                 }
                 progresses.splice(existingProgressIndex, 1); 
            }

            const newSave = {
                id: generateId(), 
                name: name,
                timestamp: Date.now(),
                data: JSON.parse(JSON.stringify(appState)) 
            };
            progresses.push(newSave);
            progresses.sort((a,b) => b.timestamp - a.timestamp); 
            saveProgresses(progresses);
            loadSavedProgressList();
            progressNameInput.value = ''; 
            showNotification(`進度 "${name}" 已儲存至瀏覽器！`, "success", "globalNotification");
        };

        // Function to merge loaded state with default to ensure all properties exist
        function mergeWithDefaultState(loadedData) {
            const defaultAppState = { 
                keyProblem: "", rcaCauses: [], conflicts: [], trizSolutions: [],
                abcCategories: {}, mcdmCriteria: [], mcdmScores: {},
                solutionImplementationTimes: {}, trizIdealnessScores: {},
                leanCanvas: { problem: "", solution: "", keyMetrics: "", uniqueValueProposition: "", unfairAdvantage: "", channels: "", customerSegments: "", costStructure: "", revenueStreams: "", selectedSolutionTextForCanvas: "" },
                currentStep: 1
            };
            
            let mergedState = { ...defaultAppState, ...loadedData };

            // Deep merge for nested objects like leanCanvas
            mergedState.leanCanvas = { ...defaultAppState.leanCanvas, ...(loadedData.leanCanvas || {}) };
            
            // Ensure arrays are arrays
            Object.keys(defaultAppState).forEach(key => {
                if (Array.isArray(defaultAppState[key]) && !Array.isArray(mergedState[key])) {
                    mergedState[key] = [];
                }
            });
            return mergedState;
        }


        function loadSavedProgressList() {
            const progresses = getSavedProgresses();
            savedProgressListEl.innerHTML = '';
            if (progresses.length === 0) {
                savedProgressListEl.innerHTML = '<p class="text-sm text-gray-500">瀏覽器中尚未儲存任何進度。</p>';
                return;
            }
            progresses.forEach((prog) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-3 border rounded-md bg-gray-50 flex justify-between items-center mb-2';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-sm font-medium text-gray-700 truncate mr-2';
                nameSpan.textContent = `${prog.name} (${new Date(prog.timestamp).toLocaleDateString('zh-TW')})`;
                nameSpan.title = `${prog.name} - ${new Date(prog.timestamp).toLocaleString('zh-TW')}`;

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'space-x-1 flex-shrink-0';

                const loadBtn = document.createElement('button');
                loadBtn.textContent = '載入';
                loadBtn.className = 'text-xs bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded-md';
                loadBtn.onclick = () => {
                    try {
                        // Use structuredClone if available for deep cloning, otherwise JSON parse/stringify
                        let loadedData = structuredClone(prog.data);
                        appState = mergeWithDefaultState(loadedData);
                    } catch (e) {
                        console.warn("structuredClone failed, using JSON parse/stringify fallback for loading state.");
                        let loadedData = JSON.parse(JSON.stringify(prog.data));
                        appState = mergeWithDefaultState(loadedData);
                    }
                    
                    populateAllUIFromState(); 
                    progressModal.style.display = "none";
                    setTimeout(() => showNotification(`進度 "${prog.name}" 已載入！`, "success", "globalNotification", 3000), 100); 
                };

                const overwriteBtn = document.createElement('button');
                overwriteBtn.textContent = '覆蓋';
                overwriteBtn.className = 'text-xs bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-2 rounded-md';
                overwriteBtn.onclick = () => {
                    if (confirm(`確定要用目前工具內容覆蓋瀏覽器中儲存的進度 "${prog.name}" 嗎？此操作無法復原。`)) { 
                        saveCurrentStepDataToState(); 
                        const currentProgresses = getSavedProgresses();
                        const progIndex = currentProgresses.findIndex(p => p.id === prog.id);
                        if (progIndex > -1) {
                            currentProgresses[progIndex].data = JSON.parse(JSON.stringify(appState)); 
                            currentProgresses[progIndex].timestamp = Date.now();
                            const newNameFromInput = progressNameInput.value.trim();
                            if (newNameFromInput && newNameFromInput !== currentProgresses[progIndex].name) {
                                if (currentProgresses.some((p, i) => p.name === newNameFromInput && i !== progIndex)) {
                                    showNotification(`名稱 "${newNameFromInput}" 已被其他進度使用。請選擇不同名稱。`, "error", "globalNotification");
                                    return;
                                }
                                currentProgresses[progIndex].name = newNameFromInput;
                                progressNameInput.value = ''; 
                            }
                        }
                        saveProgresses(currentProgresses);
                        loadSavedProgressList();
                        showNotification(`進度 "${prog.name}" 已被目前內容覆蓋！`, "success", "globalNotification");
                    }
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '刪除';
                deleteBtn.className = 'text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded-md';
                deleteBtn.onclick = () => {
                    if (confirm(`確定要刪除瀏覽器中儲存的進度 "${prog.name}" 嗎？此操作無法復原。`)) { 
                        let currentProgresses = getSavedProgresses();
                        currentProgresses = currentProgresses.filter(p => p.id !== prog.id);
                        saveProgresses(currentProgresses);
                        loadSavedProgressList();
                        showNotification(`進度 "${prog.name}" 已刪除！`, "success", "globalNotification");
                    }
                };

                buttonsDiv.appendChild(loadBtn);
                buttonsDiv.appendChild(overwriteBtn);
                buttonsDiv.appendChild(deleteBtn);
                itemDiv.appendChild(nameSpan);
                itemDiv.appendChild(buttonsDiv);
                savedProgressListEl.appendChild(itemDiv);
            });
        }

        // Download progress
        downloadProgressBtn.addEventListener('click', () => {
            saveCurrentStepDataToState(); // Ensure current state is captured
            const jsonData = JSON.stringify(appState);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            a.download = `innovation_tool_progress_${timestamp}.json`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification("進度已開始下載！", "success", "globalNotification");
        });

        // Upload progress
        uploadProgressInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const uploadedAppState = JSON.parse(e.target.result);
                        
                        // Validate basic structure (e.g., check for currentStep)
                        if (typeof uploadedAppState.currentStep === 'undefined') {
                            throw new Error("無效的進度檔案格式。");
                        }

                        let progressName = file.name.replace(/\.json$/i, ''); // Use filename as default name
                        progressName = prompt("請為此上傳的進度命名：", progressName);

                        if (progressName === null) { // User cancelled prompt
                             showNotification("上傳已取消。", "info", "globalNotification");
                             uploadProgressInput.value = ''; // Reset file input
                             return;
                        }
                        progressName = progressName.trim() || `已上傳進度 ${new Date().toLocaleString('zh-TW')}`;


                        const progresses = getSavedProgresses();
                        const existingProgressIndex = progresses.findIndex(p => p.name === progressName);
                        if (existingProgressIndex !== -1) {
                             if (!confirm(`名稱 "${progressName}" 已存在於瀏覽器儲存中。要覆蓋它嗎？`)) {
                                showNotification("上傳並儲存至瀏覽器已取消。", "info", "globalNotification");
                                uploadProgressInput.value = ''; // Reset file input
                                return;
                             }
                             progresses.splice(existingProgressIndex, 1);
                        }
                        
                        const newSave = {
                            id: generateId(),
                            name: progressName,
                            timestamp: Date.now(),
                            data: uploadedAppState // Store the uploaded data
                        };
                        progresses.push(newSave);
                        progresses.sort((a,b) => b.timestamp - a.timestamp);
                        saveProgresses(progresses);
                        loadSavedProgressList();
                        
                        // Ask user if they want to load the uploaded progress immediately
                        if (confirm(`進度 "${progressName}" 已成功上傳並儲存至瀏覽器列表。是否立即載入此進度？`)) {
                            appState = mergeWithDefaultState(uploadedAppState);
                            populateAllUIFromState();
                            showNotification(`已載入上傳的進度 "${progressName}"！`, "success", "globalNotification");
                        } else {
                            showNotification(`進度 "${progressName}" 已上傳並加入列表。`, "success", "globalNotification");
                        }

                    } catch (error) {
                        console.error("讀取或解析上傳檔案時發生錯誤:", error);
                        showNotification(`上傳失敗：${error.message}`, "error", "globalNotification");
                    } finally {
                        uploadProgressInput.value = ''; // Reset file input
                    }
                };
                reader.readAsText(file);
            }
        });


        // --- Initial Setup ---
        updateUI(); 
        populateCurrentStepUIFromState(); 
    </script>
</body>
</html>
