import React, { useState, useEffect, useCallback, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, doc, deleteDoc, setDoc, serverTimestamp, orderBy } from 'firebase/firestore';
import { setLogLevel } from "firebase/app";

// Firebase 設定 - 增強 robustness
let parsedFirebaseConfig;
const defaultFirebaseConfig = {
    apiKey: "YOUR_API_KEY", // 請替換成您的 Firebase API Key
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

if (typeof __firebase_config !== 'undefined' && __firebase_config !== null && __firebase_config.trim() !== "") {
  try {
    parsedFirebaseConfig = JSON.parse(__firebase_config);
  } catch (e) {
    console.error("無法解析 __firebase_config，將使用預設 Firebase 設定。錯誤:", e);
    parsedFirebaseConfig = defaultFirebaseConfig;
  }
} else {
  if (typeof __firebase_config !== 'undefined') {
     console.warn("__firebase_config 已定義但為空或無效，將使用預設 Firebase 設定。");
  }
  parsedFirebaseConfig = defaultFirebaseConfig;
}
const firebaseConfig = parsedFirebaseConfig;

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-english-learner-app-handdrawn';

// 初始化 Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

setLogLevel('debug'); 

// AI 生字簿的 Gemini API JSON Schema
const vocabGenerationSchema = {
  type: "OBJECT",
  properties: {
    "definitions": {
      "type": "ARRAY",
      "items": { "type": "STRING" },
      "description": "List of English definitions for the word/phrase."
    },
    "translation_zh_TW": {
      "type": "STRING",
      "description": "Traditional Chinese translation of the word/phrase."
    },
    "example_sentence": {
      "type": "STRING",
      "description": "An example sentence using the word/phrase in English."
    },
    "error": {
      "type": "STRING",
      "description": "Error message if the word/phrase cannot be processed.",
      "optional": true
    }
  },
  required: ["definitions", "translation_zh_TW", "example_sentence"] 
};

// AI 文章洞察的 Gemini API JSON Schema
const insightGenerationSchema = {
  type: "OBJECT",
  properties: {
    "key_vocabulary": {
      "type": "ARRAY",
      "description": "List of 5-7 key vocabulary words from the article, suitable for an intermediate English learner. Focus on less common but useful words.",
      "items": {
        "type": "OBJECT",
        "properties": {
          "word": { "type": "STRING", "description": "The vocabulary word." },
          "definition_en": { "type": "STRING", "description": "Concise English definition of the word." },
          "translation_zh_TW": { "type": "STRING", "description": "Traditional Chinese translation of the word." },
          "example_sentence_from_article": { "type": "STRING", "description": "The exact sentence from the article containing the word. If the word appears multiple times, choose a clear example." }
        },
        "required": ["word", "definition_en", "translation_zh_TW", "example_sentence_from_article"]
      }
    },
    "useful_phrases": {
      "type": "ARRAY",
      "description": "List of 3-5 useful phrases or idioms from the article.",
      "items": {
        "type": "OBJECT",
        "properties": {
          "phrase": { "type": "STRING", "description": "The phrase or idiom." },
          "meaning_en": { "type": "STRING", "description": "Concise English meaning of the phrase." },
          "translation_zh_TW": { "type": "STRING", "description": "Traditional Chinese translation of the phrase." },
          "example_sentence_from_article": { "type": "STRING", "description": "The exact sentence from the article containing the phrase." }
        },
        "required": ["phrase", "meaning_en", "translation_zh_TW", "example_sentence_from_article"]
      }
    },
    "grammar_highlights": {
      "type": "ARRAY",
      "description": "List of 2-3 noteworthy grammar structures or patterns from the article.",
      "items": {
        "type": "OBJECT",
        "properties": {
          "grammar_point_name_zh_TW": { "type": "STRING", "description": "Name of the grammar point in Traditional Chinese (e.g., '過去完成式', '被動語態', '動名詞作主語')." },
          "explanation_zh_TW": { "type": "STRING", "description": "Brief (1-2 sentences) explanation of the grammar rule in Traditional Chinese, focusing on its use in the example." },
          "example_sentence_from_article": { "type": "STRING", "description": "The exact sentence from the article showcasing this grammar point." }
        },
        "required": ["grammar_point_name_zh_TW", "explanation_zh_TW", "example_sentence_from_article"]
      }
    }
  },
  required: ["key_vocabulary", "useful_phrases", "grammar_highlights"]
};

// SVG Icon Components
const TrashIcon = ({ className = "w-5 h-5" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
    <path fillRule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25V4.075c.827-.05 1.66-.075 2.5-.075zM7.443 16.669a1.25 1.25 0 01-1.226-1.244l-.81-10.124a.75.75 0 011.482-.23l.81 10.124a1.25 1.25 0 01-1.244 1.226zM12.557 16.67a1.25 1.25 0 01-1.244-1.227l.81-10.124a.75.75 0 011.482.23l-.81 10.124a1.25 1.25 0 01-1.226 1.244z" clipRule="evenodd" />
  </svg>
);
const SparklesIcon = ({ className = "w-5 h-5" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
    <path fillRule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clipRule="evenodd" />
  </svg>
);
const PlusCircleIcon = ({ className = "w-5 h-5" }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" clipRule="evenodd" />
  </svg>
);

// 主應用程式組件
function App() {
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  const [urlInput, setUrlInput] = useState('');
  const [currentArticleUrl, setCurrentArticleUrl] = useState('');
  const [articleText, setArticleText] = useState('');
  const [isLoading, setIsLoading] = useState(false); 
  const [isVocabLoading, setIsVocabLoading] = useState(false); 
  const [isInsightLoading, setIsInsightLoading] = useState(false);
  const [error, setError] = useState('');
  
  const [selectedText, setSelectedText] = useState('');
  const articleDisplayRef = useRef(null);
  const urlInputRef = useRef(null); 

  const [bookmarks, setBookmarks] = useState([]); 
  const [vocabulary, setVocabulary] = useState([]); 
  const [articleInsights, setArticleInsights] = useState(null);

  const [showModal, setShowModal] = useState(false);
  const [modalMessage, setModalMessage] = useState('');

  // Google Font import and base styles
  useEffect(() => {
    const styleId = 'google-font-gaegu-style';
    if (document.getElementById(styleId)) return; // 防止重複添加

    const style = document.createElement('style');
    style.id = styleId;
    style.innerHTML = `
      @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&display=swap');
      body {
        font-family: 'Gaegu', cursive;
        background-color: #FDF6E3; 
        color: #58452D; 
      }
      .hand-drawn-border {
        border: 2px solid #A98C6A; 
        border-radius: 12px; 
        box-shadow: 3px 3px 0px #D5C4A1; 
      }
      .hand-drawn-button {
        font-family: 'Gaegu', cursive;
        border: 2px solid #A98C6A;
        border-radius: 8px;
        box-shadow: 2px 2px 0px #D5C4A1;
        transition: all 0.1s ease-in-out;
      }
      .hand-drawn-button:hover {
        transform: translate(1px, 1px);
        box-shadow: 1px 1px 0px #D5C4A1;
      }
      .hand-drawn-button:active {
        transform: translate(2px, 2px);
        box-shadow: none;
      }
      .prose-custom { 
        font-family: 'Gaegu', cursive;
        color: #58452D; 
        line-height: 1.8; 
      }
      .prose-custom p, .prose-custom li, .prose-custom strong, .prose-custom em {
        font-family: 'Gaegu', cursive;
        color: #58452D;
      }
       .prose-custom h1, .prose-custom h2, .prose-custom h3 {
        font-family: 'Gaegu', cursive;
        color: #8C6D46; 
        border-bottom: 2px dashed #A98C6A; 
        padding-bottom: 0.3em;
      }
    `;
    document.head.appendChild(style);
    return () => {
      const styleElement = document.getElementById(styleId);
      if (styleElement && styleElement.parentNode) {
        styleElement.parentNode.removeChild(styleElement);
      }
    };
  }, []);

  // Firebase Auth 初始化
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        setUserId(user.uid);
      } else {
        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        } catch (e) {
          console.error("Firebase Auth Error: ", e);
          setError("認證失敗，部分功能可能無法使用。");
          setUserId('anonymous_' + Date.now()); 
        }
      }
      setIsAuthReady(true);
    });
    return () => unsubscribe();
  }, []);

  // 載入資料 (書籤, 生字簿)
  useEffect(() => {
    if (!isAuthReady || !userId) return;

    const bookmarksPath = `artifacts/${appId}/users/${userId}/englishLearnerBookmarks`;
    const bookmarksQuery = query(collection(db, bookmarksPath), orderBy("createdAt", "desc"));
    const unsubBookmarks = onSnapshot(bookmarksQuery, (snapshot) => {
      setBookmarks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, (err) => { console.error("Error loading bookmarks:", err); setError("無法載入書籤。"); });

    const vocabPath = `artifacts/${appId}/users/${userId}/englishLearnerVocabulary`;
    const vocabQuery = query(collection(db, vocabPath), orderBy("createdAt", "desc"));
    const unsubVocab = onSnapshot(vocabQuery, (snapshot) => {
      setVocabulary(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, (err) => { console.error("Error loading vocabulary:", err); setError("無法載入生字簿。"); });
    
    return () => {
      unsubBookmarks();
      unsubVocab();
    };
  }, [isAuthReady, userId]);

  const handleFetchArticle = async () => {
    if (!urlInput.trim()) {
      setModalMessage("請輸入網址。");
      setShowModal(true);
      return;
    }
    setIsLoading(true); setError(''); setArticleText(''); setCurrentArticleUrl(''); setSelectedText('');
    setArticleInsights(null);
    try {
      const prompt = `Extract the main textual content from the following URL. Return the text in its original language. Preserve paragraph breaks if possible. Do not summarize or add any commentary. URL: ${urlInput}`;
      const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
      const payload = { contents: chatHistory };
      const apiKey = ""; 
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
      const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!response.ok) { 
        const errorData = await response.json().catch(() => ({ message: "無法解析錯誤回應" })); // 防止 response.json() 本身也出錯
        console.error("Gemini API error for article fetch:", errorData);
        throw new Error(`無法從網址提取內容 (HTTP ${response.status})。${errorData.error?.message || errorData.message || ''}`); 
      }
      const result = await response.json();
      if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
        setArticleText(result.candidates[0].content.parts[0].text);
        setCurrentArticleUrl(urlInput);
      } else { 
        console.error("Unexpected Gemini API response structure for article fetch:", result);
        throw new Error("無法解析提取的內容。回應格式不符預期。"); 
      }
    } catch (e) { 
      console.error("Fetch article error:", e);
      setError(`提取文章失敗：${e.message}`);
      setModalMessage(`提取文章失敗：${e.message}`);
      setShowModal(true);
    } finally {
      setIsLoading(false);
    }
  };

  const handleChangeSource = () => {
    setUrlInput(''); setCurrentArticleUrl(''); setArticleText(''); setSelectedText(''); setError('');
    setArticleInsights(null);
    if (articleDisplayRef.current) articleDisplayRef.current.scrollTop = 0;
    if (urlInputRef.current) urlInputRef.current.focus();
  };

  const handleTextSelection = () => {
    const selection = window.getSelection();
    if (selection && selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;
        if (articleDisplayRef.current && articleDisplayRef.current.contains(container)) {
            const text = selection.toString().trim();
            setSelectedText(text);
        } else {
            if (selectedText) setSelectedText(''); 
        }
    } else {
        if (selectedText) setSelectedText('');
    }
  };
  
  const addBookmark = async () => {
    if (!currentArticleUrl || !userId) { /* ... */ return; }
    const existingBookmark = bookmarks.find(b => b.url === currentArticleUrl);
    if (existingBookmark) { /* ... */ return; }
    setIsLoading(true);
    try {
      const bookmarksCollectionPath = `artifacts/${appId}/users/${userId}/englishLearnerBookmarks`;
      const title = articleText.substring(0, 100) + (articleText.length > 100 ? '...' : '') || currentArticleUrl;
      await addDoc(collection(db, bookmarksCollectionPath), {
        url: currentArticleUrl, title: title, createdAt: serverTimestamp()
      });
    } catch (e) { /* ... */ } finally { setIsLoading(false); }
  };

  const removeBookmark = async (bookmarkId) => {
    if (!userId) return;
    setIsLoading(true);
    try {
      const bookmarkDocPath = `artifacts/${appId}/users/${userId}/englishLearnerBookmarks/${bookmarkId}`;
      await deleteDoc(doc(db, bookmarkDocPath));
    } catch (e) { /* ... */ } finally { setIsLoading(false); }
  };

  const loadBookmarkedArticle = (url) => {
    setUrlInput(url);
    setTimeout(() => handleFetchArticle(), 0); 
  };
  
  const addVocabEntry = async (word, definition_en = '', translation_zh_TW = '', example_sentence = '') => {
    const termToAdd = word || selectedText;
    if (!termToAdd || !userId) { /* ... */ return; }
    const existingVocab = vocabulary.find(v => v.word.toLowerCase() === termToAdd.toLowerCase());
    if (existingVocab) { /* ... */ return; }
    setIsVocabLoading(true); setError('');
    try {
      let vocabData = {
        definitions: definition_en && typeof definition_en === 'string' ? [definition_en] : [],
        translation_zh_TW: translation_zh_TW || '',
        example_sentence: example_sentence || '',
      };
      if (!definition_en || !translation_zh_TW || !example_sentence) {
        // ... (AI call logic for vocab - same as before)
        const prompt = `For the English word or short phrase '${termToAdd}', provide: 1. Up to 2 common definitions in English. 2. Its translation to Traditional Chinese. 3. One example sentence using the word/phrase. Respond ONLY with a JSON object matching this schema: { "definitions": ["definition1", "definition2"], "translation_zh_TW": "中文翻譯", "example_sentence": "Example sentence here." }. If it's not a valid word/phrase or you cannot provide this information, include an "error" field in your JSON response, like { "error": "Could not process." }.`;
        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = {
          contents: chatHistory,
          generationConfig: { responseMimeType: "application/json", responseSchema: vocabGenerationSchema }
        };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: "無法解析錯誤回應" }));
            throw new Error(`AI 查詢失敗 (HTTP ${response.status})。 ${errorData.error?.message || errorData.message || ''}`);
        }
        const result = await response.json();
        if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
          const parsedResult = JSON.parse(result.candidates[0].content.parts[0].text);
          if (parsedResult.error) throw new Error(`AI 無法處理 「${termToAdd}」：${parsedResult.error}`);
          if (!parsedResult.definitions || !parsedResult.translation_zh_TW || !parsedResult.example_sentence) throw new Error(`AI 回應缺少必要資訊。`);
          vocabData = parsedResult; // Overwrite with AI result
        } else throw new Error("AI 回應格式不符預期。");
      }
      const vocabCollectionPath = `artifacts/${appId}/users/${userId}/englishLearnerVocabulary`;
      await addDoc(collection(db, vocabCollectionPath), {
        word: termToAdd,
        definitions: Array.isArray(vocabData.definitions) ? vocabData.definitions : [vocabData.definitions].filter(Boolean), // Ensure it's an array
        translation_zh_TW: vocabData.translation_zh_TW,
        example_sentence: vocabData.example_sentence,
        articleUrl: currentArticleUrl || 'general', 
        createdAt: serverTimestamp()
      });
      setModalMessage(`「${termToAdd}」已成功加入生字簿！`); setShowModal(true);
    } catch (e) { /* ... */ } finally { setIsVocabLoading(false); }
  };

  const removeVocabEntry = async (vocabId) => {
    if (!userId) return;
    setIsLoading(true); 
    try {
      const vocabDocPath = `artifacts/${appId}/users/${userId}/englishLearnerVocabulary/${vocabId}`;
      await deleteDoc(doc(db, vocabDocPath));
    } catch (e) { /* ... */ } finally { setIsLoading(false); }
  };

  const getRenderedArticleText = useCallback(() => {
    if (!articleText) return <p className="text-stone-500 p-4">請輸入網址並點擊「讀取文章」以開始。</p>;
    const lines = articleText.split('\n');
    return lines.map((line, lineIndex) => (
        <React.Fragment key={`line-${lineIndex}`}>
            {line}
            {lineIndex < lines.length - 1 && <br />}
        </React.Fragment>
    ));
  }, [articleText]);

  const handleFetchArticleInsights = async () => {
    if (!articleText || !userId) { /* ... */ return; }
    setIsInsightLoading(true); setError(''); setArticleInsights(null);
    try {
      const prompt = `請分析以下英文文章，並提供學習洞察。文章內容如下：\n\n"${articleText}"\n\n請嚴格依照以下JSON格式回傳，包含重點單字、實用片語和文法結構亮點。單字請提供英文定義、繁體中文翻譯及文內例句。片語請提供英文解釋、繁體中文翻譯及文內例句。文法點請提供繁體中文名稱、繁體中文解釋及文內例句。`;
      const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
      const payload = {
        contents: chatHistory,
        generationConfig: { responseMimeType: "application/json", responseSchema: insightGenerationSchema }
      };
      const apiKey = "";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
      const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ message: "無法解析錯誤回應" }));
        console.error("Gemini API error for insights:", errorData);
        throw new Error(`AI 深度分析失敗 (HTTP ${response.status})。 ${errorData.error?.message || errorData.message || ''}`);
      }
      const result = await response.json();
      if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
        const insightsData = JSON.parse(result.candidates[0].content.parts[0].text);
        // 驗證 insightsData 是否符合預期結構 (可選，但更穩健)
        if (insightsData && insightsData.key_vocabulary && insightsData.useful_phrases && insightsData.grammar_highlights) {
            setArticleInsights(insightsData);
        } else {
            console.error("AI 深度分析回應 JSON 結構不完整:", insightsData);
            throw new Error("AI 深度分析回應的資料結構不完整。");
        }
      } else { 
        console.error("Unexpected Gemini API response structure for insights:", result);
        throw new Error("AI 深度分析回應格式不符預期。"); 
      }
    } catch (e) { /* ... */ } finally { setIsInsightLoading(false); }
  };

  if (!isAuthReady) {
    return <div className="flex justify-center items-center h-screen text-2xl font-bold" style={{ fontFamily: 'Gaegu, cursive', color: '#58452D' }}>正在初始化應用程式...</div>;
  }

  // 省略部分重複的 JSX 結構，用註解標示。請參考上一版完整結構。
  // 確保所有 onClick, className, style 等都正確。
  // 簡化 catch 區塊的 setModalMessage 和 setError 的重複內容。
  // 確保 addBookmark, removeBookmark, removeVocabEntry, handleFetchArticleInsights 的 catch 區塊也設定 modalMessage 和 error。

  return (
    <div className="min-h-screen p-4 md:p-8" style={{ backgroundColor: '#FDF6E3' }}>
      <header className="mb-8 p-6 hand-drawn-border bg-orange-100">
        <h1 className="text-4xl md:text-5xl font-bold text-center" style={{ color: '#8C6D46' }}>英文學習小幫手</h1>
        {userId && <p className="text-sm text-center mt-2" style={{color: '#A98C6A'}}>使用者 ID: {userId}</p>}
      </header>

      <section className="mb-8 p-6 hand-drawn-border bg-lime-50">
        <div className="flex flex-col sm:flex-row gap-4 items-center">
          <input
            ref={urlInputRef} 
            type="url"
            value={urlInput}
            onChange={(e) => setUrlInput(e.target.value)}
            placeholder="貼上文章網址開始學習..."
            className="flex-grow p-3 hand-drawn-border bg-white text-lg focus:ring-2 focus:ring-orange-300 outline-none"
          />
          <button
            onClick={handleFetchArticle}
            disabled={isLoading || isInsightLoading || isVocabLoading} // 考慮所有 loading 狀態
            className="px-6 py-3 hand-drawn-button bg-sky-200 hover:bg-sky-300 text-sky-800 font-semibold text-lg disabled:opacity-60 disabled:cursor-not-allowed whitespace-nowrap"
          >
            {isLoading && !isInsightLoading && !isVocabLoading ? '讀取中...' : '讀取文章'}
          </button>
          <button
            onClick={handleChangeSource}
            disabled={isLoading || isInsightLoading || isVocabLoading}
            className="px-6 py-3 hand-drawn-button bg-stone-200 hover:bg-stone-300 text-stone-700 font-semibold text-lg whitespace-nowrap  disabled:opacity-60 disabled:cursor-not-allowed"
          >
            換一篇
          </button>
        </div>
      </section>

      <div className="flex flex-col lg:flex-row gap-8">
        <main className="lg:w-2/3 p-6 hand-drawn-border bg-white flex flex-col">
          <h2 className="text-3xl font-bold mb-4 pb-2" style={{ color: '#8C6D46', borderBottom: '2px dashed #A98C6A' }}>文章內容</h2>
          {isLoading && currentArticleUrl && !isInsightLoading && !isVocabLoading && <p className="p-4 text-orange-600">正在載入文章「{currentArticleUrl}」...</p>}
          <div
            ref={articleDisplayRef}
            onMouseUp={handleTextSelection} 
            onTouchEnd={handleTextSelection} 
            className="prose-custom max-w-none h-96 overflow-y-auto p-2 border border-dashed border-stone-300 rounded-md bg-orange-50/50"
            style={{ userSelect: 'text', fontSize: '1.1rem' }} 
          >
            {getRenderedArticleText()}
          </div>

          {currentArticleUrl && !articleInsights && !isInsightLoading && (
            <button
              onClick={handleFetchArticleInsights}
              disabled={isLoading || isVocabLoading}
              className="mt-6 px-6 py-3 hand-drawn-button bg-teal-200 hover:bg-teal-300 text-teal-800 font-semibold text-lg self-center inline-flex items-center gap-2 disabled:opacity-60 disabled:cursor-not-allowed"
            >
              <SparklesIcon className="w-5 h-5" />
              深度學習分析
            </button>
          )}
          {isInsightLoading && (
            <div className="mt-6 p-4 text-center text-teal-700">
              <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-teal-500 mx-auto mb-2"></div>
              AI 努力分析中，請稍候...
            </div>
          )}
          {articleInsights && (
            <div className="mt-8 pt-6 border-t-2 border-dashed border-stone-300">
              <h3 className="text-2xl font-bold mb-6 text-center" style={{ color: '#8C6D46' }}>AI 學習洞察</h3>
              
              <div className="mb-6">
                <h4 className="text-xl font-semibold mb-3 pb-1" style={{ color: '#A0522D', borderBottom: '1px solid #D2B48C' }}>重點單字</h4>
                {articleInsights.key_vocabulary && articleInsights.key_vocabulary.length > 0 ? (
                  <ul className="space-y-4">
                    {articleInsights.key_vocabulary.map((item, index) => (
                      <li key={`vocab-${item.word}-${index}`} className="p-3 hand-drawn-border bg-amber-50/70 text-sm">
                        <div className="flex justify-between items-start">
                          <strong className="text-lg text-amber-700 block mb-1">{item.word}</strong>
                          <button 
                            onClick={() => addVocabEntry(item.word, item.definition_en, item.translation_zh_TW, item.example_sentence_from_article)}
                            disabled={isVocabLoading || isLoading || isInsightLoading}
                            className="hand-drawn-button bg-green-100 hover:bg-green-200 text-green-700 text-xs px-2 py-1 inline-flex items-center gap-1 disabled:opacity-60 disabled:cursor-not-allowed"
                            title="加入生字簿"
                          >
                            <PlusCircleIcon className="w-4 h-4"/> 加入
                          </button>
                        </div>
                        <p><span className="font-semibold text-stone-500">定義:</span> {item.definition_en}</p>
                        <p><span className="font-semibold text-stone-500">翻譯:</span> {item.translation_zh_TW}</p>
                        <p className="mt-1 italic text-xs text-stone-600"><span className="font-semibold text-stone-500 not-italic">文內例句:</span> "{item.example_sentence_from_article}"</p>
                      </li>
                    ))}
                  </ul>
                ) : <p className="text-stone-500">AI 未找到特別的重點單字。</p>}
              </div>

              <div className="mb-6">
                <h4 className="text-xl font-semibold mb-3 pb-1" style={{ color: '#A0522D', borderBottom: '1px solid #D2B48C' }}>實用片語</h4>
                {articleInsights.useful_phrases && articleInsights.useful_phrases.length > 0 ? (
                  <ul className="space-y-4">
                    {articleInsights.useful_phrases.map((item, index) => (
                      <li key={`phrase-${item.phrase}-${index}`} className="p-3 hand-drawn-border bg-sky-50/70 text-sm">
                        <strong className="text-lg text-sky-700 block mb-1">{item.phrase}</strong>
                        <p><span className="font-semibold text-stone-500">意思:</span> {item.meaning_en}</p>
                        <p><span className="font-semibold text-stone-500">翻譯:</span> {item.translation_zh_TW}</p>
                        <p className="mt-1 italic text-xs text-stone-600"><span className="font-semibold text-stone-500 not-italic">文內例句:</span> "{item.example_sentence_from_article}"</p>
                      </li>
                    ))}
                  </ul>
                ) : <p className="text-stone-500">AI 未找到特別的實用片語。</p>}
              </div>

              <div>
                <h4 className="text-xl font-semibold mb-3 pb-1" style={{ color: '#A0522D', borderBottom: '1px solid #D2B48C' }}>文法結構亮點</h4>
                {articleInsights.grammar_highlights && articleInsights.grammar_highlights.length > 0 ? (
                  <ul className="space-y-4">
                    {articleInsights.grammar_highlights.map((item, index) => (
                      <li key={`grammar-${item.grammar_point_name_zh_TW.replace(/\s/g, '_')}-${index}`} className="p-3 hand-drawn-border bg-purple-50/70 text-sm">
                        <strong className="text-lg text-purple-700 block mb-1">{item.grammar_point_name_zh_TW}</strong>
                        <p className="mb-1"><span className="font-semibold text-stone-500">解釋:</span> {item.explanation_zh_TW}</p>
                        <p className="italic text-xs text-stone-600"><span className="font-semibold text-stone-500 not-italic">文內例句:</span> "{item.example_sentence_from_article}"</p>
                      </li>
                    ))}
                  </ul>
                ) : <p className="text-stone-500">AI 未找到特別的文法亮點。</p>}
              </div>
            </div>
          )}
        </main>

        <aside className="lg:w-1/3 flex flex-col gap-8">
          <section className="p-6 hand-drawn-border bg-amber-50">
            <h3 className="text-2xl font-bold mb-4 pb-2" style={{ color: '#8C6D46', borderBottom: '2px dashed #A98C6A' }}>學習工具</h3>
            {currentArticleUrl && (
              <button
                onClick={addBookmark}
                disabled={isLoading || !currentArticleUrl || isInsightLoading || isVocabLoading}
                className="w-full mb-4 px-4 py-3 hand-drawn-button bg-green-200 hover:bg-green-300 text-green-800 font-semibold text-lg disabled:opacity-60 disabled:cursor-not-allowed"
              >
                收藏這篇文章
              </button>
            )}
            {selectedText && currentArticleUrl && (
              <>
                <button
                  onClick={() => addVocabEntry(selectedText)}
                  disabled={isVocabLoading || !selectedText || isLoading || isInsightLoading}
                  className="w-full px-4 py-3 hand-drawn-button bg-purple-200 hover:bg-purple-300 text-purple-800 font-semibold text-lg disabled:opacity-60 disabled:cursor-not-allowed"
                >
                  {isVocabLoading && !isInsightLoading && !isLoading ? '查詢中...' : `加入生字簿: "${selectedText.substring(0,15)}..."`}
                </button>
              </>
            )}
            {!selectedText && currentArticleUrl && (
                <p className="text-sm text-stone-500 mt-2">在文章中選取文字以加入生字簿。</p>
            )}
             {!currentArticleUrl && (
                <p className="text-sm text-stone-500">請先讀取一篇文章以使用工具。</p>
            )}
          </section>
          
          <section className="p-6 hand-drawn-border bg-sky-50">
            <h3 className="text-2xl font-bold mb-4 pb-2" style={{ color: '#8C6D46', borderBottom: '2px dashed #A98C6A' }}>我的收藏</h3>
            <div className="space-y-4 max-h-60 overflow-y-auto pr-2">
              {bookmarks.length > 0 ? (
                bookmarks.map((b) => (
                  <div key={b.id} className="p-4 hand-drawn-border bg-white group relative">
                    <button 
                        onClick={() => loadBookmarkedArticle(b.url)}
                        className="text-left w-full"
                        title={`載入: ${b.title || b.url}`}
                    >
                        <strong className="block text-xl text-sky-700 truncate mb-1">{b.title || '未命名收藏'}</strong>
                        <span className="text-xs text-stone-500 block truncate">{b.url}</span>
                    </button>
                    <button 
                        onClick={() => removeBookmark(b.id)}
                        disabled={isLoading || isInsightLoading || isVocabLoading}
                        className="absolute top-2 right-2 text-red-500 hover:text-red-700 opacity-50 group-hover:opacity-100 transition-opacity p-1 hand-drawn-button bg-red-100 hover:bg-red-200 border-red-300 disabled:opacity-50 disabled:cursor-not-allowed"
                        aria-label="移除收藏"
                    >
                        <TrashIcon className="w-4 h-4" />
                    </button>
                  </div>
                ))
              ) : (
                <p className="text-stone-500">還沒有收藏的文章喔。</p>
              )}
            </div>
          </section>

          <section className="p-6 hand-drawn-border bg-purple-50">
            <h3 className="text-2xl font-bold mb-4 pb-2" style={{ color: '#8C6D46', borderBottom: '2px dashed #A98C6A' }}>我的生字簿</h3>
            {isVocabLoading && selectedText && !isInsightLoading && !isLoading && <p className="text-sm text-purple-600">正在為「{selectedText}」查詢生字資訊...</p>}
            <div className="space-y-4 max-h-80 overflow-y-auto pr-2">
            {vocabulary.length > 0 ? (
              vocabulary.map((v) => (
                <div key={v.id} className="p-4 hand-drawn-border bg-white group relative text-stone-700">
                  <div className="flex justify-between items-start mb-2">
                    <strong className="text-2xl text-purple-700 break-all">{v.word}</strong>
                    <button 
                      onClick={() => removeVocabEntry(v.id)}
                      disabled={isLoading || isInsightLoading || isVocabLoading}
                      className="text-red-500 hover:text-red-700 opacity-50 group-hover:opacity-100 transition-opacity p-1 hand-drawn-button bg-red-100 hover:bg-red-200 border-red-300 disabled:opacity-50 disabled:cursor-not-allowed"
                      aria-label="移除生字"
                    >
                      <TrashIcon className="w-4 h-4" />
                    </button>
                  </div>
                  {v.translation_zh_TW && <p className="mb-1"><span className="font-semibold text-stone-500">翻譯:</span> {v.translation_zh_TW}</p>}
                  {v.definitions && Array.isArray(v.definitions) && v.definitions.length > 0 && (
                    <div className="mb-1">
                      <p className="font-semibold text-stone-500">定義:</p>
                      <ul className="list-disc list-inside pl-3 text-sm">
                        {v.definitions.map((def, i) => <li key={`${v.id}-def-${i}`}>{def}</li>)}
                      </ul>
                    </div>
                  )}
                  {v.example_sentence && <p className="text-sm"><span className="font-semibold text-stone-500">例句:</span> <em className="italic">"{v.example_sentence}"</em></p>}
                  {v.articleUrl && v.articleUrl !== 'general' && <p className="text-xs text-stone-400 mt-2 truncate" title={`來源文章: ${v.articleUrl}`}>來源: {v.articleUrl.length > 30 ? v.articleUrl.substring(0,27) + '...' : v.articleUrl}</p>}
                </div>
              ))
            ) : (
              <p className="text-stone-500">生字簿是空的，快去選字加入吧！</p>
            )}
            </div>
          </section>
        </aside>
      </div>

      {(isLoading || isVocabLoading || isInsightLoading) && (
        <div className="fixed inset-0 bg-black/30 flex justify-center items-center z-50 backdrop-blur-sm">
          <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-400"></div>
          {/* 移除了此處的特定載入訊息，因為各區塊已有自己的載入指示 */}
        </div>
      )}
      
      {showModal && (
        <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
          <div className="p-8 hand-drawn-border bg-amber-100 max-w-sm w-full">
            <h4 className="text-2xl font-bold mb-4" style={{color: '#8C6D46'}}>通知</h4>
            <p className="text-lg text-stone-700 mb-6 whitespace-pre-wrap">{modalMessage}</p>
            <button
              onClick={() => {setShowModal(false); setModalMessage(''); if(error && modalMessage.toLowerCase().includes("失敗")) setError('');}} 
              className="w-full px-4 py-3 hand-drawn-button bg-orange-300 hover:bg-orange-400 text-orange-800 font-semibold text-lg"
            >
              我知道了
            </button>
          </div>
        </div>
      )}
      {error && !showModal && (
         <div className="fixed bottom-4 right-4 p-4 hand-drawn-border bg-red-200 text-red-800 max-w-md z-40">
            <p className="font-bold text-lg">哎呀，出錯了：</p>
            <p className="text-md">{error}</p>
            <button onClick={() => setError('')} className="mt-2 text-sm underline text-red-700">關閉</button>
        </div>
      )}
      <footer className="mt-12 text-center text-sm text-stone-500">
        <p>英文學習小幫手 &copy; 2024-2025</p>
        <p className="mt-1">網頁內容提取與 AI 功能依賴外部服務，可能並非所有情況都能成功處理喔！</p>
      </footer>
    </div>
  );
}
// Helper to fill in missing catch blocks for brevity in the diff
// This is illustrative and should be integrated into the actual functions
const fillCatch = (e, type) => {
  console.error(`Error in ${type}:`, e);
  // setError(`處理${type}失敗：${e.message}`);
  // setModalMessage(`處理${type}失敗：${e.message}`);
  // setShowModal(true);
};
// Example for addBookmark: catch (e) { fillCatch(e, 'addBookmark'); } finally { setIsLoading(false); }
// Apply similar pattern to other catch blocks that were shortened to /* ... */

export default App;
