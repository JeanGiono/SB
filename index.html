<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCA+ 矛盾分析繪圖工具 (整合Gemini AI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        #diagram-render-area { /* Area where the diagram is rendered */
            position: relative; 
            overflow: auto; /* Allows scrolling for large diagrams */
            padding: 0; 
            background-color: #fff; /* White background for the diagram */
            border-radius: 0.5rem; /* Rounded corners */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Subtle shadow */
            min-height: 450px; /* Minimum height for the diagram area */
            width: 100%; /* Full width */
            -webkit-user-select: none; /* Disable text selection for better UX */
            -ms-user-select: none; 
            user-select: none; 
        }
        #scalable-content-wrapper { /* Wrapper for zoomable/pannable content */
            position: relative;
            transform-origin: top left; /* Zoom from top-left corner */
            display: inline-block; /* Allows content to define its own size */
            padding: 20px; /* Padding inside the scalable area */
            cursor: grab; /* Grab cursor for panning */
        }
        #scalable-content-wrapper:active {
            cursor: grabbing; /* Grabbing cursor when panning */
        }
        #svg-connector-layer { /* SVG layer for drawing connectors between nodes */
            position: absolute; 
            top: 20px; /* Align with padding of scalable-content-wrapper */
            left: 20px; /* Align with padding of scalable-content-wrapper */
            pointer-events: none; /* SVG layer should not intercept mouse events */
            z-index: 0; /* Behind the nodes */
        }
        #rca-diagram-container { /* Container for the actual diagram nodes */
            display: inline-block; /* Allows it to size based on content */
            text-align: center; /* Center align nodes if they are inline-block */
            position: relative; /* For z-indexing and positioning children */
            z-index: 1; /* Above the SVG layer */
        }

        .rca-node-wrapper { /* Wrapper for each node and its children container */
            display: inline-flex; /* Use flex for layout */
            flex-direction: column; /* Stack node and children vertically */
            align-items: center; /* Center items horizontally */
            margin: 0 1rem; /* Horizontal margin between sibling nodes */
            vertical-align: top; /* Align to the top with sibling wrappers */
            transition: margin 0.3s ease-in-out; /* Smooth transition for margin changes */
        }
        .rca-node { /* Individual RCA node styling */
            border: 2px solid #4b5563; /* Dark gray border */
            padding: 0.6rem 1.1rem; /* Padding inside the node */
            margin-top: 30px; /* Top margin */
            margin-bottom: 15px; /* Bottom margin */
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1); /* Subtle shadow */
            display: inline-flex; /* Use flex for internal layout */
            flex-direction: column; /* Stack content vertically */
            align-items: center; /* Center content horizontally */
            max-width: 350px; /* Maximum width of a node */
            border-radius: 0.375rem; /* Rounded corners */
            position: relative; /* For positioning elements like icons */
            z-index: 1; /* Ensure nodes are above connectors */
            background-color: #ffffff; /* White background */
            overflow-wrap: break-word; /* Break long words to prevent overflow */
        }
        .rca-node-content { /* Content area within a node */
            display: flex; 
            flex-direction: column; 
            gap: 0.4rem; /* Spacing between elements in content */
            width: 100%; 
            align-items: center; 
        }
        .rca-node-header { /* Header part of the node (text and icon) */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.4rem; 
            width: 100%;
            position: relative; /* For absolute positioning of icon */
            margin-bottom: 0.25rem; 
        }
        .rca-node-icon { /* Icon styling (e.g., (+), (-), NC) */
            font-weight: bold; font-size: 0.85em; 
            padding: 0.2em 0.4em; border-radius: 50%; 
            color: white; /* White text color */
            position: absolute; /* Position relative to header */
            top: 0.4rem; 
            right: 0.4rem;
            min-width: 22px; /* Minimum width for consistency */
            height: 22px; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white; /* White border around icon */
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); /* Subtle shadow for depth */
            z-index: 10; /* Above other node content */
        }
        .nc-badge { /* "Non-Changeable" badge styling */
            font-size: 0.65em; font-weight: bold; color: #374151; 
            background-color: #e5e7eb; padding: 0.15rem 0.35rem; 
            border-radius: 0.25rem; 
            align-self: center; 
            margin-left: 0.25rem; 
        }
        .rca-node-text { /* Text content of the node */
            font-weight: 500; 
            font-size: 0.9rem; 
            text-align: center; 
            overflow-wrap: break-word; 
            line-height: 1.4; 
            box-sizing: border-box; 
        }
        /* Specific width adjustments for text based on node type to accommodate icons/badges */
        .rca-node:not(.rca-node-positive-effect):not(.rca-node-negative-effect) .rca-node-text {
            width: 9em; /* Fixed width for standard nodes */
            padding-right: 2.5em; /* Space for icon */
            display: inline-block; 
            vertical-align: middle;
        }
        .rca-node-positive-effect .rca-node-text,
        .rca-node-negative-effect .rca-node-text {
            display: block; 
            width: 100%;    
            padding-right: 3em; /* More space for icon in effect nodes */
        }

        .selected-items-list { /* Styling for lists of parameters/principles */
            font-size: 0.75rem; 
            color: #374151; 
            margin-top: 0.5rem; 
            padding-top: 0.375rem; 
            border-top: 1px dashed #d1d5db; /* Dashed separator */
            width: 100%; 
            text-align: left; 
        }
        .selected-items-list strong { 
            color: #111827; 
            display: block; 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list ul { 
            list-style-type: disc; 
            margin-left: 1.25rem; 
            padding-left: 0.25rem; 
        } 
        .selected-items-list li { 
            margin-bottom: 0.25rem; 
        }
        .selected-items-list .solution-text { color: #059669; margin-left: 0.3rem; font-style: italic;}

        /* Node type specific styling */
        .rca-node-initial-problem { background-color: #fee2e2; border-color: #ef4444; } /* Red for initial problem */
        .rca-node-initial-problem .rca-node-icon { background-color: #ef4444; }
        .rca-node-cause { background-color: #fef9c3; border-color: #f59e0b; } /* Yellow for cause */
        .rca-node-cause .rca-node-icon.contradictory { background-color: #8b5cf6; } /* Purple for contradictory cause icon */
        .rca-node-positive-effect { background-color: #dbeafe; border-color: #3b82f6; border-radius: 50px; padding: 0.6rem 1.2rem; } /* Blue for positive effect */
        .rca-node-positive-effect .rca-node-icon { background-color: #2563eb; }
        .rca-node-negative-effect { background-color: #ffedd5; border-color: #f97316; border-radius: 50px; padding: 0.6rem 1.2rem; } /* Orange for negative effect */
        .rca-node-negative-effect .rca-node-icon { background-color: #f97316; }

        .rca-children-container { /* Container for child nodes */
            display: flex; 
            flex-direction: row; 
            justify-content: center; 
            align-items: flex-start; 
            margin-top: 15px; 
            position: relative; 
            padding-top: 25px; /* Space for connector lines */
            width: max-content; /* Adjust width to content */
        }
        
        .rca-node-actions { /* Action buttons container within a node */
            display: flex; 
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: 0.25rem; /* Spacing between buttons */
            margin-top: 0.5rem; 
            border-top: 1px solid #e5e7eb; /* Separator line */
            padding-top: 0.5rem; 
            width: 100%; 
            justify-content: flex-start; /* Align buttons to start */
        }
        /* General action button styling */
        .action-button { background-color: #6b7280; color: white; padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; border: none; cursor: pointer; transition: background-color 0.2s; }
        .action-button:hover:not(:disabled) { background-color: #4b5563; } .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        /* Specific action button colors */
        .action-button.add-cause { background-color: #3b82f6; } .action-button.add-cause:hover:not(:disabled) { background-color: #2563eb; }
        .action-button.add-positive { background-color: #10b981; } .action-button.add-positive:hover:not(:disabled) { background-color: #059669; }
        .action-button.add-negative { background-color: #f97316; } .action-button.add-negative:hover:not(:disabled) { background-color: #ea580c; }
        .action-button.toggle-nc { background-color: #a855f7; } .action-button.toggle-nc:hover:not(:disabled) { background-color: #9333ea; }
        .action-button.set-and-sources { background-color: #6d28d9; } .action-button.set-and-sources:hover:not(:disabled) { background-color: #5b21b6; }
        .action-button.edit-node { background-color: #f59e0b; } .action-button.edit-node:hover:not(:disabled) { background-color: #d97706; }
        .action-button.set-parameters { background-color: #0ea5e9; } .action-button.set-parameters:hover:not(:disabled) { background-color: #0284c7; }
        .action-button.set-principles { background-color: #ec4899; } .action-button.set-principles:hover:not(:disabled) { background-color: #db2777; }
        .action-button.ai-suggest { background-color: #7c3aed; } /* Purple for AI features */
        .action-button.ai-suggest:hover:not(:disabled) { background-color: #6d28d9; }
        .action-button.finalize-diagram { background-color: #059669; } .action-button.finalize-diagram:hover:not(:disabled) { background-color: #047857; }
        .action-button.edit-diagram { background-color: #d97706; } .action-button.edit-diagram:hover:not(:disabled) { background-color: #b45309; }
        .remove-button { background-color: #ef4444; } .remove-button:hover:not(:disabled) { background-color: #dc2626; }
        
        .input-group-container { margin-top: 0.5rem; width: calc(100% - 1rem); } /* Container for temporary input fields */
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.25rem; background-color: #f9fafb; }
        .input-field { border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; width: 100%; }
        .save-button { background-color: #065f46; color: white; } .save-button:hover:not(:disabled) { background-color: #047857; }
        .save-edit-button { background-color: #065f46; color: white; } .save-edit-button:hover:not(:disabled) { background-color: #047857; }

        /* Data table section styling */
        .data-table-section { margin-top: 2rem; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .data-table th, .data-table td { border: 1px solid #d1d5db; padding: 0.5rem; font-size: 0.875rem; text-align: center; vertical-align: middle; }
        .data-table th { background-color: #e5e7eb; font-weight: 600; }
        .data-table td { background-color: white; }
        .data-table td:first-child, .data-table th:first-child { text-align: left; }
        
        /* Modal styling */
        .modal { z-index: 50; } /* Ensure modals are on top */
        .modal-content { position: relative; } 
        .modal-close-button { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; line-height: 1; }
        .modal-close-button:hover { color: #1f2937; }
        .modal-options-container label { cursor: pointer; }
        .modal-options-container h4 { font-weight:600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; }
        .modal-options-container h4:first-child { margin-top: 0; }
        .principle-solution-input { width: calc(100% - 2rem); margin-left: 1.5rem; margin-top: 0.25rem; margin-bottom: 0.5rem; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.8rem; }
        #ai-suggestions-container { margin-top: 1rem; padding-top: 0.75rem; border-top: 1px dashed #d1d5db; }
        #ai-suggestions-list { list-style-type: decimal; margin-left: 1.5rem; font-size: 0.875rem; color: #374151; max-height: 150px; overflow-y: auto; }
        #ai-suggestions-list li { margin-bottom: 0.5rem; padding: 0.25rem; border-radius: 0.25rem; }
        #ai-suggestions-list li:hover { background-color: #e9d5ff; cursor: pointer; } /* Light purple hover for AI suggestions */
        .loading-spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; display: none; }
        .loading-spinner { border: 8px solid #f3f3f3; border-top: 8px solid #7c3aed; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Zoom controls styling */
        .zoom-controls { display: flex; gap: 0.5rem; align-items: center; }
        .zoom-controls span { font-size: 0.875rem; color: #4b5563; min-width: 50px; text-align: center; }
        
        /* Dropdown menu styling */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 230px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 0.375rem; padding: 0.5rem 0; }
        .dropdown-content button, .dropdown-content label { color: black; padding: 0.75rem 1rem; text-decoration: none; display: block; text-align: left; background: none; border: none; width: 100%; font-size: 0.875rem; cursor: pointer; }
        .dropdown-content button:hover, .dropdown-content label:hover { background-color: #e5e7eb; }
        .dropdown-content button:disabled { color: #9ca3af; cursor: not-allowed; background-color: #f9f9f9; }
        .dropdown-content button i, .dropdown-content label i { margin-right: 0.5rem; width: 1.25rem; text-align: center; }
        .dropdown-trigger-button { background-color: #1f2937; } /* Default dark color for dropdown triggers */
        .dropdown-trigger-button:hover:not(:disabled) { background-color: #374151; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="loading-spinner-overlay" class="loading-spinner-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="container mx-auto max-w-7xl"> 
        <header class="mb-6 text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">RCA+ 矛盾分析繪圖工具 (整合Gemini AI)</h1>
            <p class="text-gray-500 mt-1">視覺化根本原因、正面/負面效果，支援「且」關係連接、矛盾點標示、效果參數與發明原理。新增「✨ AI 建議方案」功能。</p>
        </header>

        <section id="controls-section" class="mb-6 p-4 bg-white rounded-lg shadow">
             <div id="problem-input-area">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">1. 設定主要負面效果</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="problem-statement-input" placeholder="輸入觀察到的主要負面效果" class="input-field flex-grow p-2 rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <button id="set-problem-button" class="action-button add-cause text-white font-semibold py-2 px-4 rounded-md">設定問題根源</button>
                </div>
            </div>
            <div id="tool-buttons" class="mt-4 flex flex-col gap-3">
                <div class="flex flex-wrap gap-2 justify-center items-center">
                    <div class="dropdown">
                        <button id="file-menu-button" class="action-button dropdown-trigger-button text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-file-alt"></i> 檔案 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="file-dropdown-content" class="dropdown-content">
                            <button id="save-workspace-button"><i class="fas fa-save"></i> 儲存工作區 (瀏覽器)</button>
                            <button id="load-workspace-button"><i class="fas fa-folder-open"></i> 載入工作區 (瀏覽器)</button>
                            <button id="download-backup-button"><i class="fas fa-file-download"></i> 下載備份 (.json)</button>
                            <label for="load-backup-input" id="load-backup-label"><i class="fas fa-file-upload"></i> 從備份載入 (.json)</label>
                            <input type="file" id="load-backup-input" accept=".json" style="display: none;">
                        </div>
                    </div>
                    <button id="undo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-undo"></i> 上一步
                    </button>
                    <button id="redo-button" class="action-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-redo"></i> 下一步
                    </button>
                    <div class="zoom-controls">
                        <button id="zoom-out-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="縮小"><i class="fas fa-search-minus"></i></button>
                        <span id="zoom-level-display">100%</span>
                        <button id="zoom-in-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md" title="放大"><i class="fas fa-search-plus"></i></button>
                        <button id="reset-zoom-button" class="action-button bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-md">重設縮放</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 justify-center">
                    <button id="finalize-diagram-button" class="action-button finalize-diagram text-white font-semibold py-2 px-4 rounded-md">完成圖表</button>
                    <button id="auto-adjust-layout-button" class="action-button bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-md">
                        <i class="fas fa-project-diagram"></i> 自動調整節點
                    </button>
                    <div class="dropdown">
                        <button id="export-menu-button" class="action-button dropdown-trigger-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-download"></i> 匯出 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="export-dropdown-content" class="dropdown-content">
                            <button id="export-png-button"><i class="fas fa-image"></i> 匯出圖檔 (PNG)</button>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button id="view-tables-menu-button" class="action-button dropdown-trigger-button bg-cyan-500 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-md">
                            <i class="fas fa-table"></i> 檢視表格 <i class="fas fa-caret-down ml-1"></i>
                        </button>
                        <div id="view-tables-dropdown-content" class="dropdown-content">
                            <button id="show-cause-effect-table-button"><i class="fas fa-tasks"></i> 顯示原因效果表</button>
                            <button id="show-solution-table-button"><i class="fas fa-lightbulb"></i> 顯示改善方案表</button>
                            <button id="hide-all-tables-button"><i class="fas fa-eye-slash"></i> 隱藏所有表格</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="rca-diagram-section" class="bg-white p-0 md:p-0 rounded-lg shadow min-h-[400px]">
            <h2 class="text-xl font-semibold text-gray-700 my-4 text-center" id="diagram-title" style="display: none;">2. RCA+ 分析圖</h2>
            <div id="diagram-render-area"> 
                <div id="scalable-content-wrapper">
                    <div id="rca-diagram-container"></div> 
                    <svg id="svg-connector-layer"></svg>
                </div>
            </div>
        </section>

        <section id="cause-effect-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">3. 原因效果表</h2>
            <table class="data-table">
                <thead> <tr><th>原因</th><th>原因類型</th><th>正面效果</th><th>負面效果</th></tr> </thead>
                <tbody id="cause-effect-table-body"></tbody>
            </table>
        </section>
        <section id="solution-table-section" style="display: none;" class="data-table-section bg-white p-4 md:p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">4. 矛盾點之創意改善方案表</h2>
            <table class="data-table">
                <thead> <tr><th>矛盾原因</th><th>發明原理</th><th>改善方案</th></tr> </thead>
                <tbody id="solution-table-body"></tbody>
            </table>
        </section>
        
        <div id="and-source-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('and-source-modal').style.display='none'; currentAndTargetNodeId = null;">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="and-source-modal-title">為效果設定 AND 輸入源</h3>
                    <div class="mt-4 px-2 py-3 max-h-72 overflow-y-auto modal-options-container" id="and-source-options-container"></div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-and-sources-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-and-sources-button" class="action-button px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-700">儲存AND來源</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="effect-parameter-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('effect-parameter-modal').style.display='none'; currentParameterTargetNodeId = null;">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="effect-parameter-modal-title">設定效果參數</h3>
                    <div class="mt-4 px-2 py-3 max-h-96 overflow-y-auto modal-options-container" id="effect-parameter-options-container"></div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-effect-parameters-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-effect-parameters-button" class="action-button px-4 py-2 bg-sky-500 text-white rounded-md hover:bg-sky-700">儲存參數</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="inventive-principle-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="modal-content mx-auto p-5 border w-11/12 md:w-1/2 lg:w-2/5 shadow-lg rounded-md bg-white">
                <button class="modal-close-button" onclick="document.getElementById('inventive-principle-modal').style.display='none'; currentPrincipleTargetNodeId = null; clearAiSuggestions();">&times;</button>
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center" id="inventive-principle-modal-title">選擇發明原理與改善方案</h3>
                    <div class="mt-4 px-2 py-3 max-h-[calc(100vh-250px)] overflow-y-auto modal-options-container" id="inventive-principle-options-container">
                        </div>
                     <div id="ai-suggestions-section" style="display: none;" class="mt-4">
                        <h4 class="text-md font-semibold text-gray-800 mb-2">✨ AI 方案建議</h4>
                        <button id="get-ai-suggestions-button" class="action-button ai-suggest text-white font-semibold py-2 px-4 rounded-md w-full mb-2">
                            <i class="fas fa-magic mr-2"></i>取得 AI 建議方案
                        </button>
                        <div id="ai-suggestions-loading" style="display: none;" class="text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i>AI 正在思考中，請稍候...
                        </div>
                        <div id="ai-suggestions-output" class="p-3 bg-purple-50 border border-purple-200 rounded-md min-h-[50px]">
                            <ul id="ai-suggestions-list"></ul>
                        </div>
                    </div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="cancel-inventive-principles-button" class="action-button mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">取消</button>
                        <button id="save-inventive-principles-button" class="action-button px-4 py-2 bg-pink-500 text-white rounded-md hover:bg-pink-700">儲存原理與方案</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables and Constants ---
        function deepCopy(obj) { return JSON.parse(JSON.stringify(obj)); } // Utility to deep copy objects
        let rcaData = null; // Holds the main diagram data structure
        let nodeIdCounter = 0; // Counter for generating unique node IDs
        let currentAndTargetNodeId = null; // ID of node being targeted for AND source linking
        let isFinalizedView = false; // Flag to toggle between edit and view-only mode
        let currentParameterTargetNodeId = null; // ID of node for setting effect parameters
        let currentPrincipleTargetNodeId = null; // ID of node for setting inventive principles
        let currentZoom = 1.0; // Current zoom level of the diagram
        const ZOOM_STEP = 0.1; // Increment/decrement for zoom
        const MIN_ZOOM = 0.2; // Minimum zoom level
        const MAX_ZOOM = 3.0; // Maximum zoom level
        let historyStack = []; // Array to store states for undo/redo
        let historyIndex = -1; // Current position in the history stack
        const MAX_HISTORY_STATES = 50; // Maximum number of history states to keep
        let longPressTimer = null; // Timer for long-press/touch context menu
        let touchStartX = 0, touchStartY = 0; // Initial touch coordinates for long-press detection
        const LONG_PRESS_DURATION = 700; // Duration for a long press in milliseconds
        const MAX_TOUCH_MOVE_THRESHOLD = 10; // Max movement allowed during long press detection

        // --- DOM Element References ---
        const problemInput = document.getElementById('problem-statement-input');
        const setProblemButton = document.getElementById('set-problem-button');
        const diagramRenderArea = document.getElementById('diagram-render-area'); 
        const scalableContentWrapper = document.getElementById('scalable-content-wrapper');
        const diagramContainer = document.getElementById('rca-diagram-container'); 
        const svgLayer = document.getElementById('svg-connector-layer');
        const diagramTitle = document.getElementById('diagram-title');
        const problemInputArea = document.getElementById('problem-input-area');
        const toolButtonsContainer = document.getElementById('tool-buttons');
        const loadingSpinnerOverlay = document.getElementById('loading-spinner-overlay');
        
        // File Menu elements
        const fileMenuButton = document.getElementById('file-menu-button');
        const fileDropdownContent = document.getElementById('file-dropdown-content');
        const saveWorkspaceButton = document.getElementById('save-workspace-button'); 
        const loadWorkspaceButton = document.getElementById('load-workspace-button'); 
        const downloadBackupButton = document.getElementById('download-backup-button');   
        const loadBackupLabel = document.getElementById('load-backup-label'); 
        const loadBackupInput = document.getElementById('load-backup-input');
        
        // Undo/Redo buttons
        const undoButton = document.getElementById('undo-button');
        const redoButton = document.getElementById('redo-button');
        
        // Zoom controls
        const zoomOutButton = document.getElementById('zoom-out-button'); 
        const zoomInButton = document.getElementById('zoom-in-button');   
        const resetZoomButton = document.getElementById('reset-zoom-button'); 
        const zoomLevelDisplay = document.getElementById('zoom-level-display'); 
        
        // Diagram actions
        const finalizeDiagramButton = document.getElementById('finalize-diagram-button'); 
        const autoAdjustLayoutButton = document.getElementById('auto-adjust-layout-button'); 

        // Export Menu elements
        const exportMenuButton = document.getElementById('export-menu-button');
        const exportDropdownContent = document.getElementById('export-dropdown-content');
        const exportPngButton = document.getElementById('export-png-button');

        // View Tables Menu elements
        const viewTablesMenuButton = document.getElementById('view-tables-menu-button');
        const viewTablesDropdownContent = document.getElementById('view-tables-dropdown-content');
        const showCauseEffectTableButton = document.getElementById('show-cause-effect-table-button');
        const showSolutionTableButton = document.getElementById('show-solution-table-button');
        const hideAllTablesButton = document.getElementById('hide-all-tables-button');

        // Table sections and bodies
        const causeEffectTableSection = document.getElementById('cause-effect-table-section');
        const causeEffectTableBody = document.getElementById('cause-effect-table-body');
        const solutionTableSection = document.getElementById('solution-table-section'); 
        const solutionTableBody = document.getElementById('solution-table-body'); 
        
        // Modal elements
        const andSourceModal = document.getElementById('and-source-modal');
        const andSourceOptionsContainer = document.getElementById('and-source-options-container');
        const andSourceModalTitle = document.getElementById('and-source-modal-title');
        const saveAndSourcesButton = document.getElementById('save-and-sources-button');
        const cancelAndSourcesButton = document.getElementById('cancel-and-sources-button');
        const effectParameterModal = document.getElementById('effect-parameter-modal');
        const effectParameterOptionsContainer = document.getElementById('effect-parameter-options-container');
        const effectParameterModalTitle = document.getElementById('effect-parameter-modal-title');
        const saveEffectParametersButton = document.getElementById('save-effect-parameters-button');
        const cancelEffectParametersButton = document.getElementById('cancel-effect-parameters-button');
        
        // Inventive Principle Modal & AI Suggestion Elements
        const inventivePrincipleModal = document.getElementById('inventive-principle-modal');
        const inventivePrincipleOptionsContainer = document.getElementById('inventive-principle-options-container');
        const inventivePrincipleModalTitle = document.getElementById('inventive-principle-modal-title');
        const saveInventivePrinciplesButton = document.getElementById('save-inventive-principles-button');
        const cancelInventivePrinciplesButton = document.getElementById('cancel-inventive-principles-button');
        const aiSuggestionsSection = document.getElementById('ai-suggestions-section');
        const getAiSuggestionsButton = document.getElementById('get-ai-suggestions-button');
        const aiSuggestionsLoading = document.getElementById('ai-suggestions-loading');
        const aiSuggestionsOutput = document.getElementById('ai-suggestions-output');
        const aiSuggestionsList = document.getElementById('ai-suggestions-list');

        // --- Data Constants for Modals ---
        const EFFECT_PARAMETERS = {
            "活動": ["活動效用性", "活動可變性", "活動費用", "活動時間", "活動複雜性", "活動方便性", "活動安全性", "活動可靠性"],
            "系統": ["系統有效性", "系統可變性", "系統費用", "系統時間", "系統複雜性", "系統方便性", "系統安全性", "系統可靠性", "對系統的有害影響", "系統產生的有害影響", "組織壓力", "組織穩定性"],
            "其他": ["內部風險", "外部風險", "信息共享", "信息損失", "信息流", "回饋", "物料流", "適應性/多功能性", "顧客壓力", "顧客穩定性", "環境穩定性"]
        }; 
        const INVENTIVE_PRINCIPLES = [
            "分割", "取出/分離", "改變局部特性", "非對稱性", "合併/整合", "多用性/多功能", "套疊/巢狀結構", "反制行動", 
            "預先反制行動", "預先行動", "事先補償/預防", "消除緊張", "另一方向/反向操作", "非直線姓", "動態化", 
            "稍微少些或多些(的動作)", "另外維度/空間", "共鳴(協調)", "週期行動", "連續的有利作用", "快速行動", 
            "轉有害為有利", "回饋", "中介物/媒介", "自助/自我服務", "使用複製品或模型", "廉價與短期[拋棄式]", 
            "替換系統運作原理/使用其他原理", "流動性和靈活性", "改變邊界條件", "孔洞和網路", "改變外觀/可見度", 
            "同質性", "丟棄與恢復", "改變特性", "模範轉移", "相對變化", "增強的環境", "鈍性(惰性)環境", "組合(複合)結構"
        ];
        
        // --- Initialization and Event Listeners ---
        function initialize() {
            // Initial problem setup
            setProblemButton.addEventListener('click', handleSetInitialProblem);
            problemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSetInitialProblem(); });
            
            // File menu interactions
            fileMenuButton.addEventListener('click', (event) => { 
                event.stopPropagation(); 
                toggleDropdown(fileDropdownContent, [exportDropdownContent, viewTablesDropdownContent]);
                updateButtonStates(); 
            });
            saveWorkspaceButton.addEventListener('click', () => { handleSaveToLocalStorage(); closeAllDropdowns(); });
            loadWorkspaceButton.addEventListener('click', () => { handleLoadFromLocalStorage(); closeAllDropdowns(); });
            downloadBackupButton.addEventListener('click', () => { handleSaveToFile(); closeAllDropdowns(); });
            loadBackupLabel.addEventListener('click', () => { loadBackupInput.click(); }); 
            loadBackupInput.addEventListener('change', (event) => { handleLoadFromFile(event); closeAllDropdowns(); });

            // Undo/Redo
            undoButton.addEventListener('click', handleUndo);
            redoButton.addEventListener('click', handleRedo);

            // Zoom controls
            zoomInButton.addEventListener('click', () => applyZoom(currentZoom + ZOOM_STEP));
            zoomOutButton.addEventListener('click', () => applyZoom(currentZoom - ZOOM_STEP));
            resetZoomButton.addEventListener('click', () => applyZoom(1.0));

            // Diagram actions
            finalizeDiagramButton.addEventListener('click', handleToggleFinalizeView); 
            autoAdjustLayoutButton.addEventListener('click', autoAdjustNodeLayout); 

            // Export menu interactions
            exportMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleDropdown(exportDropdownContent, [fileDropdownContent, viewTablesDropdownContent]);
                updateButtonStates();
            });
            exportPngButton.addEventListener('click', () => { exportDiagramAsPNG(); closeAllDropdowns(); });
            
            // View Tables menu interactions
            viewTablesMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleDropdown(viewTablesDropdownContent, [fileDropdownContent, exportDropdownContent]);
                updateButtonStates();
            });
            showCauseEffectTableButton.addEventListener('click', () => { handleShowCauseEffectTable(); closeAllDropdowns(); });
            showSolutionTableButton.addEventListener('click', () => { handleShowSolutionTable(); closeAllDropdowns(); });
            hideAllTablesButton.addEventListener('click', () => { handleHideAllTables(); closeAllDropdowns(); });
            
            // Modal save/cancel buttons
            saveAndSourcesButton.addEventListener('click', handleSaveAndSources);
            cancelAndSourcesButton.addEventListener('click', () => { andSourceModal.style.display = 'none'; currentAndTargetNodeId = null; });
            saveEffectParametersButton.addEventListener('click', handleSaveEffectParameters);
            cancelEffectParametersButton.addEventListener('click', () => { effectParameterModal.style.display = 'none'; currentParameterTargetNodeId = null; });
            saveInventivePrinciplesButton.addEventListener('click', handleSaveInventivePrinciples);
            cancelInventivePrinciplesButton.addEventListener('click', () => { inventivePrincipleModal.style.display = 'none'; currentPrincipleTargetNodeId = null; clearAiSuggestions(); });
            
            // AI Suggestion Button
            getAiSuggestionsButton.addEventListener('click', handleGetAiSuggestions);

            // Global click listener to close dropdowns
            window.addEventListener('click', (event) => { 
                if (!event.target.closest('.dropdown')) {
                    closeAllDropdowns();
                }
            });

            // Resize observer for redrawing connectors
            new ResizeObserver(() => drawAllSvgConnectors()).observe(scalableContentWrapper); 
            toolButtonsContainer.style.display = 'flex'; 
            applyZoom(1.0, true); 
            updateButtonStates(); 
            
            // Diagram area touch events
            scalableContentWrapper.addEventListener('contextmenu', handleDiagramContextMenu);
            scalableContentWrapper.addEventListener('touchstart', handleDiagramTouchStart, { passive: false });
            scalableContentWrapper.addEventListener('touchmove', handleDiagramTouchMove, { passive: true });
            scalableContentWrapper.addEventListener('touchend', handleDiagramTouchEnd);
            scalableContentWrapper.addEventListener('touchcancel', handleDiagramTouchEnd); 
        }

        // --- Dropdown Helper Functions ---
        function toggleDropdown(dropdownToShow, otherDropdownsToHide) {
            const currentDisplay = dropdownToShow.style.display;
            otherDropdownsToHide.forEach(dd => dd.style.display = 'none');
            dropdownToShow.style.display = currentDisplay === 'block' ? 'none' : 'block';
        }

        function closeAllDropdowns() {
            fileDropdownContent.style.display = 'none';
            exportDropdownContent.style.display = 'none';
            viewTablesDropdownContent.style.display = 'none';
        }

        // --- Diagram Interaction (Context Menu / Long Press) ---
        function handleDiagramContextMenu(event) { event.preventDefault(); if (rcaData) { exportDiagramAsPNG(); } }
        function triggerDownloadForLongPress() { if (rcaData) { exportDiagramAsPNG(); } }
        function handleDiagramTouchStart(event) { if (event.touches.length === 1) { touchStartX = event.touches[0].clientX; touchStartY = event.touches[0].clientY; clearTimeout(longPressTimer); longPressTimer = setTimeout(() => { const touch = event.touches[0] || event.changedTouches[0]; if (touch) { const deltaX = Math.abs(touch.clientX - touchStartX); const deltaY = Math.abs(touch.clientY - touchStartY); if (deltaX <= MAX_TOUCH_MOVE_THRESHOLD && deltaY <= MAX_TOUCH_MOVE_THRESHOLD) { triggerDownloadForLongPress(); } } else { clearTimeout(longPressTimer); } }, LONG_PRESS_DURATION); } else { clearTimeout(longPressTimer); } }
        function handleDiagramTouchMove(event) { if (longPressTimer && event.touches.length === 1) { const deltaX = Math.abs(event.touches[0].clientX - touchStartX); const deltaY = Math.abs(event.touches[0].clientY - touchStartY); if (deltaX > MAX_TOUCH_MOVE_THRESHOLD || deltaY > MAX_TOUCH_MOVE_THRESHOLD) { clearTimeout(longPressTimer); longPressTimer = null; } } }
        function handleDiagramTouchEnd() { clearTimeout(longPressTimer); longPressTimer = null; }
        
        // --- Zoom Functionality ---
        function applyZoom(newZoomLevel, avoidRedraw = false) { 
            currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoomLevel)); 
            scalableContentWrapper.style.transform = `scale(${currentZoom})`; 
            zoomLevelDisplay.textContent = `${Math.round(currentZoom * 100)}%`; 
            if (!avoidRedraw && rcaData) { 
                requestAnimationFrame(() => drawAllSvgConnectors()); 
            } 
            updateButtonStates(); 
        }
        
        // --- UI State Management (Button Disabling & Loading Spinner) ---
        function showLoadingSpinner() { loadingSpinnerOverlay.style.display = 'flex'; }
        function hideLoadingSpinner() { loadingSpinnerOverlay.style.display = 'none'; }

        function updateButtonStates() { 
            const noData = !rcaData; 
            const noLocalStorageData = !localStorage.getItem('rcaDiagramData'); 
            
            undoButton.disabled = historyIndex <= 0; 
            redoButton.disabled = historyIndex >= historyStack.length - 1; 
            
            saveWorkspaceButton.disabled = noData; 
            loadWorkspaceButton.disabled = noLocalStorageData; 
            downloadBackupButton.disabled = noData; 
            
            zoomInButton.disabled = currentZoom >= MAX_ZOOM; 
            zoomOutButton.disabled = currentZoom <= MIN_ZOOM; 
            resetZoomButton.disabled = currentZoom === 1.0; 
            
            exportPngButton.disabled = noData;
            exportMenuButton.disabled = noData; 

            finalizeDiagramButton.disabled = noData; 
            autoAdjustLayoutButton.disabled = noData || isFinalizedView; 
            
            viewTablesMenuButton.disabled = noData;
            showCauseEffectTableButton.disabled = noData;
            showSolutionTableButton.disabled = noData;
            hideAllTablesButton.disabled = noData || (causeEffectTableSection.style.display === 'none' && solutionTableSection.style.display === 'none');
        }
        
        // --- History (Undo/Redo) Management ---
        function pushStateToHistory(currentState, clearRedoStack = true) { 
            if (!currentState) { updateButtonStates(); return; } 
            const stateCopy = deepCopy(currentState); 
            if (!stateCopy) { console.error("無法複製狀態以供歷史記錄。"); return; } 
            if (clearRedoStack) { 
                historyStack = historyStack.slice(0, historyIndex + 1); 
            } 
            historyStack.push({ data: stateCopy, counter: nodeIdCounter, zoom: currentZoom }); 
            historyIndex = historyStack.length - 1; 
            if (historyStack.length > MAX_HISTORY_STATES) { 
                historyStack.shift(); 
                historyIndex--; 
            } 
            updateButtonStates(); 
        }
        function restoreStateFromHistory(historyEntry) { 
            if (historyEntry && historyEntry.data) { 
                rcaData = deepCopy(historyEntry.data); 
                nodeIdCounter = historyEntry.counter; 
                recalculateNodeIdCounter(rcaData); 
                renderRcaDiagram(); 
                renderCauseEffectTable(); 
                renderSolutionTable(); 
                applyZoom(historyEntry.zoom, true); 
            } else { 
                console.error("無法從歷史記錄中檢索狀態。"); 
                return false; 
            } 
            return true; 
        } 
        function handleUndo() { 
            if (historyIndex > 0) { 
                historyIndex--; 
                if (!restoreStateFromHistory(historyStack[historyIndex])) { 
                    historyIndex++; 
                } 
            } 
            updateButtonStates(); 
        }
        function handleRedo() { 
            if (historyIndex < historyStack.length - 1) { 
                historyIndex++; 
                if (!restoreStateFromHistory(historyStack[historyIndex])) { 
                    historyIndex--; 
                } 
            } 
            updateButtonStates(); 
        }
        
        // --- Data Persistence (Save/Load) ---
        function processLoadedData(dataString) { 
            try { 
                const parsedJson = JSON.parse(dataString); 
                if (parsedJson && typeof parsedJson.diagramData !== 'undefined' && typeof parsedJson.counter !== 'undefined') { 
                    rcaData = parsedJson.diagramData; 
                    nodeIdCounter = parseInt(parsedJson.counter); 
                    if (isNaN(nodeIdCounter)) nodeIdCounter = 0; 
                    recalculateNodeIdCounter(rcaData); 
                    historyStack = []; 
                    historyIndex = -1; 
                    pushStateToHistory(rcaData, true); 
                    problemInputArea.style.display = 'none'; 
                    diagramTitle.style.display = 'block'; 
                    toolButtonsContainer.style.display = 'flex'; 
                    renderRcaDiagram(); 
                    renderCauseEffectTable(); 
                    renderSolutionTable(); 
                    applyZoom(parsedJson.zoomLevel || 1.0, true); 
                    alert('圖表進度已成功載入！'); 
                    return true; 
                } else { 
                    alert('載入失敗：檔案格式不正確或資料不完整。'); 
                    return false; 
                } 
            } catch (e) { 
                console.error("載入資料時發生錯誤:", e); 
                alert('載入失敗：檔案內容可能不是有效的JSON格式，或已損毀。\n' + e.message); 
                return false; 
            } finally { 
                updateButtonStates(); 
            } 
        } 
        function handleSaveToLocalStorage() { 
            if (rcaData) { 
                try { 
                    const dataToSave = { diagramData: rcaData, counter: nodeIdCounter, zoomLevel: currentZoom }; 
                    localStorage.setItem('rcaDiagramData', JSON.stringify(dataToSave)); 
                    alert('圖表進度已儲存至瀏覽器！'); 
                } catch (e) { 
                    console.error("儲存至localStorage時發生錯誤:", e); 
                    alert('儲存失敗，可能是瀏覽器儲存空間已滿或功能受限。'); 
                } 
            } else { 
                alert('沒有圖表資料可儲存。'); 
            } 
            updateButtonStates(); 
        }
        function handleLoadFromLocalStorage() { 
            const savedDataString = localStorage.getItem('rcaDiagramData'); 
            if (savedDataString) { 
                processLoadedData(savedDataString); 
            } else { 
                alert('瀏覽器中沒有儲存的圖表進度。'); 
            } 
        }
        function handleSaveToFile() { 
            if (!rcaData) { alert('沒有圖表資料可儲存至檔案。'); return; } 
            const dataToSave = { diagramData: rcaData, counter: nodeIdCounter, zoomLevel: currentZoom }; 
            const jsonData = JSON.stringify(dataToSave, null, 2); 
            const blob = new Blob([jsonData], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `rca-diagram-data-${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            URL.revokeObjectURL(url); 
            alert('圖表資料已準備下載。'); 
        }
        function handleLoadFromFile(event) { 
            const file = event.target.files[0]; 
            if (file) { 
                if (file.type === "application/json") { 
                    const reader = new FileReader(); 
                    reader.onload = (e) => { 
                        const fileContent = e.target.result; 
                        processLoadedData(fileContent); 
                        loadBackupInput.value = ''; 
                    }; 
                    reader.onerror = (e) => { 
                        alert('讀取檔案時發生錯誤。'); 
                        console.error("FileReader error:", e); 
                        loadBackupInput.value = ''; 
                    }; 
                    reader.readAsText(file); 
                } else { 
                    alert('載入失敗：請選擇一個有效的 .json 檔案。'); 
                    loadBackupInput.value = ''; 
                } 
            } 
        }
        function recalculateNodeIdCounter(currentData) { 
            let maxId = 0; 
            function findMaxIdRecursive(node) { 
                if (!node) return; 
                if (node.id && typeof node.id === 'string') { 
                    const idNum = parseInt(node.id.replace('node-', '')); 
                    if (!isNaN(idNum) && idNum > maxId) { 
                        maxId = idNum; 
                    } 
                } 
                if (node.children) { 
                    node.children.forEach(findMaxIdRecursive); 
                } 
            } 
            if (currentData) { 
                findMaxIdRecursive(currentData); 
            } 
            nodeIdCounter = maxId; 
        }
        
        // --- Core Diagram Logic (Initial Problem, Finalize View) ---
        function handleSetInitialProblem() { 
            const problemText = problemInput.value.trim(); 
            if (!problemText) { alert('請輸入主要負面效果！'); return; } 
            nodeIdCounter = 0; 
            rcaData = createNode(problemText, 'initial-problem', null); 
            historyStack = []; 
            historyIndex = -1; 
            pushStateToHistory(rcaData); 
            isFinalizedView = false; 
            finalizeDiagramButton.textContent = '完成圖表'; 
            finalizeDiagramButton.classList.remove('edit-diagram'); 
            finalizeDiagramButton.classList.add('finalize-diagram'); 
            problemInputArea.style.display = 'none'; 
            diagramTitle.style.display = 'block'; 
            toolButtonsContainer.style.display = 'flex'; 
            applyZoom(1.0, true); 
            renderRcaDiagram(); 
            renderCauseEffectTable(); 
            renderSolutionTable(); 
            updateButtonStates(); 
        } 
        function handleToggleFinalizeView() { 
            isFinalizedView = !isFinalizedView; 
            if (isFinalizedView) { 
                finalizeDiagramButton.textContent = '編輯圖表'; 
                finalizeDiagramButton.classList.remove('finalize-diagram'); 
                finalizeDiagramButton.classList.add('edit-diagram'); 
            } else { 
                finalizeDiagramButton.textContent = '完成圖表'; 
                finalizeDiagramButton.classList.remove('edit-diagram'); 
                finalizeDiagramButton.classList.add('finalize-diagram'); 
            } 
            renderRcaDiagram(); 
            updateButtonStates(); 
        }
        function createNode(text, type, parentId, isNonChangeable = false) { 
            nodeIdCounter++; 
            const node = { 
                id: `node-${nodeIdCounter}`, 
                text: text, 
                type: type, 
                parentId: parentId, 
                children: [], 
                andSourceNodeIds: [], 
                effectParameters: [], 
                inventivePrinciples: [] 
            }; 
            if (type === 'cause') node.isNonChangeable = isNonChangeable; 
            return node; 
        }
        
        // --- Diagram Rendering ---
        function renderRcaDiagram() { 
            diagramContainer.innerHTML = ''; 
            if (rcaData) { 
                diagramContainer.appendChild(createNodeElement(rcaData)); 
            } 
            requestAnimationFrame(() => drawAllSvgConnectors()); 
        }
        function createNodeElement(nodeData) { 
            const nodeWrapper = document.createElement('div'); 
            nodeWrapper.classList.add('rca-node-wrapper'); 
            const nodeDiv = document.createElement('div'); 
            nodeDiv.classList.add('rca-node', `rca-node-${nodeData.type}`); 
            nodeDiv.id = nodeData.id; 
            nodeDiv.dataset.nodeId = nodeData.id; 
            const contentDiv = document.createElement('div'); 
            contentDiv.classList.add('rca-node-content'); 
            const headerDiv = document.createElement('div'); 
            headerDiv.classList.add('rca-node-header'); 
            const iconSpan = document.createElement('span'); 
            iconSpan.classList.add('rca-node-icon'); 
            const textSpan = document.createElement('span'); 
            textSpan.classList.add('rca-node-text'); 
            textSpan.textContent = nodeData.text; 
            headerDiv.appendChild(textSpan); 
            if (nodeData.type === 'cause' && nodeData.isNonChangeable) { 
                const ncBadge = document.createElement('span'); 
                ncBadge.classList.add('nc-badge'); 
                ncBadge.textContent = 'NC'; 
                headerDiv.appendChild(ncBadge); 
            } 
            contentDiv.appendChild(headerDiv); 
            nodeDiv.appendChild(iconSpan); 
            if (nodeData.effectParameters && nodeData.effectParameters.length > 0) { 
                const paramsDiv = document.createElement('div'); 
                paramsDiv.classList.add('selected-items-list'); 
                paramsDiv.innerHTML = `<strong>效果參數:</strong> <ul>${nodeData.effectParameters.map(p => `<li>${p}</li>`).join('')}</ul>`; 
                contentDiv.appendChild(paramsDiv); 
            } 
            if (nodeData.inventivePrinciples && nodeData.inventivePrinciples.length > 0) { 
                const principlesDiv = document.createElement('div'); 
                principlesDiv.classList.add('selected-items-list'); 
                let principlesHtml = '<strong>發明原理:</strong> <ul>'; 
                nodeData.inventivePrinciples.forEach(ip => { 
                    principlesHtml += `<li>${ip.name}${ip.solution ? `<span class="solution-text">- ${ip.solution.substring(0, 20)}${ip.solution.length > 20 ? '...' : ''}</span>` : ''}</li>`; 
                }); 
                principlesHtml += '</ul>'; 
                principlesDiv.innerHTML = principlesHtml; 
                contentDiv.appendChild(principlesDiv); 
            } 
            iconSpan.style.display = 'flex'; 
            let isContradictory = false;
            if (nodeData.type === 'initial-problem') iconSpan.textContent = '(-)'; 
            else if (nodeData.type === 'cause') { 
                const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(nodeData); 
                if (hasPositiveChild && hasNegativeChild) { 
                    iconSpan.textContent = '+/-'; 
                    iconSpan.classList.add('contradictory'); 
                    isContradictory = true;
                } else { iconSpan.style.display = 'none'; } 
            } else if (nodeData.type === 'positive-effect') iconSpan.textContent = '(+)'; 
            else if (nodeData.type === 'negative-effect') iconSpan.textContent = '(-)'; 
            else { iconSpan.style.display = 'none'; } 
            
            if (!isFinalizedView) { 
                const actionsDiv = document.createElement('div'); 
                actionsDiv.classList.add('rca-node-actions'); 
                actionsDiv.appendChild(createActionButton('修訂此項', 'edit-node', () => promptEditNode(nodeData.id, contentDiv))); 
                if (nodeData.type === 'initial-problem') { 
                    actionsDiv.appendChild(createActionButton('新增原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入原因描述'))); 
                } else if (nodeData.type === 'cause') { 
                    actionsDiv.appendChild(createActionButton('新增子原因', 'add-cause', () => promptAddNode(nodeData.id, contentDiv, 'cause', '輸入子原因描述'))); 
                    actionsDiv.appendChild(createActionButton('(+) 正面效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入此原因帶來的正面效果'))); 
                    actionsDiv.appendChild(createActionButton('(-) 負面效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入此原因導致的負面效果'))); 
                    const ncButtonText = nodeData.isNonChangeable ? '取消NC標記' : '設為NC'; 
                    actionsDiv.appendChild(createActionButton(ncButtonText, 'toggle-nc', () => toggleNonChangeable(nodeData.id))); 
                    actionsDiv.appendChild(createActionButton('選擇發明原理', 'set-principles', () => openInventivePrincipleModal(nodeData.id, isContradictory))); 
                    // The AI Suggest button was here, moved to openInventivePrincipleModal to show it conditionally
                    if (nodeData.parentId) { 
                        actionsDiv.appendChild(createActionButton('移除此原因', 'remove-button', () => removeNode(nodeData.id))); 
                    } 
                } else if (nodeData.type === 'positive-effect' || nodeData.type === 'negative-effect') { 
                    actionsDiv.appendChild(createActionButton('(+) 新增正面子效果', 'add-positive', () => promptAddNode(nodeData.id, contentDiv, 'positive-effect', '輸入正面子效果描述'))); 
                    actionsDiv.appendChild(createActionButton('(-) 新增負面子效果', 'add-negative', () => promptAddNode(nodeData.id, contentDiv, 'negative-effect', '輸入負面子效果描述'))); 
                    actionsDiv.appendChild(createActionButton('設定效果參數', 'set-parameters', () => openEffectParameterModal(nodeData.id))); 
                    actionsDiv.appendChild(createActionButton('設定AND輸入源', 'set-and-sources', () => openAndSourceModal(nodeData.id))); 
                    actionsDiv.appendChild(createActionButton('移除效果', 'remove-button', () => removeNode(nodeData.id))); 
                } 
                contentDiv.appendChild(actionsDiv); 
                const inputContainer = document.createElement('div'); 
                inputContainer.classList.add('input-group-container'); 
                contentDiv.appendChild(inputContainer); 
            } 
            nodeDiv.appendChild(contentDiv); 
            nodeWrapper.appendChild(nodeDiv); 
            if (nodeData.children && nodeData.children.length > 0) { 
                const childrenContainer = document.createElement('div'); 
                childrenContainer.classList.add('rca-children-container'); 
                nodeData.children.forEach(childNode => childrenContainer.appendChild(createNodeElement(childNode))); 
                nodeWrapper.appendChild(childrenContainer); 
            } 
            return nodeWrapper; 
        }
        
        // --- Node Editing and Modal Interactions ---
        function promptEditNode(nodeId, parentNodeContentDiv) { 
            if (isFinalizedView) return; 
            const nodeToEdit = findNodeById(rcaData, nodeId); 
            if (!nodeToEdit) return; 
            const inputContainer = parentNodeContentDiv.querySelector('.input-group-container'); 
            if (!inputContainer) { console.error("找不到節點的輸入容器:", nodeId); return; } 
            document.querySelectorAll('.input-group').forEach(ig => ig.remove()); 
            inputContainer.innerHTML = ''; 
            const inputGroup = document.createElement('div'); 
            inputGroup.classList.add('input-group'); 
            const nodeInput = document.createElement('input'); 
            nodeInput.type = 'text'; 
            nodeInput.value = nodeToEdit.text; 
            nodeInput.classList.add('input-field'); 
            const saveEditButton = document.createElement('button'); 
            saveEditButton.textContent = '儲存修訂'; 
            saveEditButton.classList.add('action-button', 'save-edit-button', 'w-full', 'mt-2'); 
            saveEditButton.onclick = () => { 
                const newText = nodeInput.value.trim(); 
                if (newText) { 
                    nodeToEdit.text = newText; 
                    pushStateToHistory(rcaData); 
                    renderRcaDiagram(); 
                    renderCauseEffectTable(); 
                    renderSolutionTable(); 
                    inputContainer.innerHTML = ''; 
                } else { alert('描述不能為空！'); } 
            }; 
            nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveEditButton.click(); }); 
            const cancelEditButton = document.createElement('button'); 
            cancelEditButton.textContent = '取消修訂'; 
            cancelEditButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1'); 
            cancelEditButton.onclick = () => { inputContainer.innerHTML = ''; }; 
            inputGroup.appendChild(nodeInput); 
            inputGroup.appendChild(saveEditButton); 
            inputGroup.appendChild(cancelEditButton); 
            inputContainer.appendChild(inputGroup); 
            nodeInput.focus(); 
            nodeInput.select(); 
        }
        function openAndSourceModal(targetNodeId) { 
            if (isFinalizedView) return; 
            currentAndTargetNodeId = targetNodeId; 
            const targetNode = findNodeById(rcaData, targetNodeId); 
            if (!targetNode) return; 
            andSourceModalTitle.textContent = `為效果 "${targetNode.text}" 設定 AND 輸入源`; 
            andSourceOptionsContainer.innerHTML = ''; 
            const availableCauses = []; 
            function findCausesRecursive(node) { 
                if (!node) return; 
                if (node.type === 'cause') availableCauses.push(node); 
                if (node.children) node.children.forEach(findCausesRecursive); 
            } 
            if (rcaData) findCausesRecursive(rcaData); 
            if (availableCauses.length === 0) { 
                andSourceOptionsContainer.innerHTML = '<p class="text-gray-500 text-center">圖表中尚無可用的原因節點。</p>'; 
            } else { 
                availableCauses.forEach(causeNode => { 
                    if (causeNode.id === targetNode.id || isDescendant(targetNode, causeNode.id) || causeNode.id === targetNode.parentId) return; 
                    const div = document.createElement('div'); 
                    div.classList.add('flex', 'items-center', 'my-2', 'p-2', 'hover:bg-gray-100', 'rounded'); 
                    const checkbox = document.createElement('input'); 
                    checkbox.type = 'checkbox'; 
                    checkbox.id = `and-source-chk-${causeNode.id}`; 
                    checkbox.value = causeNode.id; 
                    checkbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600', 'rounded', 'border-gray-300'); 
                    if (targetNode.andSourceNodeIds && targetNode.andSourceNodeIds.includes(causeNode.id)) { 
                        checkbox.checked = true; 
                    } 
                    const label = document.createElement('label'); 
                    label.htmlFor = `and-source-chk-${causeNode.id}`; 
                    label.textContent = `${causeNode.text} (ID: ${causeNode.id.split('-')[1]})`; 
                    label.classList.add('ml-3', 'text-sm', 'text-gray-700', 'flex-grow'); 
                    div.appendChild(checkbox); 
                    div.appendChild(label); 
                    andSourceOptionsContainer.appendChild(div); 
                }); 
                if (andSourceOptionsContainer.childElementCount === 0) { 
                    andSourceOptionsContainer.innerHTML = '<p class="text-gray-500 text-center">無有效的 AND 輸入源選項。</p>'; 
                } 
            } 
            andSourceModal.style.display = 'flex'; 
        }
        function isDescendant(parentNode, childNodeIdToFind) { 
            if (!parentNode || !parentNode.children || parentNode.children.length === 0) return false; 
            for (const child of parentNode.children) { 
                if (child.id === childNodeIdToFind) return true; 
                if (isDescendant(child, childNodeIdToFind)) return true; 
            } 
            return false; 
        }
        function handleSaveAndSources() { 
            if (!currentAndTargetNodeId) return; 
            const targetNode = findNodeById(rcaData, currentAndTargetNodeId); 
            if (!targetNode) return; 
            const selectedSourceIds = []; 
            const checkboxes = andSourceOptionsContainer.querySelectorAll('input[type="checkbox"]:checked'); 
            checkboxes.forEach(chk => selectedSourceIds.push(chk.value)); 
            targetNode.andSourceNodeIds = selectedSourceIds; 
            pushStateToHistory(rcaData); 
            andSourceModal.style.display = 'none'; 
            currentAndTargetNodeId = null; 
            renderRcaDiagram(); 
        }
        function openEffectParameterModal(targetNodeId) { 
            if (isFinalizedView) return; 
            currentParameterTargetNodeId = targetNodeId; 
            const targetNode = findNodeById(rcaData, targetNodeId); 
            if (!targetNode || (targetNode.type !== 'positive-effect' && targetNode.type !== 'negative-effect')) return; 
            effectParameterModalTitle.textContent = `為效果 "${targetNode.text}" 設定效果參數`; 
            effectParameterOptionsContainer.innerHTML = ''; 
            Object.keys(EFFECT_PARAMETERS).forEach(category => { 
                const categoryTitle = document.createElement('h4'); 
                categoryTitle.textContent = category; 
                effectParameterOptionsContainer.appendChild(categoryTitle); 
                EFFECT_PARAMETERS[category].forEach(param => { 
                    const div = document.createElement('div'); 
                    div.classList.add('flex', 'items-center', 'my-1', 'p-1', 'hover:bg-gray-50', 'rounded'); 
                    const checkbox = document.createElement('input'); 
                    checkbox.type = 'checkbox'; 
                    checkbox.id = `param-chk-${param.replace(/\s|\/|[\(\)]/g, '-')}`; 
                    checkbox.value = param; 
                    checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-sky-600', 'rounded', 'border-gray-300', 'focus:ring-sky-500'); 
                    if (targetNode.effectParameters && targetNode.effectParameters.includes(param)) { 
                        checkbox.checked = true; 
                    } 
                    const label = document.createElement('label'); 
                    label.htmlFor = checkbox.id; 
                    label.textContent = param; 
                    label.classList.add('ml-2', 'text-sm', 'text-gray-700'); 
                    div.appendChild(checkbox); 
                    div.appendChild(label); 
                    effectParameterOptionsContainer.appendChild(div); 
                }); 
            }); 
            effectParameterModal.style.display = 'flex'; 
        }
        function handleSaveEffectParameters() { 
            if (!currentParameterTargetNodeId) return; 
            const targetNode = findNodeById(rcaData, currentParameterTargetNodeId); 
            if (!targetNode) return; 
            const selectedParameters = []; 
            const checkboxes = effectParameterOptionsContainer.querySelectorAll('input[type="checkbox"]:checked'); 
            checkboxes.forEach(chk => selectedParameters.push(chk.value)); 
            targetNode.effectParameters = selectedParameters; 
            pushStateToHistory(rcaData); 
            effectParameterModal.style.display = 'none'; 
            currentParameterTargetNodeId = null; 
            renderRcaDiagram(); 
        }
        function openInventivePrincipleModal(targetNodeId, isContradictoryCause) { 
            if (isFinalizedView) return; 
            currentPrincipleTargetNodeId = targetNodeId; 
            const targetNode = findNodeById(rcaData, targetNodeId); 
            if (!targetNode || targetNode.type !== 'cause') return; 
            
            inventivePrincipleModalTitle.textContent = `為原因 "${targetNode.text}" 選擇發明原理與改善方案`; 
            inventivePrincipleOptionsContainer.innerHTML = ''; 
            INVENTIVE_PRINCIPLES.forEach(principleName => { 
                const principleContainer = document.createElement('div'); 
                principleContainer.classList.add('my-2', 'p-2', 'border-b', 'border-gray-200'); 
                const div = document.createElement('div'); 
                div.classList.add('flex', 'items-center'); 
                const checkbox = document.createElement('input'); 
                checkbox.type = 'checkbox'; 
                const checkboxId = `principle-chk-${principleName.replace(/\s|\/|[\(\)\[\]]/g, '-')}`; 
                checkbox.id = checkboxId; 
                checkbox.value = principleName; 
                checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-pink-600', 'rounded', 'border-gray-300', 'focus:ring-pink-500'); 
                const existingPrinciple = targetNode.inventivePrinciples.find(p => p.name === principleName); 
                if (existingPrinciple) { 
                    checkbox.checked = true; 
                } 
                const label = document.createElement('label'); 
                label.htmlFor = checkboxId; 
                label.textContent = principleName; 
                label.classList.add('ml-2', 'text-sm', 'text-gray-700', 'font-medium'); 
                div.appendChild(checkbox); 
                div.appendChild(label); 
                principleContainer.appendChild(div); 
                const solutionInput = document.createElement('input'); 
                solutionInput.type = 'text'; 
                solutionInput.placeholder = '輸入此原理的改善方案...'; 
                solutionInput.dataset.principleName = principleName; 
                solutionInput.classList.add('principle-solution-input', 'input-field', 'mt-1'); 
                solutionInput.value = existingPrinciple && existingPrinciple.solution ? existingPrinciple.solution : ''; 
                solutionInput.style.display = checkbox.checked ? 'block' : 'none'; 
                checkbox.onchange = () => { 
                    solutionInput.style.display = checkbox.checked ? 'block' : 'none'; 
                    if (!checkbox.checked) solutionInput.value = ''; 
                }; 
                principleContainer.appendChild(solutionInput); 
                inventivePrincipleOptionsContainer.appendChild(principleContainer); 
            }); 

            // Show or hide AI suggestions section based on whether it's a contradictory cause
            if (isContradictoryCause) {
                aiSuggestionsSection.style.display = 'block';
            } else {
                aiSuggestionsSection.style.display = 'none';
            }
            clearAiSuggestions(); // Clear previous suggestions
            inventivePrincipleModal.style.display = 'flex'; 
        }

        function handleSaveInventivePrinciples() { 
            if (!currentPrincipleTargetNodeId) return; 
            const targetNode = findNodeById(rcaData, currentPrincipleTargetNodeId); 
            if (!targetNode) return; 
            const selectedPrinciples = []; 
            const principleCheckboxes = inventivePrincipleOptionsContainer.querySelectorAll('input[type="checkbox"]');
            principleCheckboxes.forEach(chk => {
                if (chk.checked) {
                    const principleName = chk.value;
                    const solutionInput = chk.closest('.my-2').querySelector('input[type="text"][data-principle-name]');
                    selectedPrinciples.push({ 
                        name: principleName, 
                        solution: solutionInput ? solutionInput.value.trim() : '' 
                    });
                }
            });
            targetNode.inventivePrinciples = selectedPrinciples; 
            pushStateToHistory(rcaData); 
            inventivePrincipleModal.style.display = 'none'; 
            currentPrincipleTargetNodeId = null; 
            renderRcaDiagram(); 
            renderSolutionTable(); 
            clearAiSuggestions();
        }

        function clearAiSuggestions() {
            aiSuggestionsList.innerHTML = '';
            aiSuggestionsOutput.style.display = 'block'; // Ensure it's visible for new content
            aiSuggestionsLoading.style.display = 'none';
        }

        async function handleGetAiSuggestions() {
            if (!currentPrincipleTargetNodeId) return;
            const targetNode = findNodeById(rcaData, currentPrincipleTargetNodeId);
            if (!targetNode || targetNode.type !== 'cause') {
                alert("AI 建議僅適用於原因節點。");
                return;
            }

            const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(targetNode);
            if (!hasPositiveChild || !hasNegativeChild) {
                alert("AI 建議僅適用於具有正面和負面效果的矛盾原因。");
                return;
            }

            aiSuggestionsLoading.style.display = 'block';
            aiSuggestionsList.innerHTML = ''; // Clear previous suggestions
            getAiSuggestionsButton.disabled = true;

            const positiveEffects = targetNode.children.filter(c => c.type === 'positive-effect').map(c => c.text);
            const negativeEffects = targetNode.children.filter(c => c.type === 'negative-effect').map(c => c.text);
            
            let prompt = `這是一個根本原因分析中的矛盾點。\n`;
            prompt += `主要原因：${targetNode.text}\n`;
            prompt += `該原因導致的正面效果：\n${positiveEffects.map(e => `- ${e}`).join('\n')}\n`;
            prompt += `該原因導致的負面效果：\n${negativeEffects.map(e => `- ${e}`).join('\n')}\n`;

            const selectedPrincipleNames = Array.from(inventivePrincipleOptionsContainer.querySelectorAll('input[type="checkbox"]:checked'))
                                             .map(chk => chk.value);
            if (selectedPrincipleNames.length > 0) {
                prompt += `請參考以下已選擇的發明原理：${selectedPrincipleNames.join(', ')}\n`;
            }
            prompt += `請針對此矛盾情況，提出3-5個具體的、可操作的改善方案建議。請以條列式清單方式呈現建議，每個建議包含簡短描述。`;

            try {
                showLoadingSpinner(); // Show full page spinner
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // API key will be injected by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API 請求失敗: ${response.status} ${response.statusText}. ${errorData?.error?.message || ''}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    // Process and display suggestions
                    const suggestions = text.split('\n').map(s => s.trim()).filter(s => s.length > 0 && (s.startsWith('- ') || s.match(/^\d+\.\s/)));
                    if (suggestions.length > 0) {
                        suggestions.forEach(suggestionText => {
                            const li = document.createElement('li');
                            li.textContent = suggestionText.replace(/^(- |\d+\.\s)/, ''); // Remove list prefix
                            li.onclick = () => {
                                // Find the first empty solution input and fill it
                                const firstEmptySolutionInput = Array.from(inventivePrincipleOptionsContainer.querySelectorAll('.principle-solution-input'))
                                    .find(input => input.style.display !== 'none' && input.value.trim() === '');
                                if (firstEmptySolutionInput) {
                                    firstEmptySolutionInput.value = li.textContent;
                                    // Optionally, check the corresponding principle checkbox if not already checked
                                    const principleName = firstEmptySolutionInput.dataset.principleName;
                                    const principleCheckbox = inventivePrincipleOptionsContainer.querySelector(`input[type="checkbox"][value="${principleName}"]`);
                                    if (principleCheckbox && !principleCheckbox.checked) {
                                        principleCheckbox.checked = true;
                                        firstEmptySolutionInput.style.display = 'block';
                                    }
                                } else {
                                    alert("沒有可用的改善方案輸入框來填入此建議，或者所有已選原理的方案都已填寫。");
                                }
                            };
                            aiSuggestionsList.appendChild(li);
                        });
                    } else {
                        aiSuggestionsList.innerHTML = '<li>AI 未能提供有效的建議格式。</li>';
                    }
                } else {
                    aiSuggestionsList.innerHTML = '<li>AI 未返回任何建議。</li>';
                    console.error("AI response structure unexpected:", result);
                }
            } catch (error) {
                console.error('調用 Gemini API 時發生錯誤:', error);
                aiSuggestionsList.innerHTML = `<li>獲取 AI 建議時出錯：${error.message}</li>`;
            } finally {
                aiSuggestionsLoading.style.display = 'none';
                getAiSuggestionsButton.disabled = false;
                hideLoadingSpinner(); // Hide full page spinner
            }
        }
        
        // --- SVG Connector Drawing Logic ---
        function drawAllSvgConnectors(
            targetSvgLayer = svgLayer, 
            targetDiagramContainer = diagramContainer, 
            targetScalableWrapper = scalableContentWrapper, 
            zoom = currentZoom
        ) { 
            targetSvgLayer.innerHTML = ''; 
            if (!rcaData || !targetDiagramContainer.querySelector(`#${rcaData.id}`) || !targetScalableWrapper) { 
                targetSvgLayer.setAttribute('width', 0); 
                targetSvgLayer.setAttribute('height', 0); 
                return; 
            } 
            
            const wrapperStyle = getComputedStyle(targetScalableWrapper);
            const wrapperPaddingLeft = parseFloat(wrapperStyle.paddingLeft) || 0;
            const wrapperPaddingTop = parseFloat(wrapperStyle.paddingTop) || 0;

            const unscaledDiagramWidth = targetDiagramContainer.scrollWidth; 
            const unscaledDiagramHeight = targetDiagramContainer.scrollHeight; 
            targetSvgLayer.setAttribute('width', unscaledDiagramWidth); 
            targetSvgLayer.setAttribute('height', unscaledDiagramHeight); 
            targetSvgLayer.setAttribute('viewBox', `0 0 ${unscaledDiagramWidth} ${unscaledDiagramHeight}`); 
            
            const lineVerticalOffset = 25; 
            const scalableWrapperRect = targetScalableWrapper.getBoundingClientRect(); 

            function drawRecursive(parentNodeData, currentContainer) { 
                const parentElement = currentContainer.querySelector(`#${parentNodeData.id}`); 
                if (!parentElement) return; 
                
                const parentRect = parentElement.getBoundingClientRect(); 
                const parentBottomCenterX_svg = (parentRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + parentRect.width / 2) / zoom; 
                const parentBottomY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + parentRect.height) / zoom; 
                const parentTopY_svg = (parentRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                const parentCenterX_svg = parentBottomCenterX_svg; 

                if (parentNodeData.andSourceNodeIds && parentNodeData.andSourceNodeIds.length > 0) { 
                    const mergePointYOffset = 40; 
                    const mergePoint_svg = { x: parentCenterX_svg, y: parentTopY_svg - mergePointYOffset }; 
                    if(mergePoint_svg.y < 0) mergePoint_svg.y = 10; 
                    _drawSvgCircle(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, 6, '#6d28d9', zoom); 
                    parentNodeData.andSourceNodeIds.forEach(sourceId => { 
                        const sourceElement = currentContainer.querySelector(`#${sourceId}`); 
                        if (sourceElement) { 
                            const sourceRect = sourceElement.getBoundingClientRect(); 
                            const sourceConnX_svg = (sourceRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + sourceRect.width / 2) / zoom; 
                            const sourceConnY_svg = (sourceRect.top - (scalableWrapperRect.top + wrapperPaddingTop) + sourceRect.height) / zoom; 
                            if (sourceConnY_svg < mergePoint_svg.y) { 
                                _drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceConnY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom); 
                            } else { 
                                const sourceTopY_svg = (sourceRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                                _drawSvgLine(targetSvgLayer, sourceConnX_svg, sourceTopY_svg, mergePoint_svg.x, mergePoint_svg.y, '#6b7280', 2, zoom); 
                            } 
                        } 
                    }); 
                    if (parentTopY_svg > mergePoint_svg.y) { 
                        _drawSvgLine(targetSvgLayer, mergePoint_svg.x, mergePoint_svg.y, parentCenterX_svg, parentTopY_svg, '#6b7280', 2, zoom); 
                    } 
                } 
                const standardChildren = parentNodeData.children.filter(c => !(c.andSourceNodeIds && c.andSourceNodeIds.length > 0 && c.andSourceNodeIds.includes(parentNodeData.id))); 
                if (standardChildren.length > 0) { 
                    const horizontalLineY_svg = parentBottomY_svg + lineVerticalOffset; 
                    _drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, parentBottomY_svg, parentBottomCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                    if (standardChildren.length > 1) { 
                        const firstChildElement = currentContainer.querySelector(`#${standardChildren[0].id}`); 
                        const lastChildElement = currentContainer.querySelector(`#${standardChildren[standardChildren.length - 1].id}`); 
                        if (firstChildElement && lastChildElement) { 
                            const firstChildRect = firstChildElement.getBoundingClientRect(); 
                            const lastChildRect = lastChildElement.getBoundingClientRect(); 
                            const hLineStartX_svg = (firstChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + firstChildRect.width / 2) / zoom; 
                            const hLineEndX_svg = (lastChildRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + lastChildRect.width / 2) / zoom; 
                            if (Math.abs(hLineStartX_svg - hLineEndX_svg) > 1) { 
                                _drawSvgLine(targetSvgLayer, hLineStartX_svg, horizontalLineY_svg, hLineEndX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                            } 
                        } 
                    } else if (standardChildren.length === 1) { 
                        const childElement = currentContainer.querySelector(`#${standardChildren[0].id}`); 
                        if (childElement) { 
                            const childRect = childElement.getBoundingClientRect(); 
                            const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom; 
                            if (Math.abs(parentBottomCenterX_svg - childCenterX_svg) > 1) { 
                                _drawSvgLine(targetSvgLayer, parentBottomCenterX_svg, horizontalLineY_svg, childCenterX_svg, horizontalLineY_svg, '#9ca3af', 2, zoom); 
                            } 
                        } 
                    } 
                    standardChildren.forEach(childNode => { 
                        const childElement = currentContainer.querySelector(`#${childNode.id}`); 
                        if (childElement) { 
                            const childRect = childElement.getBoundingClientRect(); 
                            const childCenterX_svg = (childRect.left - (scalableWrapperRect.left + wrapperPaddingLeft) + childRect.width / 2) / zoom; 
                            const childTopY_svg = (childRect.top - (scalableWrapperRect.top + wrapperPaddingTop)) / zoom; 
                            if (childTopY_svg > horizontalLineY_svg) { 
                                _drawSvgLine(targetSvgLayer, childCenterX_svg, horizontalLineY_svg, childCenterX_svg, childTopY_svg, '#9ca3af', 2, zoom); 
                            } 
                        } 
                    }); 
                } 
                if (parentNodeData.children) { 
                    parentNodeData.children.forEach(childNode => drawRecursive(childNode, currentContainer)); 
                } 
            } 
            if(rcaData) drawRecursive(rcaData, targetDiagramContainer); 
        }
        function _drawSvgLine(svg, x1, y1, x2, y2, color = 'black', strokeWidth = 2, zoomFactor = 1) { 
            if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) { return; } 
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line'); 
            line.setAttribute('x1', x1); line.setAttribute('y1', y1); 
            line.setAttribute('x2', x2); line.setAttribute('y2', y2); 
            line.setAttribute('stroke', color); 
            line.setAttribute('stroke-width', strokeWidth / zoomFactor); 
            svg.appendChild(line); 
        }
        function _drawSvgCircle(svg, cx, cy, r, fillColor = 'black', zoomFactor = 1) { 
            if (isNaN(cx) || isNaN(cy) || isNaN(r)) { return; } 
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle'); 
            circle.setAttribute('cx', cx); circle.setAttribute('cy', cy); 
            circle.setAttribute('r', r / zoomFactor); 
            circle.setAttribute('fill', fillColor); 
            svg.appendChild(circle); 
        }
        
        // --- Node Data Manipulation ---
        function checkChildrenEffects(nodeData) { 
            let hasPositiveChild = false; let hasNegativeChild = false; 
            if (nodeData.children) { 
                for (const child of nodeData.children) { 
                    if (child.type === 'positive-effect') hasPositiveChild = true; 
                    if (child.type === 'negative-effect') hasNegativeChild = true; 
                    if (hasPositiveChild && hasNegativeChild) break; 
                } 
            } 
            return { hasPositiveChild, hasNegativeChild }; 
        }
        function toggleNonChangeable(nodeId) { 
            if (isFinalizedView) return; 
            const node = findNodeById(rcaData, nodeId); 
            if (node && node.type === 'cause') { 
                node.isNonChangeable = !node.isNonChangeable; 
                pushStateToHistory(rcaData); 
                renderRcaDiagram(); 
                renderCauseEffectTable(); 
            } 
        }
        function createActionButton(text, className, onClickHandler) { 
            const button = document.createElement('button'); 
            button.classList.add('action-button', ...className.split(' ')); 
            button.textContent = text; 
            button.addEventListener('click', onClickHandler); 
            return button; 
        }
        function promptAddNode(parentId, parentNodeContentDiv, nodeTypeToAdd, placeholderText) { 
            if (isFinalizedView) return; 
            const inputContainer = parentNodeContentDiv.querySelector('.input-group-container'); 
            if (!inputContainer) return; 
            inputContainer.innerHTML = ''; 
            document.querySelectorAll('.input-group').forEach(ig => ig.remove()); 
            const inputGroup = document.createElement('div'); 
            inputGroup.classList.add('input-group'); 
            const nodeInput = document.createElement('input'); 
            nodeInput.type = 'text'; 
            nodeInput.placeholder = placeholderText; 
            nodeInput.classList.add('input-field'); 
            const saveButton = document.createElement('button'); 
            saveButton.textContent = '儲存'; 
            saveButton.classList.add('action-button', 'save-button', 'w-full', 'mt-2'); 
            saveButton.onclick = () => { 
                const nodeText = nodeInput.value.trim(); 
                if (nodeText) { 
                    addNodeToData(parentId, nodeText, nodeTypeToAdd); 
                    inputContainer.innerHTML = ''; 
                } else { alert('描述不能為空！'); } 
            }; 
            nodeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') saveButton.click(); }); 
            const cancelButton = document.createElement('button'); 
            cancelButton.textContent = '取消'; 
            cancelButton.classList.add('action-button', 'bg-gray-400', 'hover:bg-gray-500', 'w-full', 'mt-1'); 
            cancelButton.onclick = () => { inputContainer.innerHTML = ''; }; 
            inputGroup.appendChild(nodeInput); 
            inputGroup.appendChild(saveButton); 
            inputGroup.appendChild(cancelButton); 
            inputContainer.appendChild(inputGroup); 
            nodeInput.focus(); 
        }
        function addNodeToData(parentId, nodeText, nodeType) { 
            const parentNode = findNodeById(rcaData, parentId); 
            if (parentNode) { 
                const newNode = createNode(nodeText, nodeType, parentId); 
                parentNode.children.push(newNode); 
                pushStateToHistory(rcaData); 
                renderRcaDiagram(); 
                renderCauseEffectTable(); 
                renderSolutionTable(); 
            } 
        }
        function removeNode(nodeIdToRemove) { 
            if (isFinalizedView) return; 
            if (rcaData && rcaData.id === nodeIdToRemove) { 
                alert('不能移除主要問題根源節點！'); 
                return; 
            } 
            let nodeRemoved = false; 
            function filterRecursive(node, idToRemove) { 
                if (!node) return null; 
                if (node.id === idToRemove) { 
                    nodeRemoved = true; 
                    function removeAndSourceFromEntireTree(currentNodeData, removedId) {
                        if (!currentNodeData) return;
                        if (currentNodeData.andSourceNodeIds && currentNodeData.andSourceNodeIds.includes(removedId)) {
                            currentNodeData.andSourceNodeIds = currentNodeData.andSourceNodeIds.filter(srcId => srcId !== removedId);
                        }
                        if (currentNodeData.children) {
                            currentNodeData.children.forEach(child => removeAndSourceFromEntireTree(child, removedId));
                        }
                    }
                    removeAndSourceFromEntireTree(rcaData, idToRemove);
                    return null; 
                } 
                if (node.children) { 
                    node.children = node.children.map(child => filterRecursive(child, idToRemove)).filter(child => child !== null); 
                } 
                return node; 
            } 
            rcaData = filterRecursive(rcaData, nodeIdToRemove); 
            if (nodeRemoved) { 
                pushStateToHistory(rcaData); 
            } 
            if (!rcaData) { 
                problemInputArea.style.display = 'flex'; 
                diagramTitle.style.display = 'none'; 
                toolButtonsContainer.style.display = 'flex'; 
                causeEffectTableSection.style.display = 'none'; 
                solutionTableSection.style.display = 'none'; 
                historyStack = []; 
                historyIndex = -1; 
                applyZoom(1.0); 
            } 
            renderRcaDiagram(); 
            renderCauseEffectTable(); 
            renderSolutionTable(); 
            updateButtonStates(); 
        }
        function findNodeById(node, id) { 
            if (!node) return null; 
            if (node.id === id) return node; 
            if (node.children) { 
                for (const child of node.children) { 
                    const found = findNodeById(child, id); 
                    if (found) return found; 
                } 
            } 
            return null; 
        }
        
        // --- Table Display and Rendering Logic ---
        function handleShowCauseEffectTable() {
            causeEffectTableSection.style.display = 'block';
            solutionTableSection.style.display = 'none'; 
            renderCauseEffectTable();
            updateButtonStates();
        }
        function handleShowSolutionTable() {
            solutionTableSection.style.display = 'block';
            causeEffectTableSection.style.display = 'none'; 
            renderSolutionTable();
            updateButtonStates();
        }
        function handleHideAllTables() {
            causeEffectTableSection.style.display = 'none';
            solutionTableSection.style.display = 'none';
            updateButtonStates();
        }

        function getCauseEffectTableData() { 
            const tableRowsData = []; 
            function collectDataRecursive(node) { 
                if (!node) return; 
                if (node.type === 'cause') { 
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node); 
                    let causeType = ''; 
                    if (node.isNonChangeable) causeType = 'NC'; 
                    else if (hasPositiveChild && hasNegativeChild) causeType = 'N+P (矛盾)'; 
                    else if (hasNegativeChild) causeType = 'N (純負面)'; 
                    else if (hasPositiveChild) causeType = 'P (純正面)'; 
                    else causeType = '未定義效果'; 
                    if (causeType !== 'P (純正面)' || (hasPositiveChild || hasNegativeChild)) { 
                        const positiveEffects = node.children.filter(c => c.type === 'positive-effect').map(c => c.text).join('; ') || '無'; 
                        const negativeEffects = node.children.filter(c => c.type === 'negative-effect').map(c => c.text).join('; ') || '無'; 
                        tableRowsData.push({ cause: node.text, type: causeType, positive: positiveEffects, negative: negativeEffects }); 
                    } 
                } 
                if (node.children) node.children.forEach(collectDataRecursive); 
            } 
            if (rcaData) collectDataRecursive(rcaData); 
            return tableRowsData; 
        }
        function renderCauseEffectTable() { 
            if (!rcaData) { 
                causeEffectTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; 
                return; 
            } 
            const tableData = getCauseEffectTableData(); 
            causeEffectTableBody.innerHTML = ''; 
            if (tableData.length === 0) { 
                causeEffectTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">目前圖表中沒有定義直接帶有正面或負面效果的原因 (且非純粹正面原因)。</td></tr>'; 
                return; 
            } 
            tableData.forEach(rowData => { 
                const row = causeEffectTableBody.insertRow(); 
                row.insertCell().textContent = rowData.cause; 
                row.insertCell().textContent = rowData.type; 
                row.insertCell().textContent = rowData.positive; 
                row.insertCell().textContent = rowData.negative; 
            }); 
        }
        
        function renderSolutionTable() { 
            if (!rcaData) { 
                solutionTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">請先設定主要負面效果並建立分析圖。</td></tr>'; 
                return; 
            } 
            const tableData = getSolutionTableData(); 
            solutionTableBody.innerHTML = ''; 
            if (tableData.length === 0) { 
                let message = '目前沒有矛盾原因已選擇發明原理並填寫改善方案。'; 
                let hasContradictoryCause = false; 
                function findContradictory(node) { 
                    if (!node) return; 
                    if (node.type === 'cause') { 
                        const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node); 
                        if (hasPositiveChild && hasNegativeChild) { 
                            hasContradictoryCause = true; 
                            return; 
                        } 
                    } 
                    if (node.children && !hasContradictoryCause) node.children.forEach(findContradictory); 
                } 
                if (rcaData) findContradictory(rcaData); 
                if (!hasContradictoryCause) { 
                    message = '提示：圖表中尚無「矛盾原因」(即同時直接導致正面及負面效果的原因)。請先建立矛盾原因。'; 
                } else { 
                    message = '提示：已找到矛盾原因，但尚未為其「選擇發明原理」並填寫「改善方案」。'; 
                } 
                solutionTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">${message}</td></tr>`; 
                return; 
            } 
            const groupedSolutions = {}; 
            tableData.forEach(item => { 
                if (!groupedSolutions[item.contradictoryCause]) { 
                    groupedSolutions[item.contradictoryCause] = []; 
                } 
                groupedSolutions[item.contradictoryCause].push({ principle: item.principle, solution: item.solution }); 
            }); 
            Object.keys(groupedSolutions).forEach(causeText => { 
                const solutionsForCause = groupedSolutions[causeText]; 
                solutionsForCause.forEach((solutionItem, index) => { 
                    const row = solutionTableBody.insertRow(); 
                    if (index === 0) { 
                        const causeCell = row.insertCell(); 
                        causeCell.textContent = causeText; 
                        causeCell.rowSpan = solutionsForCause.length; 
                    } 
                    row.insertCell().textContent = solutionItem.principle; 
                    row.insertCell().textContent = solutionItem.solution; 
                }); 
            }); 
        }
        function getSolutionTableData() { 
            const solutionData = []; 
            function collectSolutionsRecursive(node) { 
                if (!node) return; 
                if (node.type === 'cause') { 
                    const { hasPositiveChild, hasNegativeChild } = checkChildrenEffects(node); 
                    if (hasPositiveChild && hasNegativeChild && node.inventivePrinciples && node.inventivePrinciples.length > 0) { 
                        node.inventivePrinciples.forEach(ip => { 
                            if (ip.solution && ip.solution.trim() !== '') { 
                                solutionData.push({ contradictoryCause: node.text, principle: ip.name, solution: ip.solution }); 
                            } 
                        }); 
                    } 
                } 
                if (node.children) node.children.forEach(collectSolutionsRecursive); 
            } 
            if (rcaData) { 
                collectSolutionsRecursive(rcaData); 
            } 
            return solutionData; 
        }
        
        // --- Layout and Export ---
        function autoAdjustNodeLayout() { 
            if (!rcaData || isFinalizedView) {
                alert('請先建立圖表或結束「完成圖表」模式以調整節點位置。');
                return;
            }
            const nodeWrappers = Array.from(diagramContainer.querySelectorAll('.rca-node-wrapper'));
            const MIN_SPACING = 20; 
            for (let i = 0; i < nodeWrappers.length; i++) {
                const wrapper1 = nodeWrappers[i];
                const rect1 = wrapper1.getBoundingClientRect();
                for (let j = i + 1; j < nodeWrappers.length; j++) {
                    const wrapper2 = nodeWrappers[j];
                    if (wrapper1.parentNode !== wrapper2.parentNode || wrapper1.parentNode.classList.contains('rca-diagram-container')) {
                        continue; 
                    }
                    const rect2 = wrapper2.getBoundingClientRect();
                    const overlapX = Math.max(0, Math.min(rect1.right, rect2.right) - Math.max(rect1.left, rect2.left));
                    const verticalAlign = Math.abs(rect1.top - rect2.top) < rect1.height / 2; 
                    
                    if (verticalAlign && overlapX > -MIN_SPACING) { 
                        const adjustment = (overlapX > 0 ? overlapX : 0) + MIN_SPACING; 
                        let currentMarginLeft = parseFloat(getComputedStyle(wrapper2).marginLeft) || 0;
                        wrapper2.style.marginLeft = (currentMarginLeft + adjustment) + 'px';
                        wrapper2.getBoundingClientRect(); 
                    }
                }
            }
            requestAnimationFrame(() => drawAllSvgConnectors()); 
            alert('嘗試自動調整節點位置。您可能需要多次點擊或手動微調以獲得最佳效果。');
        }

        async function exportDiagramAsPNG() { 
            if (!rcaData || !scalableContentWrapper || !diagramContainer || diagramContainer.children.length === 0) {
                alert('圖表為空或找不到圖表元素！');
                return;
            }
            const activeInputGroups = diagramContainer.querySelectorAll('.input-group');
            activeInputGroups.forEach(group => group.style.display = 'none');
            closeAllDropdowns();

            const originalRenderAreaScrollX = diagramRenderArea.scrollLeft;
            const originalRenderAreaScrollY = diagramRenderArea.scrollTop;
            const originalZoom = currentZoom;

            diagramRenderArea.scrollLeft = 0;
            diagramRenderArea.scrollTop = 0;
            applyZoom(1.0, true); 

            await new Promise(resolve => requestAnimationFrame(() => {
                drawAllSvgConnectors(svgLayer, diagramContainer, scalableContentWrapper, 1.0);
                resolve();
            }));
            
            const exportContainer = document.createElement('div');
            exportContainer.id = 'export-temp-container';
            exportContainer.style.position = 'absolute';
            exportContainer.style.left = '-99999px'; 
            exportContainer.style.top = '-99999px';
            exportContainer.style.backgroundColor = '#ffffff'; 
            exportContainer.style.padding = '0'; 
            exportContainer.style.margin = '0';
            exportContainer.style.overflow = 'hidden'; 

            const contentWidth = scalableContentWrapper.scrollWidth;
            const contentHeight = scalableContentWrapper.scrollHeight;
            exportContainer.style.width = contentWidth + 'px';
            exportContainer.style.height = contentHeight + 'px';
            
            const clonedScalableContent = scalableContentWrapper.cloneNode(true);
            clonedScalableContent.style.transform = 'scale(1.0)'; 
            clonedScalableContent.style.margin = '0'; 
            clonedScalableContent.style.padding = getComputedStyle(scalableContentWrapper).padding; 
            clonedScalableContent.style.backgroundColor = '#ffffff'; 
            clonedScalableContent.style.cursor = 'default'; 

            const clonedActionDivs = clonedScalableContent.querySelectorAll('.rca-node-actions');
            if (isFinalizedView) { 
                clonedActionDivs.forEach(div => div.style.display = 'none');
            }
            const clonedInputContainers = clonedScalableContent.querySelectorAll('.input-group-container');
            clonedInputContainers.forEach(div => div.style.display = 'none'); 
            
            const clonedNodes = clonedScalableContent.querySelectorAll('.rca-node');
            clonedNodes.forEach(node => node.style.boxShadow = 'none'); 

            exportContainer.appendChild(clonedScalableContent);
            document.body.appendChild(exportContainer);

            const clonedDiagramContainer = clonedScalableContent.querySelector('#rca-diagram-container');
            const clonedSvgLayer = clonedScalableContent.querySelector('#svg-connector-layer');
            
            if (clonedDiagramContainer && clonedSvgLayer) {
                 await new Promise(resolve => requestAnimationFrame(() => {
                    drawAllSvgConnectors(clonedSvgLayer, clonedDiagramContainer, clonedScalableContent, 1.0);
                    resolve();
                }));
            }
            await new Promise(resolve => setTimeout(resolve, 300)); 

            try {
                const canvas = await html2canvas(exportContainer, { 
                    scale: 1.5, 
                    useCORS: true,
                    backgroundColor: '#ffffff', 
                    logging: false, 
                    width: contentWidth, 
                    height: contentHeight, 
                    x: 0, y: 0, 
                    scrollX: 0, scrollY: 0, 
                    windowWidth: contentWidth, windowHeight: contentHeight, 
                });
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'rca-plus-diagram.png';
                link.href = image;
                link.click();
            } catch (err) {
                console.error('匯出圖表失敗:', err);
                alert('匯出圖表失敗，請檢查控制台錯誤訊息。');
            } finally {
                document.body.removeChild(exportContainer); 
                activeInputGroups.forEach(group => group.style.display = 'flex'); 
                applyZoom(originalZoom, true); 
                diagramRenderArea.scrollLeft = originalRenderAreaScrollX; 
                diagramRenderArea.scrollTop = originalRenderAreaScrollY;
                requestAnimationFrame(() => drawAllSvgConnectors()); 
            }
        }
        
        // --- Initialize the Application ---
        initialize();
    </script>
</body>
</html>
